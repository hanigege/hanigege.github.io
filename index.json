[{"categories":["freebsd"],"contents":"\n脚本只能是root用户运行～ 一键执行命令（FreeBSD） curl -fsSL https://raw.githubusercontent.com/hanigege/scripts/main/freebsd_ssh_key_manage.sh \\ -o freebsd_ssh_key_manage.sh \\ \u0026amp;\u0026amp; chmod +x freebsd_ssh_key_manage.sh \\ \u0026amp;\u0026amp; sh freebsd_ssh_key_manage.sh ","permalink":"https://hanigege.github.io/posts/freebsd/freebsd%E4%B8%93%E7%94%A8%E7%89%88%E6%8B%89%E5%8F%96github%E5%85%AC%E9%92%A5%E5%81%9A%E4%B8%BA%E8%87%AA%E5%B7%B1%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E5%85%AC%E9%92%A5%E7%9A%84%E8%84%9A%E6%9C%AC/","tags":null,"title":"Freebsd专用版拉取github公钥做为自己服务器的公钥的脚本"},{"categories":["linux"],"contents":"适用于ubuntu\u0026amp;debian\u0026amp;alpine,请对应安装 说明： 极大简化了服务器安装ssh密钥的工作，一键导入，导入后，脚本会自动修改sshd_config的配置参数，省心省力，当然也可以直接生成新证书使用。\nUbuntu\u0026amp;Debian 脚本 curl -fsSL https://raw.githubusercontent.com/hanigege/scripts/main/ubuntu_ssh_key_manage.sh -o ubuntu_ssh_key_manage.sh \u0026amp;\u0026amp; chmod +x ubuntu_ssh_key_manage.sh \u0026amp;\u0026amp; bash ubuntu_ssh_key_manage.sh Alpine root 用户脚本 curl -fsSL https://raw.githubusercontent.com/hanigege/scripts/main/alpine_root_ssh_key_manage.sh -o alpine_root_ssh_key_manage.sh \u0026amp;\u0026amp; chmod +x alpine_root_ssh_key_manage.sh \u0026amp;\u0026amp; sh alpine_root_ssh_key_manage.sh Alpine 普通用户脚本 curl -fsSL https://raw.githubusercontent.com/hanigege/scripts/main/alpine_user_ssh_key_manage.sh -o alpine_user_ssh_key_manage.sh \u0026amp;\u0026amp; chmod +x alpine_user_ssh_key_manage.sh \u0026amp;\u0026amp; sh alpine_user_ssh_key_manage.sh ","permalink":"https://hanigege.github.io/posts/linux/%E6%8B%89%E5%8F%96github%E5%85%AC%E9%92%A5%E5%81%9A%E4%B8%BA%E8%87%AA%E5%B7%B1%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E5%85%AC%E9%92%A5%E7%9A%84%E8%84%9A%E6%9C%AC/","tags":null,"title":"拉取github公钥做为自己服务器的公钥的脚本"},{"categories":["freebsd"],"contents":"第一步：安装系统依赖与源码编译 Neovim 0.10+ FreeBSD 使用 pkg 管理二进制包，编译 Neovim 需要额外的 gmake。\n# 1. 安装编译所需的工具和依赖 # 注意：FreeBSD 下编译 Neovim 建议使用 gmake # 强制同步并更新所有软件包，这是解决 ld-elf.so.1 错误最直接的方法，确保所有依赖库版本一致。 pkg update -f pkg upgrade -y pkg install -y ninja cmake gettext-tools gmake unzip curl git gcc # 2. 拉取 Neovim 源码 git clone https://github.com/neovim/neovim.git ~/neovim-src cd ~/neovim-src git checkout stable # 3. 编译并全局安装 # FreeBSD 环境下必须明确使用 gmake gmake CMAKE_BUILD_TYPE=Release -j$(sysctl -n hw.ncpu) sudo gmake install # 4. 验证版本 hash -r nvim -v 第二步：安装格式化所需的环境依赖 FreeBSD 的 Node.js 包名通常带有版本号，我们选择主流的 LTS 版本。\n# 安装 Node.js 和 npm pkg install -y node20 npm-node20 # 全局安装 Prettier npm install -g prettier 第三步：部署完整的 Lua 配置 由于 FreeBSD 的用户目录结构与 Linux 一致，~/.config/nvim 路径保持不变。\n# 1. 清理旧环境 rm -rf ~/.config/nvim ~/.local/share/nvim ~/.local/state/nvim ~/.cache/nvim mkdir -p ~/.config/nvim # 2. 写入配置 cat \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; \u0026gt; ~/.config/nvim/init.lua -- [基础设置] vim.g.mapleader = \u0026#34;;\u0026#34; local opt = vim.opt opt.number = true opt.relativenumber = true opt.cursorline = true opt.termguicolors = true opt.encoding = \u0026#34;utf-8\u0026#34; opt.mouse = \u0026#34;a\u0026#34; opt.timeoutlen = 300 opt.splitright = true opt.splitbelow = true -- [安装 lazy.nvim] local lazypath = vim.fn.stdpath(\u0026#34;data\u0026#34;) .. \u0026#34;/lazy/lazy.nvim\u0026#34; if not vim.loop.fs_stat(lazypath) then vim.fn.system({ \u0026#34;git\u0026#34;, \u0026#34;clone\u0026#34;, \u0026#34;--filter=blob:none\u0026#34;, \u0026#34;https://github.com/folke/lazy.nvim.git\u0026#34;, \u0026#34;--branch=stable\u0026#34;, lazypath, }) end vim.opt.rtp:prepend(lazypath) -- [插件配置] require(\u0026#34;lazy\u0026#34;).setup({ -- 1. 主题 (Onedark) { \u0026#34;navarasu/onedark.nvim\u0026#34;, lazy = false, priority = 1000, config = function() require(\u0026#34;onedark\u0026#34;).setup({ style = \u0026#39;dark\u0026#39; }) require(\u0026#34;onedark\u0026#34;).load() -- 护眼模式修复 local hl = vim.api.nvim_set_hl hl(0, \u0026#34;Normal\u0026#34;, { bg = \u0026#34;#1e2127\u0026#34;, fg = \u0026#34;#abb2bf\u0026#34; }) hl(0, \u0026#34;CursorLine\u0026#34;, { bg = \u0026#34;#2c313a\u0026#34; }) end }, -- 2. 文件树 (NvimTree) { \u0026#34;nvim-tree/nvim-tree.lua\u0026#34;, dependencies = { \u0026#34;nvim-tree/nvim-web-devicons\u0026#34; }, config = function() require(\u0026#34;nvim-tree\u0026#34;).setup({ view = { width = 30 }, renderer = { indent_markers = { enable = true } } }) end }, -- 3. 远程复制 (OSC 52) { \u0026#34;ojroques/nvim-osc52\u0026#34;, config = function() require(\u0026#39;osc52\u0026#39;).setup() vim.api.nvim_create_autocmd(\u0026#34;TextYankPost\u0026#34;, { callback = function() if vim.v.event.operator == \u0026#34;y\u0026#34; and vim.v.event.regname == \u0026#34;\u0026#34; then require(\u0026#39;osc52\u0026#39;).copy_register(\u0026#34;\u0026#34;) end end, }) end }, -- 4. 代码格式化 (Conform) { \u0026#34;stevearc/conform.nvim\u0026#34;, config = function() require(\u0026#34;conform\u0026#34;).setup({ formatters_by_ft = { json = { \u0026#34;prettier\u0026#34; }, yaml = { \u0026#34;prettier\u0026#34; }, html = { \u0026#34;prettier\u0026#34; }, css = { \u0026#34;prettier\u0026#34; }, javascript = { \u0026#34;prettier\u0026#34; }, typescript = { \u0026#34;prettier\u0026#34; }, }, format_on_save = { timeout_ms = 1000, lsp_fallback = true }, }) end } }) -- [快捷键映射] local map = vim.keymap.set -- 基础功能 map(\u0026#34;n\u0026#34;, \u0026#34;\u0026lt;leader\u0026gt;w\u0026#34;, \u0026#34;:w\u0026lt;CR\u0026gt;\u0026#34;, { silent = true }) map(\u0026#34;n\u0026#34;, \u0026#34;\u0026lt;leader\u0026gt;q\u0026#34;, \u0026#34;:q\u0026lt;CR\u0026gt;\u0026#34;, { silent = true }) map(\u0026#34;n\u0026#34;, \u0026#34;\u0026lt;CR\u0026gt;\u0026#34;, \u0026#34;:noh\u0026lt;CR\u0026gt;\u0026lt;CR\u0026gt;\u0026#34;, { silent = true }) -- 智能文件树来回切换 (;t) map(\u0026#34;n\u0026#34;, \u0026#34;\u0026lt;leader\u0026gt;t\u0026#34;, function() local view = require(\u0026#34;nvim-tree.view\u0026#34;) if view.is_visible() then if vim.api.nvim_get_current_win() == view.get_winnr() then vim.cmd(\u0026#34;wincmd p\u0026#34;) else vim.cmd(\u0026#34;NvimTreeFocus\u0026#34;) end else vim.cmd(\u0026#34;NvimTreeToggle\u0026#34;) end end, { silent = true }) -- 格式化 (;f) map({ \u0026#34;n\u0026#34;, \u0026#34;v\u0026#34; }, \u0026#34;\u0026lt;leader\u0026gt;f\u0026#34;, function() require(\u0026#34;conform\u0026#34;).format({ lsp_fallback = true, timeout_ms = 1000 }) print(\u0026#34;✨ Format executed\u0026#34;) end, { silent = true }) -- 窗口导航 map(\u0026#34;n\u0026#34;, \u0026#34;\u0026lt;C-h\u0026gt;\u0026#34;, \u0026#34;\u0026lt;C-w\u0026gt;h\u0026#34;) map(\u0026#34;n\u0026#34;, \u0026#34;\u0026lt;C-l\u0026gt;\u0026#34;, \u0026#34;\u0026lt;C-w\u0026gt;l\u0026#34;) map(\u0026#34;n\u0026#34;, \u0026#34;\u0026lt;C-j\u0026gt;\u0026#34;, \u0026#34;\u0026lt;C-w\u0026gt;j\u0026#34;) map(\u0026#34;n\u0026#34;, \u0026#34;\u0026lt;C-k\u0026gt;\u0026#34;, \u0026#34;\u0026lt;C-w\u0026gt;k\u0026#34;) EOF 配置完成后，输入 nvim 启动，按回车让它自动下载并部署所有插件即可。\n核心特性 智能切换：使用 ;t 在文件树与代码之间来回跳转 格式化：;f 手动格式化，;w 保存时自动格式化，;q 退出 其它：和 vim 命令无异，支持跨终端复制粘贴，y 复制 ","permalink":"https://hanigege.github.io/posts/freebsd/freebsd15%E7%8E%B0%E4%BB%A3%E5%8C%96neovim%E7%94%9F%E4%BA%A7%E5%8A%9B%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97/","tags":null,"title":"FreeBSD15现代化Neovim生产力环境部署指南"},{"categories":["routers"],"contents":"内网的dst-nat要加外网接口如pppoe-out1 1. 为什么需要回流？ 当你从内网请求公网 IP 时，ROS 收到包后转发给内网服务器，但服务器发现请求方和自己在同一个网段，会直接把回包传给手机。手机发现自己发给公网 IP 的请求却收到了来自内网私有 IP 的响应，会因为安全机制直接丢弃该包。回流规则通过让 ROS 中转这个“回头包”来解决这个问题。\n2. 完整的 ROS NAT 脚本（包含 Web 回流） 请根据你的实际端口修改 12335 (Web) 和 21 (FTP) 等。 /ip firewall nat # --- 基础规则 --- # 1. 核心上网伪装（必须限制在 WAN 口，防止干扰其他转发） add chain=srcnat action=masquerade out-interface=pppoe-out1 comment=\u0026#34;Standard Internet Access\u0026#34; # --- 端口转发 (DST-NAT) --- # 2. DERP 转发 add chain=dstnat protocol=tcp dst-port=12340 action=dst-nat to-addresses=10.20.20.4 to-ports=12340 comment=\u0026#34;DERP TCP\u0026#34; add chain=dstnat protocol=udp dst-port=3478 action=dst-nat to-addresses=10.20.20.4 to-ports=3478 comment=\u0026#34;DERP STUN\u0026#34; # 3. Web 服务转发 (示例) add chain=dstnat protocol=tcp dst-port=12335 action=dst-nat to-addresses=10.20.20.x to-ports=12335 comment=\u0026#34;web\u0026#34; # 4. FTP 服务转发 (示例) add chain=dstnat protocol=tcp dst-port=21 action=dst-nat to-addresses=10.20.20.x to-ports=21 comment=\u0026#34;vsftpd\u0026#34; # --- 回流规则 (Hairpin NAT) --- # 只有当内网访问内网服务器时才触发。建议将所有内网服务器放在一个规则里，或者逐个添加。 # 给 DERP 添加回流 add chain=srcnat src-address=10.20.20.0/24 dst-address=10.20.20.4 protocol=tcp dst-port=12340 action=masquerade comment=\u0026#34;Hairpin DERP TCP\u0026#34; add chain=srcnat src-address=10.20.20.0/24 dst-address=10.20.20.4 protocol=udp dst-port=3478 action=masquerade comment=\u0026#34;Hairpin DERP STUN\u0026#34; # 给 Web 服务添加回流 (假设内网 IP 为 10.20.20.5) add chain=srcnat src-address=10.20.20.0/24 dst-address=10.20.20.5 protocol=tcp dst-port=12335 action=masquerade comment=\u0026#34;Hairpin Web\u0026#34; 3. 操作建议：使用“地址列表”简化回流 如果你有很多内网服务器需要回流，一条条加 srcnat 很麻烦。你可以这样做：\n在 IP -\u0026gt; Firewall -\u0026gt; Address Lists 里，把所有内网服务器 IP 加到一个叫 Internal_Servers 的列表。\n操作步骤 请在 WinBox 中按照以下两步配置：\n第一步：建立服务器地址列表\n在 IP -\u0026gt; Firewall -\u0026gt; Address Lists 中，将你所有需要从内网访问的服务器 IP 加入列表：\nName: Internal_Servers | Address: 10.20.20.4 (DERP 服务器) Name: Internal_Servers | Address: 10.20.20.5 (Web 服务器) (依此类推，将所有有端口转发需求的内网 IP 都加进去) 第二步：添加全局回流规则\n在 IP -\u0026gt; Firewall -\u0026gt; NAT 中添加这一条（确保它在所有 dst-nat 规则之后，但在基础 masquerade 规则之前，或者紧随其后）： 代码段\n/ip firewall nat add chain=srcnat src-address=10.20.20.0/24 dst-address-list=Internal_Servers action=masquerade comment=\u0026#34;Global Hairpin NAT\u0026#34; 使用 Address List（地址列表） 的方式最为高效，不需要在 NAT 规则里指定端口。\n当请求的目标地址匹配列表中的 IP 时，RouterOS 会自动对所有协议（TCP/UDP/ICMP 等）和所有端口执行回流操作。\n规则排序 例： /ip firewall nat # ==================== # 第一部分：端口映射 (DSTNAT - 外部访问内网) # ==================== # 将外部网络 (WAN 列表) 对 80/443 端口的访问，转发给内网服务器 (以你的 10.20.20.10 为例) add chain=dstnat action=dst-nat dst-port=80,443 in-interface-list=WAN protocol=tcp to-addresses=10.20.20.10 comment=\u0026#34;Web Server Port Forward from WAN\u0026#34; # ==================== # 第二部分：源地址伪装 (SRCNAT - 内网访问外部) # ==================== # 1. Hairpin NAT (内网回流，必须放在全局伪装之前) # 作用：确保内网设备通过公网域名访问内网服务器时，数据包能在路由器内部正确折返 add chain=srcnat action=masquerade src-address=10.20.20.0/24 dst-address-list=Internal_Servers comment=\u0026#34;Global Hairpin NAT\u0026#34; # 2. 全局上网伪装 (全局兜底，必须放在 srcnat 链的最底部) # 作用：所有从 WAN 列表物理或虚拟接口发出的流量，全部转换并伪装为路由器的公网 IP add chain=srcnat action=masquerade out-interface-list=WAN comment=\u0026#34;Global Internet Masquerade\u0026#34; 至此，你的 RouterOS 防火墙底层重构就已经全部完成，既满足了旁路由科学上网的苛刻要求，又具备了企业级的扩展能力。\n4. 验证 Web 服务 外网测试：手机关 Wi-Fi，访问域名，确认 Web 正常。\n内网测试：手机连 Wi-Fi，访问同一个域名。如果能打开，说明回流配置成功。\n5. 配套的防火墙规则，也是我自用的 特别强调：如果使用了小包优先规则配置，必须停用下面所有配置中的fasttrack-connection 硬件加速规则 RouterOS 默认开启了 Fasttrack（硬件加速），该功能会强制数据包绕过 Mangle 标记和 Queue Tree 排队，如果不处理，所有 QoS 配置均无效。\nipv4防火墙配置 安全清空旧防火墙规则 使用带有 dynamic=no 参数的清理命令，只抹除手工配置的静态规则，避开系统底层的内置保护规则。\n代码段\n/ip firewall filter remove [find dynamic=no] /ipv6 firewall filter remove [find dynamic=no] 带添加旁路由ip规则版 (mosdns+sb): /ip firewall filter # ==================== # 入站链 (INPUT) - 访问路由器本身 # ==================== add action=accept chain=input comment=\u0026#34;1. Accept established,related,untracked\u0026#34; connection-state=established,related,untracked add action=drop chain=input comment=\u0026#34;2. Drop invalid\u0026#34; connection-state=invalid add action=accept chain=input comment=\u0026#34;3. Accept bridge1 (Internal Admin)\u0026#34; in-interface=bridge1 # 防爆破逻辑 (针对 3981, 2222 端口) add action=drop chain=input comment=\u0026#34;4. Drop Bruteforce IPs\u0026#34; dst-port=3981,2222 protocol=tcp src-address-list=bruteforce_blacklist add action=accept chain=input comment=\u0026#34;5. Accept limited connections\u0026#34; connection-limit=10,32 dst-port=3981,2222 protocol=tcp add action=add-src-to-address-list address-list=bruteforce_blacklist address-list-timeout=3d chain=input comment=\u0026#34;6. Add to Bruteforce List\u0026#34; dst-port=3981,2222 protocol=tcp add action=drop chain=input comment=\u0026#34;7. Drop excess packets\u0026#34; dst-port=3981,2222 protocol=tcp # WAN口丢弃与兜底 add action=drop chain=input comment=\u0026#34;8. Drop ICMP from WAN\u0026#34; in-interface=pppoe-out1 protocol=icmp add action=drop chain=input comment=\u0026#34;9. Drop all other input from WAN\u0026#34; in-interface=pppoe-out1 # ==================== # 转发链 (FORWARD) - 穿过路由器 (外网\u0026lt;-\u0026gt;内网) # ==================== # 1. 旁路由豁免 (必须放在 Fasttrack 和 Invalid 丢弃之前) add action=accept chain=forward comment=\u0026#34;1. Bypass Fasttrack \u0026amp; Tracking: sing-box out\u0026#34; src-address=10.20.20.6 add action=accept chain=forward comment=\u0026#34;2. Bypass Fasttrack \u0026amp; Tracking: sing-box in\u0026#34; dst-address=10.20.20.6 # 2. 硬件加速 (处理内网其他正常不走代理的直连流量) add action=fasttrack-connection chain=forward comment=\u0026#34;3. Fasttrack\u0026#34; connection-state=established,related # 3. 基础状态放行 add action=accept chain=forward comment=\u0026#34;4. Accept established,related,untracked\u0026#34; connection-state=established,related,untracked # 4. 内网正常转发与端口映射放行 add action=accept chain=forward comment=\u0026#34;6. Allow bridge1 forward (Internal Outbound)\u0026#34; in-interface=bridge1 add action=accept chain=forward comment=\u0026#34;7. Allow DSTNAT (Port Forwarding)\u0026#34; connection-nat-state=dstnat in-interface=pppoe-out1 # 5. 全局兜底拦截 (零信任原则) add action=drop chain=forward comment=\u0026#34;8. Drop all other forward\u0026#34; 转发链 (FORWARD)特别说明： FORWARD链“旁路由豁免”填入你的mos+sb的ip\nINPUT链“3981, 2222端口”填入你的winbox，ssh等相关对外开放的端口\n不添加旁路由ip规则版： /ip firewall filter # ==================== # 入站链 (INPUT) - 访问路由器本身 # ==================== add action=accept chain=input comment=\u0026#34;1. Accept established,related,untracked\u0026#34; connection-state=established,related,untracked add action=drop chain=input comment=\u0026#34;2. Drop invalid\u0026#34; connection-state=invalid add action=accept chain=input comment=\u0026#34;3. Accept bridge1 (Internal Admin)\u0026#34; in-interface=bridge1 # 防爆破逻辑 (针对 3981, 2222 端口) add action=drop chain=input comment=\u0026#34;4. Drop Bruteforce IPs\u0026#34; dst-port=3981,2222 protocol=tcp src-address-list=bruteforce_blacklist add action=accept chain=input comment=\u0026#34;5. Accept limited connections\u0026#34; connection-limit=10,32 dst-port=3981,2222 protocol=tcp add action=add-src-to-address-list address-list=bruteforce_blacklist address-list-timeout=3d chain=input comment=\u0026#34;6. Add to Bruteforce List\u0026#34; dst-port=3981,2222 protocol=tcp add action=drop chain=input comment=\u0026#34;7. Drop excess packets\u0026#34; dst-port=3981,2222 protocol=tcp # WAN口丢弃与兜底 add action=drop chain=input comment=\u0026#34;8. Drop ICMP from WAN\u0026#34; in-interface=pppoe-out1 protocol=icmp add action=drop chain=input comment=\u0026#34;9. Drop all other input from WAN\u0026#34; in-interface=pppoe-out1 # ==================== # 转发链 (FORWARD) - 穿过路由器 (外网\u0026lt;-\u0026gt;内网) # ==================== # 1. 硬件加速 (处理内网其他正常不走代理的直连流量) add action=fasttrack-connection chain=forward comment=\u0026#34;3. Fasttrack\u0026#34; connection-state=established,related # 2. 基础状态放行 add action=accept chain=forward comment=\u0026#34;4. Accept established,related,untracked\u0026#34; connection-state=established,related,untracked # 3. 丢弃无效包 (放在旁路由之后，防止非对称路由回程包被误杀) add action=drop chain=forward comment=\u0026#34;5. Drop invalid\u0026#34; connection-state=invalid # 4. 内网正常转发与端口映射放行 add action=accept chain=forward comment=\u0026#34;6. Allow bridge1 forward (Internal Outbound)\u0026#34; in-interface=bridge1 add action=accept chain=forward comment=\u0026#34;7. Allow DSTNAT (Port Forwarding)\u0026#34; connection-nat-state=dstnat in-interface=pppoe-out1 # 5. 全局兜底拦截 (零信任原则) add action=drop chain=forward comment=\u0026#34;8. Drop all other forward\u0026#34; 转发链 (FORWARD)特别说明： 第5条\u0026ldquo;DST-NAT\u0026quot;规则：在 IPv4 的 Forward 链中，我加入了一条 connection-nat-state=dstnat。这确保了你在 IP -\u0026gt; Firewall -\u0026gt; NAT 中做的端口映射能够穿透 forward 的兜底 drop 规则。 内网互通：只要数据包进入 bridge1 接口，就会被 Allow bridge1 forward 捕获并放行，不会受到最后一条 drop 的影响。\n这样配置后，局域网内的 PT 下载、NAS 外部大文件传输等不走 10.20.20.6 的直连流量依然可以享受硬件加速降低 CPU 负载，而 sing-box 进出的流量则由 CPU 稳妥处理，互不干扰\nipv6防火墙配置 添加旁路由ip规则版 (mosdns+sb) /ipv6 firewall filter # ==================== # 入站链 (INPUT) - 保护路由器本体 # ==================== add action=accept chain=input comment=\u0026#34;1. Accept established,related,untracked\u0026#34; connection-state=established,related,untracked add action=drop chain=input comment=\u0026#34;2. Drop invalid\u0026#34; connection-state=invalid add action=accept chain=input comment=\u0026#34;3. Accept ICMPv6 (Critical for IPv6)\u0026#34; protocol=icmpv6 add action=accept chain=input comment=\u0026#34;4. Allow DHCPv6 Client from WAN\u0026#34; dst-port=546 in-interface=pppoe-out1 protocol=udp src-address=fe80::/10 add action=accept chain=input comment=\u0026#34;5. Allow bridge1 (Internal Admin)\u0026#34; in-interface=bridge1 add action=drop chain=input comment=\u0026#34;6. Drop all not from bridge1\u0026#34; in-interface=!bridge1 # ==================== # 转发链 (FORWARD) - 穿过路由器 (外网\u0026lt;-\u0026gt;内网) # ==================== # 1. 旁路由豁免 (必须放在 Fasttrack 和 Invalid 丢弃之前) add action=accept chain=forward comment=\u0026#34;1. Bypass Fasttrack \u0026amp; Tracking: sing-box out\u0026#34; src-address=fd88::6666 add action=accept chain=forward comment=\u0026#34;2. Bypass Fasttrack \u0026amp; Tracking: sing-box in\u0026#34; dst-address=fd88::6666 # 2. 硬件加速 (处理正常不走代理的 IPv6 直连流量) add action=fasttrack-connection chain=forward comment=\u0026#34;3. Fasttrack\u0026#34; connection-state=established,related # 3. 基础状态放行 add action=accept chain=forward comment=\u0026#34;4. Accept forward established,related,untracked\u0026#34; connection-state=established,related,untracked # 4. 核心协议与内网放行 add action=accept chain=forward comment=\u0026#34;6. Accept Forward ICMPv6\u0026#34; protocol=icmpv6 add action=accept chain=forward comment=\u0026#34;7. Allow bridge1 forward (Internal Outbound)\u0026#34; in-interface=bridge1 # --- 暴露内网服务 (注意：替换为实际公网 IPv6 地址后再按需启用) --- add action=accept chain=forward comment=\u0026#34;8. Allow NPM (HTTP/HTTPS)\u0026#34; disabled=yes dst-address=240e::xxxx:xxxx dst-port=80,443 protocol=tcp add action=accept chain=forward comment=\u0026#34;9. Allow Hysteria2/Proxy\u0026#34; disabled=yes dst-address=240e::xxxx:xxxx dst-port=36789 protocol=udp add action=accept chain=forward comment=\u0026#34;10. Allow Shadowsocks\u0026#34; disabled=yes dst-address=240e::xxxx:xxxx dst-port=36789 protocol=tcp # 5. 兜底拦截 (零信任原则) add action=drop chain=forward comment=\u0026#34;11. Drop all other forward (Protect LAN)\u0026#34; 关键提醒： 修改旁路由的ip为你的ipv6地址\n如果你的宽带是动态 IPv6 前缀（PD），服务器的完整 IPv6 地址会变化。这种情况下，不应直接写死 dst-address，而是需要结合 MikroTik 的 IPv6 Firewall Address Lists 功能，或者使用 in-interface=pppoe-out1 配合 out-interface=bridge1 加上特定设备的特定匹配规则（比如通过防火墙脚本动态更新）。\nIPv4 依靠 NAT，不主动映射外部进不来；但 IPv6 是端到端直通（没有 NAT）。 你在 forward 链中放行 dst-port=80,443，却没有指定目标地址 (dst-address)。一旦启用，这代表公网可以访问你局域网内所有设备的 80 和 443 端口（包括光猫、路由器后台、智能家居、其他电脑等）。\n正确做法：必须严格绑定目标服务器的 IPv6 地址（dst-address=服务器IPv6地址），或者通过 MAC 地址自动获取到的 IPv6 后缀。\n不添加旁路由ip规则版 (mosdns+sb)： /ipv6 firewall filter # ==================== # 入站链 (INPUT) - 保护路由器本体 # ==================== add action=accept chain=input comment=\u0026#34;1. Accept established,related,untracked\u0026#34; connection-state=established,related,untracked add action=drop chain=input comment=\u0026#34;2. Drop invalid\u0026#34; connection-state=invalid add action=accept chain=input comment=\u0026#34;3. Accept ICMPv6 (Critical for IPv6)\u0026#34; protocol=icmpv6 add action=accept chain=input comment=\u0026#34;4. Allow DHCPv6 Client from WAN\u0026#34; dst-port=546 in-interface=pppoe-out1 protocol=udp src-address=fe80::/10 add action=accept chain=input comment=\u0026#34;5. Allow bridge1 (Internal Admin)\u0026#34; in-interface=bridge1 add action=drop chain=input comment=\u0026#34;6. Drop all not from bridge1\u0026#34; in-interface=!bridge1 # ==================== # 转发链 (FORWARD) - 穿过路由器 (外网\u0026lt;-\u0026gt;内网) # ==================== # 1. 硬件加速 (处理正常不走代理的 IPv6 直连流量) add action=fasttrack-connection chain=forward comment=\u0026#34;3. Fasttrack\u0026#34; connection-state=established,related # 2. 基础状态放行 add action=accept chain=forward comment=\u0026#34;4. Accept forward established,related,untracked\u0026#34; connection-state=established,related,untracked # 3. 丢弃无效包 (防止旁路由非对称回程包被误杀) add action=drop chain=forward comment=\u0026#34;5. Drop invalid\u0026#34; connection-state=invalid # 4. 核心协议与内网放行 add action=accept chain=forward comment=\u0026#34;6. Accept Forward ICMPv6\u0026#34; protocol=icmpv6 add action=accept chain=forward comment=\u0026#34;7. Allow bridge1 forward (Internal Outbound)\u0026#34; in-interface=bridge1 # --- 暴露内网服务 (注意：替换为实际公网 IPv6 地址后再按需启用) --- add action=accept chain=forward comment=\u0026#34;8. Allow NPM (HTTP/HTTPS)\u0026#34; disabled=yes dst-address=240e::xxxx:xxxx dst-port=80,443 protocol=tcp add action=accept chain=forward comment=\u0026#34;9. Allow Hysteria2/Proxy\u0026#34; disabled=yes dst-address=240e::xxxx:xxxx dst-port=36789 protocol=udp add action=accept chain=forward comment=\u0026#34;10. Allow Shadowsocks\u0026#34; disabled=yes dst-address=240e::xxxx:xxxx dst-port=36789 protocol=tcp # 5. 兜底拦截 (零信任原则) add action=drop chain=forward comment=\u0026#34;11. Drop all other forward (Protect LAN)\u0026#34; 解释：为什么添加路由ip后要删除屏蔽无效包：即：FORWARD 链 Drop invalid 这是因为新加入的 FORWARD 链 Drop invalid（丢弃无效包）规则，与你的旁路由（10.20.20.6）网络架构产生了冲突，导致 RouterOS 误杀了部分正常的 UDP 游戏流量和 Telegram 的初始握手包。\n科学依据 在你的网络拓扑中，客户端将网关指向了 10.20.20.6（旁路由）。 当访问不经过代理的直连网络（如国内流量、部分 P2P/UDP 游戏节点）时，往往会产生非对称路由：\n去程：客户端 -\u0026gt; 旁路由 (10.20.20.6) -\u0026gt; 主路由 (ROS) -\u0026gt; 互联网。 回程：互联网 -\u0026gt; 主路由 (ROS) -\u0026gt; 直接交回给客户端（因为都在 bridge1 同一网段）。 这种一来一回路径不一致的数据流，会让 RouterOS 的连接跟踪引擎（Connection Tracker）抓不到完整的 TCP 三次握手或 UDP 双向通讯状态。因此，ROS 会将这些包标记为 invalid（无效状态）。 在你原来的旧配置中，因为缺少 FORWARD 链的拦截规则，这些包被默认放行了；而新配置补齐了这条严苛的拦截规则，反而导致 Telegram 连接卡顿（等待超时后回退其他协议）以及英雄联盟美服（依赖大量 UDP 报文）断连。\n成功的步骤和方法 解决办法非常简单，只需禁用或删除转发链中的无效包拦截规则，将这部分容错空间还给旁路由网络。\n请在 RouterOS 终端中直接复制执行以下两行代码：\n# 1. 停用 IPv4 转发链中的无效包拦截 /ip firewall filter disable [find chain=forward connection-state=invalid] # 2. 停用 IPv6 转发链中的无效包拦截 /ipv6 firewall filter disable [find chain=forward connection-state=invalid] 或者直接删除： 为了保持配置的整洁，建议直接将这两条已经禁用的无用规则彻底删除。请在终端执行以下命令：\n代码段\n彻底移除已被停用的无效包拦截规则 /ip firewall filter remove [find chain=forward connection-state=invalid disabled=yes] /ipv6 firewall filter remove [find chain=forward connection-state=invalid disabled=yes] 执行完毕后，所有 invalid 状态的数据包会直接跳过该规则，落入后面的 Allow LAN forward 被正常放行。你可以立即重新打开 Telegram 和英雄联盟美服测试，网络应该会瞬间恢复如初，你的网络既能享受全速的 Fasttrack 硬件加速，又能完美兼容 10.20.20.6 的透明代理分流，同时保持着极高的企业级安全防御标准。\n结束！ 如创建了interface list，防火墙的配置方案： 1. 创建列表名称 /interface list add name=WAN add name=LAN 2. 将 pppoe-out1 加入 WAN 列表 /interface list member add interface=pppoe-out1 list=WAN 3. 将 bridge1 加入 LAN 列表 add interface=bridge1 list=LAN 带添加旁路由ip规则版 (mosdns+sb)： # ========================================== # 第一部分：IPv4 防火墙规则 (已适配 Interface List) # ========================================== /ip firewall filter # --- 入站链 (INPUT) - 保护路由器本体 --- add action=accept chain=input comment=\u0026#34;1. Accept established,related,untracked\u0026#34; connection-state=established,related,untracked add action=drop chain=input comment=\u0026#34;2. Drop invalid\u0026#34; connection-state=invalid add action=accept chain=input comment=\u0026#34;3. Accept LAN (Internal Admin)\u0026#34; in-interface-list=LAN # 防爆破逻辑 add action=drop chain=input comment=\u0026#34;4. Drop Bruteforce IPs\u0026#34; dst-port=3981,2222 protocol=tcp src-address-list=bruteforce_blacklist add action=accept chain=input comment=\u0026#34;5. Accept limited connections\u0026#34; connection-limit=10,32 dst-port=3981,2222 protocol=tcp add action=add-src-to-address-list address-list=bruteforce_blacklist address-list-timeout=3d chain=input comment=\u0026#34;6. Add to Bruteforce List\u0026#34; dst-port=3981,2222 protocol=tcp add action=drop chain=input comment=\u0026#34;7. Drop excess packets\u0026#34; dst-port=3981,2222 protocol=tcp # WAN口丢弃兜底 add action=drop chain=input comment=\u0026#34;8. Drop ICMP from WAN\u0026#34; in-interface-list=WAN protocol=icmp add action=drop chain=input comment=\u0026#34;9. Drop all other input from WAN\u0026#34; in-interface-list=WAN # --- 转发链 (FORWARD) - 穿过路由器 --- # 1. 旁路由豁免 add action=accept chain=forward comment=\u0026#34;1. Bypass Fasttrack \u0026amp; Tracking: sing-box out\u0026#34; src-address=10.20.20.6 add action=accept chain=forward comment=\u0026#34;2. Bypass Fasttrack \u0026amp; Tracking: sing-box in\u0026#34; dst-address=10.20.20.6 # 2. 硬件加速 add action=fasttrack-connection chain=forward comment=\u0026#34;3. Fasttrack\u0026#34; connection-state=established,related # 3. 基础状态放行与丢弃 add action=accept chain=forward comment=\u0026#34;4. Accept established,related,untracked\u0026#34; connection-state=established,related,untracked # 4. 内网正常转发与端口映射放行 add action=accept chain=forward comment=\u0026#34;6. Allow LAN forward (Internal Outbound)\u0026#34; in-interface-list=LAN add action=accept chain=forward comment=\u0026#34;7. Allow DSTNAT (Port Forwarding)\u0026#34; connection-nat-state=dstnat in-interface-list=WAN # 5. 全局兜底拦截 add action=drop chain=forward comment=\u0026#34;8. Drop all other forward\u0026#34; # ========================================== # 第二部分：IPv6 防火墙规则 (已适配 Interface List) # ========================================== /ipv6 firewall filter # --- 入站链 (INPUT) - 保护路由器本体 --- add action=accept chain=input comment=\u0026#34;1. Accept established,related,untracked\u0026#34; connection-state=established,related,untracked add action=drop chain=input comment=\u0026#34;2. Drop invalid\u0026#34; connection-state=invalid add action=accept chain=input comment=\u0026#34;3. Accept ICMPv6 (Critical for IPv6)\u0026#34; protocol=icmpv6 add action=accept chain=input comment=\u0026#34;4. Allow DHCPv6 Client from WAN\u0026#34; dst-port=546 in-interface-list=WAN protocol=udp src-address=fe80::/10 add action=accept chain=input comment=\u0026#34;5. Allow LAN (Internal Admin)\u0026#34; in-interface-list=LAN add action=drop chain=input comment=\u0026#34;6. Drop all not from LAN\u0026#34; in-interface-list=!LAN # --- 转发链 (FORWARD) - 穿过路由器 --- # 1. 旁路由豁免 add action=accept chain=forward comment=\u0026#34;1. Bypass Fasttrack \u0026amp; Tracking: sing-box out\u0026#34; src-address=fd88::6666 add action=accept chain=forward comment=\u0026#34;2. Bypass Fasttrack \u0026amp; Tracking: sing-box in\u0026#34; dst-address=fd88::6666 # 2. 硬件加速 add action=fasttrack-connection chain=forward comment=\u0026#34;3. Fasttrack\u0026#34; connection-state=established,related # 3. 基础状态放行 add action=accept chain=forward comment=\u0026#34;4. Accept forward established,related,untracked\u0026#34; connection-state=established,related,untracked # 4. 核心协议与内网放行 add action=accept chain=forward comment=\u0026#34;6. Accept Forward ICMPv6\u0026#34; protocol=icmpv6 add action=accept chain=forward comment=\u0026#34;7. Allow LAN forward (Internal Outbound)\u0026#34; in-interface-list=LAN # 5. 暴露内网服务 (替换为实际公网 IPv6 地址后再按需启用) add action=accept chain=forward comment=\u0026#34;8. Allow NPM (HTTP/HTTPS)\u0026#34; disabled=yes dst-address=240e::xxxx:xxxx dst-port=80,443 protocol=tcp add action=accept chain=forward comment=\u0026#34;9. Allow Hysteria2/Proxy\u0026#34; disabled=yes dst-address=240e::xxxx:xxxx dst-port=36789 protocol=udp add action=accept chain=forward comment=\u0026#34;10. Allow Shadowsocks\u0026#34; disabled=yes dst-address=240e::xxxx:xxxx dst-port=36789 protocol=tcp # 6. 兜底拦截 add action=drop chain=forward comment=\u0026#34;11. Drop all other forward (Protect LAN)\u0026#34; 不添加旁路由ip规则版 (mosdns+sb): # ========================================== # 第一部分：IPv4 防火墙规则 (已适配 Interface List) # ========================================== /ip firewall filter # --- 入站链 (INPUT) - 保护路由器本体 --- add action=accept chain=input comment=\u0026#34;1. Accept established,related,untracked\u0026#34; connection-state=established,related,untracked add action=drop chain=input comment=\u0026#34;2. Drop invalid\u0026#34; connection-state=invalid add action=accept chain=input comment=\u0026#34;3. Accept LAN (Internal Admin)\u0026#34; in-interface-list=LAN # 防爆破逻辑 add action=drop chain=input comment=\u0026#34;4. Drop Bruteforce IPs\u0026#34; dst-port=3981,2222 protocol=tcp src-address-list=bruteforce_blacklist add action=accept chain=input comment=\u0026#34;5. Accept limited connections\u0026#34; connection-limit=10,32 dst-port=3981,2222 protocol=tcp add action=add-src-to-address-list address-list=bruteforce_blacklist address-list-timeout=3d chain=input comment=\u0026#34;6. Add to Bruteforce List\u0026#34; dst-port=3981,2222 protocol=tcp add action=drop chain=input comment=\u0026#34;7. Drop excess packets\u0026#34; dst-port=3981,2222 protocol=tcp # WAN口丢弃兜底 add action=drop chain=input comment=\u0026#34;8. Drop ICMP from WAN\u0026#34; in-interface-list=WAN protocol=icmp add action=drop chain=input comment=\u0026#34;9. Drop all other input from WAN\u0026#34; in-interface-list=WAN # --- 转发链 (FORWARD) - 穿过路由器 --- # 1. 硬件加速 add action=fasttrack-connection chain=forward comment=\u0026#34;3. Fasttrack\u0026#34; connection-state=established,related # 2. 基础状态放行与丢弃 add action=accept chain=forward comment=\u0026#34;4. Accept established,related,untracked\u0026#34; connection-state=established,related,untracked add action=drop chain=forward comment=\u0026#34;5. Drop invalid\u0026#34; connection-state=invalid # 3. 内网正常转发与端口映射放行 add action=accept chain=forward comment=\u0026#34;6. Allow LAN forward (Internal Outbound)\u0026#34; in-interface-list=LAN add action=accept chain=forward comment=\u0026#34;7. Allow DSTNAT (Port Forwarding)\u0026#34; connection-nat-state=dstnat in-interface-list=WAN # 4. 全局兜底拦截 add action=drop chain=forward comment=\u0026#34;8. Drop all other forward\u0026#34; # ========================================== # 第二部分：IPv6 防火墙规则 (已适配 Interface List) # ========================================== /ipv6 firewall filter # --- 入站链 (INPUT) - 保护路由器本体 --- add action=accept chain=input comment=\u0026#34;1. Accept established,related,untracked\u0026#34; connection-state=established,related,untracked add action=drop chain=input comment=\u0026#34;2. Drop invalid\u0026#34; connection-state=invalid add action=accept chain=input comment=\u0026#34;3. Accept ICMPv6 (Critical for IPv6)\u0026#34; protocol=icmpv6 add action=accept chain=input comment=\u0026#34;4. Allow DHCPv6 Client from WAN\u0026#34; dst-port=546 in-interface-list=WAN protocol=udp src-address=fe80::/10 add action=accept chain=input comment=\u0026#34;5. Allow LAN (Internal Admin)\u0026#34; in-interface-list=LAN add action=drop chain=input comment=\u0026#34;6. Drop all not from LAN\u0026#34; in-interface-list=!LAN # --- 转发链 (FORWARD) - 穿过路由器 --- # 1. 硬件加速 add action=fasttrack-connection chain=forward comment=\u0026#34;3. Fasttrack\u0026#34; connection-state=established,related # 2. 基础状态放行与丢弃 add action=accept chain=forward comment=\u0026#34;4. Accept forward established,related,untracked\u0026#34; connection-state=established,related,untracked add action=drop chain=forward comment=\u0026#34;5. Drop invalid\u0026#34; connection-state=invalid # 3. 核心协议与内网放行 add action=accept chain=forward comment=\u0026#34;6. Accept Forward ICMPv6\u0026#34; protocol=icmpv6 add action=accept chain=forward comment=\u0026#34;7. Allow LAN forward (Internal Outbound)\u0026#34; in-interface-list=LAN # 4. 暴露内网服务 (替换为实际公网 IPv6 地址后再按需启用) add action=accept chain=forward comment=\u0026#34;8. Allow NPM (HTTP/HTTPS)\u0026#34; disabled=yes dst-address=240e::xxxx:xxxx dst-port=80,443 protocol=tcp add action=accept chain=forward comment=\u0026#34;9. Allow Hysteria2/Proxy\u0026#34; disabled=yes dst-address=240e::xxxx:xxxx dst-port=36789 protocol=udp add action=accept chain=forward comment=\u0026#34;10. Allow Shadowsocks\u0026#34; disabled=yes dst-address=240e::xxxx:xxxx dst-port=36789 protocol=tcp # 5. 兜底拦截 add action=drop chain=forward comment=\u0026#34;11. Drop all other forward (Protect LAN)\u0026#34; IPV6的ND照着操作即可 ","permalink":"https://hanigege.github.io/posts/routers/05.routeros%E5%A6%82%E4%BD%95nat%E5%9B%9E%E6%B5%81/","tags":null,"title":"05.RouterOS如何nat回流及包含配套防火墙规则"},{"categories":["routers"],"contents":"本教程介绍使用 queue tree 开启 ROS 的流控功能 本教程介绍如何使用 RouterOS 的 queue tree 实现流量整形。 文章分成两种方案：\n为 DNS、Web 等小包流量设置更高优先级，提高网页响应速度，适合一般用户； 为宽带及特定服务设定上传/下载限速，并按服务设定优先级，适合 BT/PT 等大流量应用用户。 1、为 DNS、Web 等小包流量设置更高优先级，提高网页响应速度，适合一般用户使用。 添加queue type /queue type add fq-codel-flows=128 fq-codel-interval=30ms fq-codel-limit=128 fq-codel-memlimit=4096.0KiB fq-codel-quantum=512 fq-codel-target=3ms kind=fq-codel name=Fq_Codel_Dns_Up /queue type add fq-codel-flows=256 fq-codel-interval=30ms fq-codel-limit=128 fq-codel-memlimit=8.0MiB fq-codel-quantum=512 fq-codel-target=3ms kind=fq-codel name=Fq_Codel_Dns_Down /queue type add fq-codel-flows=512 fq-codel-interval=50ms fq-codel-limit=512 fq-codel-memlimit=8.0MiB fq-codel-quantum=512 fq-codel-target=5ms kind=fq-codel name=Fq_Codel_Small_Up /queue type add fq-codel-flows=512 fq-codel-interval=50ms fq-codel-limit=512 fq-codel-memlimit=16.0MiB fq-codel-quantum=512 fq-codel-target=5ms kind=fq-codel name=Fq_Codel_Small_Down /queue type add fq-codel-flows=512 fq-codel-interval=50ms fq-codel-limit=2048 fq-codel-memlimit=64.0MiB fq-codel-quantum=1400 fq-codel-target=5ms kind=fq-codel name=Fq_Codel_Web_Up /queue type add fq-codel-flows=1024 fq-codel-interval=50ms fq-codel-limit=4096 fq-codel-memlimit=128.0MiB fq-codel-quantum=1500 fq-codel-target=5ms kind=fq-codel name=Fq_Codel_Web_Down /queue type add fq-codel-flows=1024 fq-codel-interval=100ms fq-codel-limit=8192 fq-codel-memlimit=128.0MiB fq-codel-quantum=1400 fq-codel-target=8ms kind=fq-codel name=Fq_Codel_Stream_Up /queue type add fq-codel-flows=2048 fq-codel-interval=100ms fq-codel-limit=10240 fq-codel-memlimit=256.0MiB fq-codel-quantum=1500 fq-codel-target=8ms kind=fq-codel name=Fq_Codel_Stream_Down /queue type add fq-codel-flows=2048 fq-codel-interval=100ms fq-codel-limit=10240 fq-codel-memlimit=128.0MiB fq-codel-quantum=1400 fq-codel-target=20ms kind=fq-codel name=Fq_Codel_Nomark_Up /queue type add fq-codel-flows=4096 fq-codel-interval=100ms fq-codel-limit=10240 fq-codel-memlimit=256.0MiB fq-codel-quantum=1500 fq-codel-target=15ms kind=fq-codel name=Fq_Codel_Nomark_Down 配置 queue tree 自行修改桥的名称（bridge1）及pppoe拨号口（pppoe-out1）的名称\n注：下行Down，配置了bridge则用beidge，未配置则用lan网卡 /queue tree add bucket-size=0.005 name=Dns-packet-Down packet-mark=Dns-packet parent=bridge1 priority=1 queue=Fq_Codel_Dns_Down /queue tree add bucket-size=0.01 name=Small-packet-Down packet-mark=Small-packet parent=bridge1 priority=2 queue=Fq_Codel_Small_Down /queue tree add bucket-size=0.03 name=Web-packet-Down packet-mark=Web-packet parent=bridge1 priority=3 queue=Fq_Codel_Web_Down /queue tree add bucket-size=0.06 name=Stream-Packet-Down packet-mark=Stream-packet parent=bridge1 priority=4 queue=Fq_Codel_Stream_Down /queue tree add bucket-size=0.1 name=Nomark-Packet-Down packet-mark=no-mark parent=bridge1 priority=6 queue=Fq_Codel_Nomark_Down 注：上行UP，接口直接用网卡wan /queue tree add bucket-size=0.005 name=Dns-packet-Up packet-mark=Dns-packet parent=wan priority=1 queue=Fq_Codel_Dns_Up /queue tree add bucket-size=0.01 name=Small-packet-Up packet-mark=Small-packet parent=wan priority=2 queue=Fq_Codel_Small_Up /queue tree add bucket-size=0.03 name=Web-packet-Up packet-mark=Web-packet parent=wan priority=3 queue=Fq_Codel_Web_Up /queue tree add bucket-size=0.06 name=Stream-Packet-Up packet-mark=Stream-packet parent=wan priority=4 queue=Fq_Codel_Stream_Up /queue tree add bucket-size=0.1 name=Nomark-Packet-Up packet-mark=no-mark parent=wan priority=6 queue=Fq_Codel_Nomark_Up ipv4防火墙中使用mangle标记不同类型的流量（可直接复制，不用修改） 下面示例为 IPv4 的 mangle 标记规则：\n/ip firewall mangle add action=mark-packet chain=prerouting new-packet-mark=Dns-packet passthrough=no port=53 protocol=udp /ip firewall mangle add action=mark-packet chain=prerouting new-packet-mark=Dns-packet passthrough=no port=53,853 protocol=tcp /ip firewall mangle add action=mark-packet chain=prerouting new-packet-mark=Web-packet packet-mark=no-mark passthrough=no port=80,443,8080 protocol=tcp /ip firewall mangle add action=mark-packet chain=prerouting new-packet-mark=Web-packet packet-mark=no-mark passthrough=no port=80,443,8080 protocol=udp /ip firewall mangle add action=mark-packet chain=prerouting new-packet-mark=Small-packet packet-mark=no-mark packet-size=0-512 connection-bytes=0-256k passthrough=no /ip firewall mangle add action=mark-packet chain=prerouting new-packet-mark=Stream-packet packet-mark=no-mark passthrough=no /ip firewall mangle add action=mark-packet chain=forward new-packet-mark=Dns-packet passthrough=no port=53 protocol=udp /ip firewall mangle add action=mark-packet chain=forward new-packet-mark=Dns-packet passthrough=no port=53,853 protocol=tcp /ip firewall mangle add action=mark-packet chain=forward new-packet-mark=Web-packet packet-mark=no-mark passthrough=no port=80,443,8080 protocol=tcp /ip firewall mangle add action=mark-packet chain=forward new-packet-mark=Web-packet packet-mark=no-mark passthrough=no port=80,443,8080 protocol=udp /ip firewall mangle add action=mark-packet chain=forward new-packet-mark=Small-packet packet-mark=no-mark packet-size=0-512 connection-bytes=0-256k passthrough=no /ip firewall mangle add action=mark-packet chain=forward new-packet-mark=Stream-packet packet-mark=no-mark passthrough=no ipv6防火墙中使用mangle标记不同类型的流量（可直接复制，不用修改）\n/ipv6 firewall mangle add action=mark-packet chain=prerouting new-packet-mark=Dns-packet passthrough=no port=53 protocol=udp /ipv6 firewall mangle add action=mark-packet chain=prerouting new-packet-mark=Dns-packet passthrough=no port=53,853 protocol=tcp /ipv6 firewall mangle add action=mark-packet chain=prerouting new-packet-mark=Web-packet packet-mark=no-mark passthrough=no port=80,443,8080 protocol=tcp /ipv6 firewall mangle add action=mark-packet chain=prerouting new-packet-mark=Web-packet packet-mark=no-mark passthrough=no port=80,443,8080 protocol=udp /ipv6 firewall mangle add action=mark-packet chain=prerouting new-packet-mark=Small-packet packet-mark=no-mark packet-size=0-512 passthrough=no /ipv6 firewall mangle add action=mark-packet chain=prerouting new-packet-mark=Stream-packet packet-mark=no-mark passthrough=no /ipv6 firewall mangle add action=mark-packet chain=forward new-packet-mark=Dns-packet passthrough=no port=53 protocol=udp /ipv6 firewall mangle add action=mark-packet chain=forward new-packet-mark=Dns-packet passthrough=no port=53,853 protocol=tcp /ipv6 firewall mangle add action=mark-packet chain=forward new-packet-mark=Web-packet packet-mark=no-mark passthrough=no port=80,443,8080 protocol=tcp /ipv6 firewall mangle add action=mark-packet chain=forward new-packet-mark=Web-packet packet-mark=no-mark passthrough=no port=80,443,8080 protocol=udp /ipv6 firewall mangle add action=mark-packet chain=forward new-packet-mark=Small-packet packet-mark=no-mark packet-size=0-512 connection-bytes=0-256k passthrough=no /ipv6 firewall mangle add action=mark-packet chain=forward new-packet-mark=Stream-packet packet-mark=no-mark passthrough=no 2、为宽带及特定服务设定上传下载限速，并按服务设定优先级，主要适合PT、BT用户，PCDN也可参考使用，一般家用用第一种即可 添加queue type，为每个类型的流量添加一个type\n/queue type set 1 pfifo-limit=256 add fq-codel-flows=128 fq-codel-interval=30ms fq-codel-limit=128 fq-codel-memlimit=4096.0KiB fq-codel-quantum=512 fq-codel-target=3ms kind=fq-codel name=Fq_Codel_Dns_Up add fq-codel-flows=256 fq-codel-interval=30ms fq-codel-limit=128 fq-codel-memlimit=8.0MiB fq-codel-quantum=512 fq-codel-target=3ms kind=fq-codel name=Fq_Codel_Dns_Down add fq-codel-flows=512 fq-codel-interval=50ms fq-codel-limit=512 fq-codel-memlimit=8.0MiB fq-codel-quantum=512 kind=fq-codel name=Fq_Codel_Small_Up add fq-codel-flows=512 fq-codel-interval=50ms fq-codel-limit=512 fq-codel-memlimit=16.0MiB fq-codel-quantum=512 kind=fq-codel name=Fq_Codel_Small_Down add fq-codel-flows=512 fq-codel-interval=50ms fq-codel-limit=2048 fq-codel-memlimit=64.0MiB fq-codel-quantum=1400 kind=fq-codel name=Fq_Codel_Web_Up add fq-codel-interval=50ms fq-codel-limit=4096 fq-codel-memlimit=128.0MiB fq-codel-quantum=1500 kind=fq-codel name=Fq_Codel_Web_Down add fq-codel-limit=8192 fq-codel-memlimit=128.0MiB fq-codel-quantum=1400 fq-codel-target=8ms kind=fq-codel name=Fq_Codel_Pt_Up add fq-codel-flows=2048 fq-codel-limit=8192 fq-codel-memlimit=256.0MiB fq-codel-quantum=1500 fq-codel-target=8ms kind=fq-codel name=Fq_Codel_Pt_Down add fq-codel-flows=2048 fq-codel-limit=8192 fq-codel-memlimit=128.0MiB fq-codel-quantum=1400 fq-codel-target=20ms kind=fq-codel name=Fq_Codel_Nomark_Up add fq-codel-flows=4096 fq-codel-limit=8192 fq-codel-memlimit=256.0MiB fq-codel-quantum=1500 fq-codel-target=15ms kind=fq-codel name=Fq_Codel_Nomark_Down add fq-codel-flows=2048 fq-codel-limit=8192 fq-codel-memlimit=128.0MiB fq-codel-quantum=1500 kind=fq-codel name=Fq_Codel_Down add fq-codel-flows=2048 fq-codel-interval=50ms fq-codel-limit=4096 fq-codel-memlimit=64.0MiB fq-codel-quantum=1480 kind=fq-codel name=Fq_Codel_Up ipv4防火墙中使用mangle标记需设定优先级的流量 通过端口标记DNS流量 /ip firewall mangle add action=mark-packet chain=prerouting comment=DNS disabled=yes new-packet-mark=Dns-packet passthrough=no port=53 protocol=udp /ip firewall mangle add action=mark-packet chain=prerouting comment=DNS disabled=yes new-packet-mark=Dns-packet passthrough=no port=53,853 protocol=tcp /ip firewall mangle add action=mark-packet chain=forward comment=DNS disabled=yes new-packet-mark=Dns-packet passthrough=no port=53 protocol=udp /ip firewall mangle add action=mark-packet chain=forward comment=DNS disabled=yes new-packet-mark=Dns-packet passthrough=no port=53,853 protocol=tcp 通过端口标记WEB流量 /ip firewall mangle add action=mark-packet chain=prerouting comment=WEB disabled=yes new-packet-mark=Web-packet packet-mark=no-mark passthrough=no port=80,443,8080 protocol=tcp /ip firewall mangle add action=mark-packet chain=prerouting comment=WEB disabled=yes new-packet-mark=Web-packet packet-mark=no-mark passthrough=no port=80,443,8080 protocol=udp /ip firewall mangle add action=mark-packet chain=forward comment=WEB disabled=yes new-packet-mark=Web-packet packet-mark=no-mark passthrough=no port=80,443,8080 protocol=tcp /ip firewall mangle add action=mark-packet chain=forward comment=WEB disabled=yes new-packet-mark=Web-packet packet-mark=no-mark passthrough=no port=80,443,8080 protocol=udp 通过包大小标记小包流量 /ip firewall mangle add action=mark-packet chain=prerouting comment=SMALL connection-bytes=0-256000 disabled=yes new-packet-mark=Small-packet packet-mark=no-mark packet-size=0-512 passthrough=no /ip firewall mangle add action=mark-packet chain=forward comment=SMALL connection-bytes=0-256000 disabled=yes new-packet-mark=Small-packet packet-mark=no-mark packet-size=0-512 passthrough=no 通过mac地址或IP地址标记qb的流量，可同时标记2个qb，其上传及下载速度将加总后做限制 /ip firewall mangle add action=mark-connection chain=prerouting comment=qB-1 new-connection-mark=PT-conection src-address=10.0.0.55 /ip firewall mangle add action=mark-connection chain=prerouting comment=qB-2 new-connection-mark=PT-conection src-mac-address=02:42:0A:00:00:1F /ip firewall mangle add action=mark-packet chain=prerouting comment=PT connection-mark=PT-conection new-packet-mark=qBittorent_packet passthrough=no /ip firewall mangle add action=mark-connection chain=forward comment=qB-1 disabled=yes new-connection-mark=PT-conection src-address=10.0.0.55 /ip firewall mangle add action=mark-connection chain=forward comment=qB-2 disabled=yes new-connection-mark=PT-conection src-mac-address=02:42:0A:00:00:1F /ip firewall mangle add action=mark-packet chain=forward comment=PT connection-mark=PT-conection disabled=yes new-packet-mark=qBittorent_packet passthrough=no 建议根据截图重新排序 在ipv6中做相同的mangle，注意mark标记选择与v4时配置的一致 通过端口标记DNS流量 /ipv6 firewall mangle add action=mark-packet chain=prerouting comment=DNS disabled=yes new-packet-mark=Dns-packet passthrough=no port=53 protocol=udp /ipv6 firewall mangle add action=mark-packet chain=prerouting comment=DNS disabled=yes new-packet-mark=Dns-packet passthrough=no port=53,853 protocol=tcp /ipv6 firewall mangle add action=mark-packet chain=forward comment=DNS disabled=yes new-packet-mark=Dns-packet passthrough=no port=53 protocol=udp /ipv6 firewall mangle add action=mark-packet chain=forward comment=DNS disabled=yes new-packet-mark=Dns-packet passthrough=no port=53,853 protocol=tcp 通过端口标记WEB流量 /ipv6 firewall mangle add action=mark-packet chain=prerouting comment=WEB disabled=yes new-packet-mark=Web-packet packet-mark=no-mark passthrough=no port=80,443,8080 protocol=tcp /ipv6 firewall mangle add action=mark-packet chain=prerouting comment=WEB disabled=yes new-packet-mark=Web-packet packet-mark=no-mark passthrough=no port=80,443,8080 protocol=udp /ipv6 firewall mangle add action=mark-packet chain=forward comment=WEB disabled=yes new-packet-mark=Web-packet packet-mark=no-mark passthrough=no port=80,443,8080 protocol=tcp /ipv6 firewall mangle add action=mark-packet chain=forward comment=WEB disabled=yes new-packet-mark=Web-packet packet-mark=no-mark passthrough=no port=80,443,8080 protocol=udp 通过包大小标记小包流量 /ipv6 firewall mangle add action=mark-packet chain=prerouting comment=SMALL connection-bytes=0-256000 disabled=yes new-packet-mark=Small-packet packet-mark=no-mark packet-size=0-512 passthrough=no /ipv6 firewall mangle add action=mark-packet chain=forward comment=SMALL connection-bytes=0-256000 disabled=yes new-packet-mark=Small-packet packet-mark=no-mark packet-size=0-512 passthrough=no 通过mac地址或IP地址标记qb的流量，可同时标记2个qb，其上传及下载速度将加总后做限制量 /ipv6 firewall mangle add action=mark-connection chain=prerouting comment=qB-1 new-connection-mark=PT-conection src-address=dc00::1056 /ipv6 firewall mangle add action=mark-connection chain=prerouting comment=qB-2 new-connection-mark=PT-conection src-mac-address=02:42:0A:00:00:1F /ipv6 firewall mangle add action=mark-packet chain=prerouting comment=PT connection-mark=PT-conection new-packet-mark=qBittorent_packet passthrough=no /ipv6 firewall mangle add action=mark-connection chain=forward comment=qB-1 disabled=yes new-connection-mark=PT-conection src-address=dc00::1055 /ipv6 firewall mangle add action=mark-connection chain=forward comment=qB-2 disabled=yes new-connection-mark=PT-conection src-mac-address=02:42:0A:00:00:1F /ipv6 firewall mangle add action=mark-packet chain=forward comment=PT connection-mark=PT-conection disabled=yes new-packet-mark=qBittorent_packet passthrough=no 建议根据截图重新排序 在queue tree配置流量优先级。分别对up上行和down下行流量进行流控。上下行总带宽及各应用的优先级、允许的最大上下行，Burst Limit突发速率等需根据使用人具体情况逐步调试至最佳状况。 本例中，UP中的50M为宽带上传总上限，DOWN中400M为宽带下载总上限，其余各类型流量限速可自行调整 DNS流量优先级为1（最高），其次为小包流量优先级为2，WEB流量优先级为3，未被标记的兜底流量优先级为6，qBittorrent流量优先级为最低的7 /queue tree add bucket-size=0.05 max-limit=50M name=UP parent=wan queue=Fq_Codel_Up add bucket-size=0.005 max-limit=5M name=1_Dns_up packet-mark=Dns-packet parent=UP priority=1 queue=Fq_Codel_Dns_Up add bucket-size=0.01 max-limit=10M name=2_Small_up packet-mark=Small-packet parent=UP priority=2 queue=Fq_Codel_Small_Up add bucket-size=0.03 burst-limit=60M burst-threshold=10M burst-time=5s max-limit=55M name=3_Web_up packet-mark=Web-packet parent=UP priority=3 queue=Fq_Codel_Web_Up add burst-time=20s max-limit=55M name=6_Nomark_up packet-mark=no-mark parent=UP priority=6 queue=Fq_Codel_Nomark_Up add bucket-size=0.06 max-limit=50M name=7_qb_up packet-mark=qBittorent_packet parent=UP priority=7 queue=Fq_Codel_Pt_Up add bucket-size=0.05 max-limit=400M name=DOWN parent=lan queue=Fq_Codel_Down add bucket-size=0.005 limit-at=5M max-limit=5M name=1_Dns_down packet-mark=Dns-packet parent=DOWN priority=1 queue=Fq_Codel_Dns_Down add bucket-size=0.01 limit-at=10M max-limit=10M name=2_Small_down packet-mark=Small-packet parent=DOWN priority=2 queue=Fq_Codel_Small_Down add bucket-size=0.03 max-limit=400M name=3_Web_down packet-mark=Web-packet parent=DOWN priority=3 queue=Fq_Codel_Web_Down add max-limit=400M name=6_Nomark_down packet-mark=no-mark parent=DOWN priority=6 queue=Fq_Codel_Nomark_Down add bucket-size=0.06 max-limit=400M name=7_qb_down packet-mark=qBittorent_packet parent=DOWN priority=7 queue=Fq_Codel_Pt_Down ","permalink":"https://hanigege.github.io/posts/routers/04.routeros%E4%BD%BF%E7%94%A8queue_tree%E9%85%8D%E7%BD%AE%E6%B5%81%E9%87%8F%E6%95%B4%E5%BD%A2/","tags":null,"title":"04.RouterOS使用queue_tree配置流量整形"},{"categories":["routers"],"contents":"本文介绍使用 FakeIP 分流法实现局域网内设备透明代理时，主路由 RouterOS 部分的设置。 注意：sing-box 及 mosdns 的具体配置不在本文讨论范围内。 作者：Tom 环境设定 sing-box IP: IPv4 10.0.0.2, IPv6 dc00::2222 FakeIP 网段: IPv4 28.0.0.0/8, IPv6 f2b0::/18 注意: 开启 FastTrack 后 Mangle 会失效，建议使用 Route 或 Routing Rules 方式。 方案 1：使用 Mangle 打标签方式 IPv4 部分 添加sing-box-v4路由表： /routing table add name=sing-box-v4 fib 配置地址列表（地址列表中新增proxy_ipv4列表，填入fakeip网段、tg v4网段、奈菲v4网段）： /ip firewall address-list add list=proxy_ipv4 address=28.0.0.0/8 /ip firewall address-list add list=proxy_ipv4 address=1.1.1.1/32 /ip firewall address-list add list=proxy_ipv4 address=1.0.0.1/32 /ip firewall address-list add list=proxy_ipv4 address=8.8.8.8/32 /ip firewall address-list add list=proxy_ipv4 address=8.8.4.4/32 /ip firewall address-list add list=proxy_ipv4 address=8.41.4.0/24 /ip firewall address-list add list=proxy_ipv4 address=23.23.189.144/28 /ip firewall address-list add list=proxy_ipv4 address=23.246.0.0/18 /ip firewall address-list add list=proxy_ipv4 address=34.195.253.0/25 /ip firewall address-list add list=proxy_ipv4 address=37.77.184.0/21 /ip firewall address-list add list=proxy_ipv4 address=38.72.126.0/24 /ip firewall address-list add list=proxy_ipv4 address=45.57.0.0/17 /ip firewall address-list add list=proxy_ipv4 address=52.24.178.0/24 /ip firewall address-list add list=proxy_ipv4 address=52.35.140.0/24 /ip firewall address-list add list=proxy_ipv4 address=54.204.25.0/28 /ip firewall address-list add list=proxy_ipv4 address=54.213.167.0/24 /ip firewall address-list add list=proxy_ipv4 address=64.120.128.0/17 /ip firewall address-list add list=proxy_ipv4 address=66.197.128.0/17 /ip firewall address-list add list=proxy_ipv4 address=69.53.224.0/19 /ip firewall address-list add list=proxy_ipv4 address=103.87.204.0/22 /ip firewall address-list add list=proxy_ipv4 address=108.175.32.0/20 /ip firewall address-list add list=proxy_ipv4 address=185.2.220.0/22 /ip firewall address-list add list=proxy_ipv4 address=185.9.188.0/22 /ip firewall address-list add list=proxy_ipv4 address=192.173.64.0/18 /ip firewall address-list add list=proxy_ipv4 address=198.38.96.0/19 /ip firewall address-list add list=proxy_ipv4 address=198.45.48.0/20 /ip firewall address-list add list=proxy_ipv4 address=203.75.84.0/24 /ip firewall address-list add list=proxy_ipv4 address=203.198.13.0/24 /ip firewall address-list add list=proxy_ipv4 address=203.198.80.0/24 /ip firewall address-list add list=proxy_ipv4 address=207.45.72.0/22 /ip firewall address-list add list=proxy_ipv4 address=208.75.76.0/22 /ip firewall address-list add list=proxy_ipv4 address=210.0.153.0/24 /ip firewall address-list add list=proxy_ipv4 address=91.108.56.0/22 /ip firewall address-list add list=proxy_ipv4 address=91.108.4.0/22 /ip firewall address-list add list=proxy_ipv4 address=91.108.8.0/22 /ip firewall address-list add list=proxy_ipv4 address=91.108.16.0/22 /ip firewall address-list add list=proxy_ipv4 address=91.108.12.0/22 /ip firewall address-list add list=proxy_ipv4 address=149.154.160.0/20 /ip firewall address-list add list=proxy_ipv4 address=91.105.192.0/23 /ip firewall address-list add list=proxy_ipv4 address=91.108.20.0/22 /ip firewall address-list add list=proxy_ipv4 address=185.76.151.0/24 /ip firewall address-list add list=proxy_ipv4 address=95.161.64.0/20 为目的ip为proxy_ipv4地址列表的连接打上“sing-box-v4”标记： /ip firewall mangle add action=mark-routing chain=prerouting dst-address-list=proxy_ipv4 new-routing-mark=sing-box-v4 passthrough=yes 设置路由表sing-box-v4的下一跳网关为sing-box： /ip route add dst-address=0.0.0.0/0 gateway=10.0.0.2 routing-table=sing-box-v4 IPv6 部分 添加sing-box-v6路由表： /routing table add name=sing-box-v6 fib 地址列表添加添加fakev6及tg v6网段： /ipv6 firewall address-list add address=f2b0::/18 list=proxy_ipv6 /ipv6 firewall address-list add address=2001:b28:f23d::/48 list=proxy_ipv6 /ipv6 firewall address-list add address=2001:b28:f23f::/48 list=proxy_ipv6 /ipv6 firewall address-list add address=2001:67c:4e8::/48 list=proxy_ipv6 /ipv6 firewall address-list add address=2001:b28:f23c::/48 list=proxy_ipv6 /ipv6 firewall address-list add address=2a0a:f280::/32 list=proxy_ipv6 为目的ip为proxy_ipv6的连接打标记： /ipv6 firewall mangle add action=mark-routing chain=prerouting dst-address-list=proxy_ipv6 new-routing-mark=sing-box-v6 设置路由表sing-box-v6的下一跳网关为sing-box。注意gateway为sing-box的IPv6：\n/ipv6 route add dst-address=::/0 gateway=dc00::2222 routing-table=sing-box-v6 添加路由规则确保fakev6路由正常执行：\n/routing rule add action=lookup-only-in-table routing-mark=sing-box-v6 table=sing-box-v6 方案 2：直接在 /ip route 中添加静态路由 此方法通过直接指定目标网段的下一跳来实现，不依赖 Mangle。 下面命令未包含TG IP、奈菲IP，需要用可自行添加。此方法与第1种mangle标记法不冲突，例如可以FakeIP使用route，TG IP等依然使用mangle。\nipv4 /ip route add disabled=no dst-address=28.0.0.0/8 gateway=10.0.0.2 routing-table=main suppress-hw-offload=no /ip route add disabled=no distance=1 dst-address=8.8.8.8/32 gateway=10.0.0.2 routing-table=main scope=30 suppress-hw-offload=no target-scope=10 /ip route add disabled=no distance=1 dst-address=1.1.1.1/32 gateway=10.0.0.2 routing-table=main scope=30 suppress-hw-offload=no target-scope=10 /ip route add disabled=no distance=1 dst-address=8.8.4.4/32 gateway=10.0.0.2 routing-table=main scope=30 suppress-hw-offload=no target-scope=10 /ip route add disabled=no distance=1 dst-address=1.0.0.1/32 gateway=10.0.0.2 routing-table=main scope=30 suppress-hw-offload=no target-scope=10 ipv6 /ipv6 route add disabled=no distance=1 dst-address=f2b0::/18 gateway=dc00::2222 routing-table=main scope=30 suppress-hw-offload=no target-scope=10 方案 3：通过 /routing rules 配置（推荐） 这是博主目前使用的方法，最为简洁且不受 FastTrack 影响。\n添加sing-box-v4、sing-box-v6路由表： /routing table add name=sing-box-v4 fib /routing table add name=sing-box-v6 fib 设置路由表sing-box-v4、sing-box-v6的下一跳网关为sing-box： /ip route add dst-address=0.0.0.0/0 gateway=10.0.0.2 routing-table=sing-box-v4 /ipv6 route add dst-address=::/0 gateway=dc00::2222 routing-table=sing-box-v6 设置FakeIP、TG IP等IP的路由规则： /routing rule add action=lookup disabled=no dst-address=f2b0::/18 table=sing-box-v6 add action=lookup disabled=no dst-address=2001:b28:f23d::/48 table=sing-box-v6 add action=lookup disabled=no dst-address=2001:b28:f23f::/48 table=sing-box-v6 add action=lookup disabled=no dst-address=2001:67c:4e8::/48 table=sing-box-v6 add action=lookup disabled=no dst-address=2001:b28:f23c::/48 table=sing-box-v6 add action=lookup disabled=no dst-address=2a0a:f280::/32 table=sing-box-v6 add action=lookup disabled=no dst-address=1.1.1.1/32 table=sing-box-v4 add action=lookup disabled=no dst-address=1.0.0.1/32 table=sing-box-v4 add action=lookup disabled=no dst-address=192.168.31.0/24 table=sing-box-v4 add action=lookup disabled=no dst-address=8.8.8.8/32 table=sing-box-v4 add action=lookup disabled=no dst-address=8.8.4.4/32 table=sing-box-v4 add action=lookup disabled=no dst-address=8.41.4.0/24 table=sing-box-v4 add action=lookup disabled=no dst-address=45.12.89.152/32 table=sing-box-v4 add action=lookup disabled=no dst-address=104.19.192.175/32 table=sing-box-v4 add action=lookup disabled=no dst-address=23.23.189.144/28 table=sing-box-v4 add action=lookup disabled=no dst-address=23.246.0.0/18 table=sing-box-v4 add action=lookup disabled=no dst-address=34.195.253.0/25 table=sing-box-v4 add action=lookup disabled=no dst-address=37.77.184.0/21 table=sing-box-v4 add action=lookup disabled=no dst-address=38.72.126.0/24 table=sing-box-v4 add action=lookup disabled=no dst-address=45.57.0.0/17 table=sing-box-v4 add action=lookup disabled=no dst-address=52.24.178.0/24 table=sing-box-v4 add action=lookup disabled=no dst-address=52.35.140.0/24 table=sing-box-v4 add action=lookup disabled=no dst-address=54.204.25.0/28 table=sing-box-v4 add action=lookup disabled=no dst-address=54.213.167.0/24 table=sing-box-v4 add action=lookup disabled=no dst-address=64.120.128.0/17 table=sing-box-v4 add action=lookup disabled=no dst-address=66.197.128.0/17 table=sing-box-v4 add action=lookup disabled=no dst-address=69.53.224.0/19 table=sing-box-v4 add action=lookup disabled=no dst-address=103.87.204.0/22 table=sing-box-v4 add action=lookup disabled=no dst-address=108.175.32.0/20 table=sing-box-v4 add action=lookup disabled=no dst-address=185.2.220.0/22 table=sing-box-v4 add action=lookup disabled=no dst-address=185.9.188.0/22 table=sing-box-v4 add action=lookup disabled=no dst-address=192.173.64.0/18 table=sing-box-v4 add action=lookup disabled=no dst-address=198.38.96.0/19 table=sing-box-v4 add action=lookup disabled=no dst-address=198.45.48.0/20 table=sing-box-v4 add action=lookup disabled=no dst-address=203.75.84.0/24 table=sing-box-v4 add action=lookup disabled=no dst-address=203.198.13.0/24 table=sing-box-v4 add action=lookup disabled=no dst-address=203.198.80.0/24 table=sing-box-v4 add action=lookup disabled=no dst-address=207.45.72.0/22 table=sing-box-v4 add action=lookup disabled=no dst-address=208.75.76.0/22 table=sing-box-v4 add action=lookup disabled=no dst-address=210.0.153.0/24 table=sing-box-v4 add action=lookup disabled=no dst-address=91.108.56.0/22 table=sing-box-v4 add action=lookup disabled=no dst-address=91.108.4.0/22 table=sing-box-v4 add action=lookup disabled=no dst-address=91.108.8.0/22 table=sing-box-v4 add action=lookup disabled=no dst-address=91.108.16.0/22 table=sing-box-v4 add action=lookup disabled=no dst-address=91.108.12.0/22 table=sing-box-v4 add action=lookup disabled=no dst-address=149.154.160.0/20 table=sing-box-v4 add action=lookup disabled=no dst-address=28.0.0.0/8 table=sing-box-v4 add action=lookup disabled=no dst-address=91.108.20.0/22 table=sing-box-v4 add action=lookup disabled=no dst-address=91.105.192.0/23 table=sing-box-v4 add action=lookup disabled=no dst-address=95.161.64.0/20 table=sing-box-v4 add action=lookup disabled=no dst-address=185.76.151.0/24 table=sing-box-v4 ","permalink":"https://hanigege.github.io/posts/routers/03.routeros%E9%85%8D%E7%BD%AEfakeip/","tags":null,"title":"03.RouterOS配置FakeIP"},{"categories":["routers"],"contents":"本文介绍 RouterOS 如何开启 IPv6。以 **NAT6** 模式为例，IPv6 内网网段默认为 `dc00::/64`，RouterOS `bridge1` 的 IPv6 内网地址为 `dc00::1111/64`。 桥接接口 `bridge1`、拨号接口 `pppoe-out1` 名称若不同则自行替换。 作者：Tom 1. 开启 IPv6 模块 /ipv6 settings set disable-ipv6=no 2. 获取 IPv6 前缀 (Prefix) 从运营商处获取 IPv6 PD：\n/ipv6 dhcp-client add interface=pppoe-out1 pool-name=dhcpv6-gua-pool1 pool-prefix-length=60 request=prefix 3. 添加局域网 ULA 地址池 /ipv6 pool add name=dhcpv6-ula-pool1 prefix=dc00::/64 prefix-length=64 4. 配置接口地址 计算 EUI-64 地址：可使用 EUI-64 计算器，或直接使用 ::1,或使用上面计算得到的后缀（例如::BF24:12FF:FEE1:E81B）配置pppoe-out1的GUA地址 配置 PPPoE 接口 GUA 地址： /ipv6 address add address=::BF24:12FF:FEE1:E81B/64 from-pool=dhcpv6-gua-pool1 interface=pppoe-out1 配置 Bridge 接口 ULA 地址，默认dc00::1111（可自行修改）： /ipv6 address add address=dc00::1111/64 from-pool=dhcpv6-ula-pool1 interface=bridge1 5. 开启 NAT6 (源地址伪装) /ipv6 firewall nat add action=masquerade chain=srcnat src-address=dc00::/64 6. 配置邻居发现 (ND) 禁用默认 ND 配置，并新建配置。建议不广播 IPv6 DNS。\n/ipv6 nd set [ find default=yes ] advertise-dns=no disabled=yes /ipv6 nd add advertise-dns=no advertise-mac-address=no interface=bridge1 managed-address-configuration=yes other-configuration=yes ra-interval=5m-15m 7. IPv6 防火墙规则 因使用 NAT6，规则逻辑与 IPv4 类似，没有PSD。\n/ipv6 firewall filter add action=accept chain=forward in-interface=bridge1 add action=accept chain=input in-interface=bridge1 add action=accept chain=forward connection-state=established,related,untracked add action=accept chain=input connection-state=established,related add action=drop chain=input connection-state=invalid in-interface=pppoe-out1 # 允许必要的 ICMPv6 协议 add action=accept chain=input icmp-options=128:0-255 in-interface=pppoe-out1 protocol=icmpv6 add action=accept chain=input comment=\u0026#34;Allow Echo request (ping)\u0026#34; icmp-options=128:0-255 protocol=icmpv6 add action=accept chain=input comment=\u0026#34;Allow Echo reply\u0026#34; icmp-options=129:0-255 protocol=icmpv6 add action=accept chain=input comment=\u0026#34;Allow Router Solicitation\u0026#34; icmp-options=133:0-255 protocol=icmpv6 add action=accept chain=input comment=\u0026#34;Allow Router Advertisement\u0026#34; icmp-options=134:0-255 protocol=icmpv6 add action=accept chain=input comment=\u0026#34;Allow Neighbor Solicitation\u0026#34; icmp-options=135:0-255 protocol=icmpv6 add action=accept chain=input comment=\u0026#34;Allow Neighbor Advertisement\u0026#34; icmp-options=136:0-255 protocol=icmpv6 # 拦截其他来自 WAN 的内容 add action=drop chain=input comment=\u0026#34;Drop other ICMPv6 from WAN\u0026#34; in-interface=pppoe-out1 protocol=icmpv6 add action=drop chain=input dst-port=53,8291 in-interface=pppoe-out1 protocol=tcp add action=drop chain=input dst-port=53,8291 in-interface=pppoe-out1 protocol=udp 8. 调整 TCP MSS /ipv6 firewall mangle add action=change-mss chain=forward new-mss=clamp-to-pmtu protocol=tcp tcp-flags=syn /ipv6 firewall mangle add action=change-mss chain=output new-mss=clamp-to-pmtu protocol=tcp tcp-flags=syn 提示：配置完成后，访问 http://[2402:4e00:1013:e500:0:9671:f018:4947]（仅显示 IP 地址的测试页）验证连通性。\n","permalink":"https://hanigege.github.io/posts/routers/02.routeros%E5%BC%80%E5%90%AFipv6%E5%B9%B6%E9%85%8D%E7%BD%AE%E9%98%B2%E7%81%AB%E5%A2%99/","tags":null,"title":"02.RouterOS开启IPv6并配置防火墙"},{"categories":["routers"],"contents":"本文介绍 RouterOS 拨号、配置 DHCP 服务器、配置 DNS、开启 IPv4 防火墙等通网的基础配置。 桥接接口 `bridge1`、拨号接口 `pppoe-out1` 名称若不同则自行替换。 作者：Tom 1. PPPoE 拨号配置 手动配置 pppoe-out1 接口拨号：\nUser: 填入宽带账号 Password: 填入宽带密码 如果不使用运营商提供的 DNS，可不勾选 Use Peer DNS。 注：接口前出现 “R” 代表拨号成功。拨号成功后建议先禁用，待防火墙配置完毕后再开启！ 2. 配置 DHCP 服务器 DHCP IP 范围为 10.0.0.100-10.0.0.250，网关和 DNS 默认为 ROS。如果希望全局配置透明代理，dns-server 可配置为 mosdns。\n/ip pool add name=dhcpv4-pool1 ranges=10.0.0.100-10.0.0.250 /ip dhcp-server add name=dhcpv4-server1 interface=bridge1 address-pool=dhcpv4-pool1 lease-time=1d /ip dhcp-server network add address=10.0.0.0/24 gateway=10.0.0.1 dns-server=10.0.0.1 3. 配置 DNS 设置 ROS 的上游 DNS，此处先设置 223.5.5.5，也可自定义填入运营商分配的 DNS。\n/ip dns set servers=223.5.5.5 allow-remote-requests=yes max-concurrent-queries=4096 max-concurrent-tcp-sessions=512 cache-size=8192 cache-max-ttl=04:00:00 4. 配置动态源地址伪装 (NAT) 限制源 IP 为内网网段（注意子网掩码，建议将 WireGuard 使用网段包含其中）。\n/ip firewall nat add action=masquerade chain=srcnat comment=\u0026#34;defconf: masquerade IPv4\u0026#34; src-address=10.0.0.0/8 至此打开 pppoe 接口即可通网，但建议继续配置完防火墙再通网！\n5. 访问光猫（可选） 如果需要访问光猫，则为 WAN 口分配一个光猫同网段的 IP 地址（一般为 192.168.1.0/24）。注意 interface 为物理接口 WAN，不是拨号口。 6. IPv4 防火墙配置 规则源于 @Ron佬，建议根据实际需求调整。\n添加防火墙规则 /ip firewall filter add action=accept chain=forward in-interface=bridge1 /ip firewall filter add action=accept chain=input in-interface=bridge1 /ip firewall filter add action=accept chain=forward connection-state=established,related,untracked /ip firewall filter add action=accept chain=input connection-state=established,related /ip firewall filter add action=drop chain=input src-address-list=BlockIP in-interface=pppoe-out1 /ip firewall filter add action=drop chain=input connection-state=invalid in-interface=pppoe-out1 /ip firewall filter add action=drop chain=input protocol=icmp in-interface=pppoe-out1 ## 5391是Winbox登陆端口，可以加上想隐藏的端口。如果在NAT有映射，端口无法隐藏 /ip firewall filter add action=drop chain=input protocol=tcp dst-port=53,5391 in-interface=pppoe-out1 /ip firewall filter add action=drop chain=input protocol=udp dst-port=53,5391 in-interface=pppoe-out1 /ip firewall filter add action=add-src-to-address-list chain=input address-list=BlockIP address-list-timeout=1w protocol=tcp dst-port=!53,853,5391 tcp-flags=rst in-interface=pppoe-out1 psd=21,5s,3,1 /ip firewall filter add action=add-src-to-address-list chain=input address-list=BlockIP address-list-timeout=1w protocol=tcp dst-port=!53,853,5391 tcp-flags=syn in-interface=pppoe-out1 psd=21,5s,3,1 ## UDP协议 dst-port=!53,853,5391 可以加上wireguard端口，防止触发PSD，造成IP被Block /ip firewall filter add action=add-src-to-address-list chain=input address-list=BlockIP address-list-timeout=1w protocol=udp dst-port=!53,853,5391 in-interface=pppoe-out1 psd=21,5s,3,1 /ip firewall filter add action=drop chain=input src-address-list=BlockIP 调整 TCP MSS /ip firewall mangle add action=change-mss chain=forward protocol=tcp tcp-flags=syn new-mss=clamp-to-pmtu passthrough=yes /ip firewall mangle add action=change-mss chain=output protocol=tcp tcp-flags=syn new-mss=clamp-to-pmtu passthrough=yes 关闭非必要服务端口 /ip firewall service-port disable ftp /ip firewall service-port disable irc /ip firewall service-port disable pptp /ip firewall service-port disable rtsp /ip firewall service-port disable sip /ip firewall service-port disable tftp 注：防火墙配置完毕后，即可打开 pppoe 接口开始上网。\n","permalink":"https://hanigege.github.io/posts/routers/01.routeros%E8%81%94%E7%BD%91%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE%E5%8F%8Aipv4%E9%98%B2%E7%81%AB%E5%A2%99/","tags":null,"title":"01.RouterOS联网基本配置及IPv4防火墙"},{"categories":["routers"],"contents":" # 00.RouterOS 初始化及基础配置 作者：Tom 第一次进入 RouterOS 先恢复原厂设置，使用 Winbox 登录（通过 MAC 地址访问后台配置）。\n建议先配置防火墙，再开启 PPPoE 接口设置帐号密码联网：\n/system reset-configuration 确认接口并修改名称 确认网口功能（区分 lan、wan），并重命名为方便后续操作：\n/interface set ether1 name=lan /interface set ether2 name=wan 建立网桥（Bridge） 将所有 LAN 接口添加进桥（bridge）：\n/interface bridge add name=bridge1 /interface bridge port add bridge=bridge1 interface=lan 注：如果双网口，可不建bridge，直接使用lan口，并接入物理交换机。但为方便管理 并为后期vlan等虚拟接口并入bridge做准备，建议建立bridge。\n为 bridge1 和 wan 设置 IP 为bridge1设置IP。本教程以bridge1为例，即ros本机ip为10.0.0.1/24 ：\n/ip address add interface=bridge1 address=10.0.0.1/24 network=10.0.0.0 设置时区与 NTP 服务器 /system clock set time-zone-name=\u0026#34;Asia/Shanghai\u0026#34; /system clock manual set time-zone=+08:00 /system ntp client set enabled=yes servers=cn.pool.ntp.org,ntp1.aliyun.com,time1.cloud.tencent.com 关闭所有不需要的服务及端口，更改Winbox登陆端口为5391（可自定义），并开启仅允许内网访问，注意下方address=10.0.0.0/24修改为自己的内网网段 /ip smb set enabled=no /ip smb shares disable numbers=0 /ip ssh set forwarding-enabled=no /ip socks set enabled=no /ip upnp set enabled=no /ip proxy set enabled=no /ip service disable api /ip service disable api-ssl /ip service disable ftp /ip service disable ssh /ip service disable telnet /ip service disable www /ip service disable www-ssl /ip service set winbox port=5391 address=10.0.0.0/24 /tool bandwidth-server set enabled=no 创建管理员帐号并禁用默认账号 /user add name=用户名 password=密码 group=full address=10.0.0.0/24 禁用默认账户 /user disable admin 注意：请先确认新创建的用户名和密码可以正常登录，再禁用默认管理员帐号。\n修改端口后登陆时ip地址后注意加上5391端口 更新及授权加速服务器添加静态IP（可不操作，若后续更新慢可尝试添加） /ip dns static add address=45.12.89.152 name=upgrade.mikrotik.com type=A add address=45.12.89.152 name=licence.mikrotik.com type=A ","permalink":"https://hanigege.github.io/posts/routers/00.routeros%E5%88%9D%E5%A7%8B%E5%8C%96%E5%8F%8A%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE/","tags":null,"title":"00.RouterOS初始化及基础配置"},{"categories":["linux"],"contents":"说明：支持ipv4\u0026amp;ipv6,自动检测有无ipv6，添加mss.自动检测ssh端口等，很方便 成功的步骤与方法 nano iptables_manager.sh 直接复制并执行以下完整代码覆盖原脚本： cat \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; \u0026gt; iptables_manager.sh #!/bin/bash # ========================================================== # 脚本名称：高级防火墙管理工具 (Debian/Ubuntu 专属自适应版 V4.1) # 核心升级：基于软件和内核模块的深度智能检测，消除冗余规则 # ========================================================== gl_lv=\u0026#39;\\033[32m\u0026#39; gl_huang=\u0026#39;\\033[33m\u0026#39; gl_hong=\u0026#39;\\033[31m\u0026#39; gl_bai=\u0026#39;\\033[0m\u0026#39; root_use() { [ \u0026#34;$EUID\u0026#34; -ne 0 ] \u0026amp;\u0026amp; echo -e \u0026#34;${gl_huang}提示: ${gl_bai}需 root 权限运行！\u0026#34; \u0026amp;\u0026amp; exit 1 } check_deps() { if ! dpkg -l | grep -qw iptables-persistent; then echo -e \u0026#34;${gl_huang}检测到未安装持久化组件，正在自动安装...${gl_bai}\u0026#34; apt-get update DEBIAN_FRONTEND=noninteractive apt-get install -y iptables iptables-persistent netfilter-persistent echo -e \u0026#34;${gl_lv}依赖安装完成！${gl_bai}\u0026#34; sleep 1 fi } root_use check_deps if command -v ip6tables \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 \u0026amp;\u0026amp; ip addr 2\u0026gt;/dev/null | grep -q \u0026#34;inet6 .* global\u0026#34;; then CMDS=\u0026#34;iptables ip6tables\u0026#34; HAS_IPV6=true else CMDS=\u0026#34;iptables\u0026#34; HAS_IPV6=false fi save_rules() { echo -e \u0026#34;${gl_huang}正在持久化规则...${gl_bai}\u0026#34; mkdir -p /etc/iptables netfilter-persistent save \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 || { iptables-save \u0026gt; /etc/iptables/rules.v4 [ \u0026#34;$HAS_IPV6\u0026#34; == true ] \u0026amp;\u0026amp; ip6tables-save \u0026gt; /etc/iptables/rules.v6 } echo -e \u0026#34;${gl_lv}规则保存成功。${gl_bai}\u0026#34; } get_ssh_port() { local port=$(grep -i \u0026#34;^Port\u0026#34; /etc/ssh/sshd_config 2\u0026gt;/dev/null | awk \u0026#39;{print $2}\u0026#39; | head -n 1) [ -z \u0026#34;$port\u0026#34; ] \u0026amp;\u0026amp; port=22 echo \u0026#34;$port\u0026#34; } view_rules() { for cmd in $CMDS; do echo -e \u0026#34;\\n${gl_lv}=== $cmd filter 表状态 ===${gl_bai}\u0026#34; $cmd -L INPUT -n -v --line-numbers echo -e \u0026#34;${gl_huang}--- FORWARD 转发状态 ---${gl_bai}\u0026#34; $cmd -L FORWARD -n -v --line-numbers echo -e \u0026#34;${gl_huang}--- MSS 钳制状态 (mangle 表) ---${gl_bai}\u0026#34; $cmd -t mangle -L FORWARD -n -v --line-numbers done read -p \u0026#34;按回车继续...\u0026#34; } allow_port_flexible() { read -e -p \u0026#34;请输入要放行的端口号: \u0026#34; port [ -z \u0026#34;$port\u0026#34; ] \u0026amp;\u0026amp; return echo -e \u0026#34;1. TCP 2. UDP 3. 同时放行\u0026#34; read -p \u0026#34;选择 (1-3): \u0026#34; p_choice for cmd in $CMDS; do case $p_choice in 1) $cmd -I INPUT 4 -p tcp --dport \u0026#34;$port\u0026#34; -j ACCEPT ;; 2) $cmd -I INPUT 4 -p udp --dport \u0026#34;$port\u0026#34; -j ACCEPT ;; 3) $cmd -I INPUT 4 -p tcp --dport \u0026#34;$port\u0026#34; -j ACCEPT $cmd -I INPUT 4 -p udp --dport \u0026#34;$port\u0026#34; -j ACCEPT ;; esac done save_rules } block_ip() { read -e -p \u0026#34;输入要屏蔽的 IP: \u0026#34; tip [ -z \u0026#34;$tip\u0026#34; ] \u0026amp;\u0026amp; return if [[ \u0026#34;$tip\u0026#34; == *\u0026#34;:\u0026#34;* ]]; then if [ \u0026#34;$HAS_IPV6\u0026#34; == true ]; then ip6tables -I INPUT 1 -s \u0026#34;$tip\u0026#34; -j DROP else echo -e \u0026#34;${gl_hong}系统未开启 IPv6，无法添加该规则。${gl_bai}\u0026#34; sleep 2 return fi else iptables -I INPUT 1 -s \u0026#34;$tip\u0026#34; -j DROP fi save_rules } delete_rule() { echo -e \u0026#34;1. IPv4 (iptables)\u0026#34; [ \u0026#34;$HAS_IPV6\u0026#34; == true ] \u0026amp;\u0026amp; echo \u0026#34;2. IPv6 (ip6tables)\u0026#34; read -p \u0026#34;选择协议: \u0026#34; p_choice local cmd=\u0026#34;iptables\u0026#34; if [ \u0026#34;$p_choice\u0026#34; == \u0026#34;2\u0026#34; ] \u0026amp;\u0026amp; [ \u0026#34;$HAS_IPV6\u0026#34; == true ]; then cmd=\u0026#34;ip6tables\u0026#34; elif [ \u0026#34;$p_choice\u0026#34; == \u0026#34;2\u0026#34; ]; then echo -e \u0026#34;${gl_hong}系统不支持 IPv6。${gl_bai}\u0026#34; sleep 2 return fi $cmd -L INPUT -n --line-numbers read -p \u0026#34;输入要删除的 filter/INPUT 规则编号: \u0026#34; num [ -n \u0026#34;$num\u0026#34; ] \u0026amp;\u0026amp; $cmd -D INPUT \u0026#34;$num\u0026#34; \u0026amp;\u0026amp; save_rules } close_all_but_ssh() { local ssh_p=$(get_ssh_port) echo -e \u0026#34;${gl_huang}开始执行自适应深度加固...${gl_bai}\u0026#34; sysctl -w net.ipv4.ip_forward=1 \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 [ \u0026#34;$HAS_IPV6\u0026#34; == true ] \u0026amp;\u0026amp; sysctl -w net.ipv6.conf.all.forwarding=1 \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 || true for cmd in $CMDS; do $cmd -P INPUT ACCEPT $cmd -P FORWARD ACCEPT $cmd -L INPUT --line-numbers | grep -vE \u0026#34;ts-|DOCKER\u0026#34; | awk \u0026#39;/^[0-9]/ {print $1}\u0026#39; | sort -nr | xargs -r -I{} $cmd -D INPUT {} 2\u0026gt;/dev/null $cmd -F FORWARD $cmd -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT $cmd -A INPUT -i lo -j ACCEPT if $cmd -L ts-input \u0026gt;/dev/null 2\u0026gt;\u0026amp;1; then $cmd -D INPUT -j ts-input 2\u0026gt;/dev/null || true $cmd -I INPUT 3 -j ts-input fi $cmd -A INPUT -p tcp --dport \u0026#34;$ssh_p\u0026#34; -j ACCEPT # 规范 ICMP if [ \u0026#34;$cmd\u0026#34; == \u0026#34;iptables\u0026#34; ]; then $cmd -A INPUT -p icmp --icmp-type echo-request -m limit --limit 1/s --limit-burst 5 -j ACCEPT $cmd -A INPUT -p icmp --icmp-type 3 -j ACCEPT $cmd -A INPUT -p icmp --icmp-type 11 -j ACCEPT $cmd -A INPUT -p icmp -j DROP else for type in 2 133 134 135 136 137; do $cmd -A INPUT -p ipv6-icmp --icmpv6-type $type -j ACCEPT done $cmd -A INPUT -p ipv6-icmp --icmpv6-type echo-request -m limit --limit 1/s --limit-burst 5 -j ACCEPT $cmd -A INPUT -p ipv6-icmp -j DROP fi if $cmd -L ts-forward \u0026gt;/dev/null 2\u0026gt;\u0026amp;1; then $cmd -D FORWARD -j ts-forward 2\u0026gt;/dev/null || true $cmd -I FORWARD 1 -j ts-forward fi # 核心优化：智能环境检测 (检测软件安装状态而非网卡状态) if command -v docker \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 || command -v dockerd \u0026gt;/dev/null 2\u0026gt;\u0026amp;1; then $cmd -A FORWARD -i docker+ -j ACCEPT $cmd -A FORWARD -o docker+ -j ACCEPT fi if command -v tailscaled \u0026gt;/dev/null 2\u0026gt;\u0026amp;1; then $cmd -A FORWARD -i tailscale+ -j ACCEPT $cmd -A FORWARD -o tailscale+ -j ACCEPT fi if command -v wg \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 || lsmod | grep -q wireguard; then $cmd -A FORWARD -i wg+ -j ACCEPT $cmd -A FORWARD -o wg+ -j ACCEPT fi if command -v openvpn \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 || [ -c /dev/net/tun ]; then $cmd -A FORWARD -i tun+ -j ACCEPT $cmd -A FORWARD -o tun+ -j ACCEPT fi if command -v pppd \u0026gt;/dev/null 2\u0026gt;\u0026amp;1; then $cmd -A FORWARD -i ppp+ -j ACCEPT $cmd -A FORWARD -o ppp+ -j ACCEPT fi $cmd -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT $cmd -P INPUT DROP $cmd -P FORWARD DROP # 双栈 MSS 钳制 $cmd -t mangle -F FORWARD $cmd -t mangle -A FORWARD -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu 2\u0026gt;/dev/null || true done save_rules echo -e \u0026#34;${gl_lv}深度加固及 MSS 网络优化完成！冗余规则已清理。${gl_bai}\u0026#34; sleep 2 } open_all_ports() { for cmd in iptables ip6tables; do command -v $cmd \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 || continue $cmd -P INPUT ACCEPT $cmd -P FORWARD ACCEPT $cmd -P OUTPUT ACCEPT $cmd -F $cmd -X 2\u0026gt;/dev/null || true $cmd -t mangle -F FORWARD 2\u0026gt;/dev/null || true done save_rules echo -e \u0026#34;${gl_lv}防火墙已重置全开模式，MSS 钳制已清除。${gl_bai}\u0026#34; sleep 2 } iptables_panel() { while true; do clear echo -e \u0026#34;${gl_lv}===========================================${gl_bai}\u0026#34; echo -e \u0026#34; 高级防火墙管理 (Debian/Ubuntu 自适应版 V4.1) \u0026#34; echo -e \u0026#34; 当前 IPv6 状态: \\c\u0026#34; if [ \u0026#34;$HAS_IPV6\u0026#34; == true ]; then echo -e \u0026#34;${gl_lv}已启用${gl_bai}\u0026#34;; else echo -e \u0026#34;${gl_huang}未启用${gl_bai}\u0026#34;; fi echo -e \u0026#34;${gl_lv}===========================================${gl_bai}\u0026#34; echo \u0026#34; 1. 查看规则 (含 MSS 钳制状态)\u0026#34; echo \u0026#34; 2. 放行端口\u0026#34; echo \u0026#34; 3. 屏蔽地址\u0026#34; echo \u0026#34; 4. 删除规则\u0026#34; echo -e \u0026#34; 5. ${gl_hong}执行深度加固 (智能检测环境，拒绝冗余规则)${gl_bai}\u0026#34; echo -e \u0026#34; 6. ${gl_huang}紧急恢复全开 (重置所有策略)${gl_bai}\u0026#34; echo \u0026#34; 7. 手动持久化保存\u0026#34; echo \u0026#34; 0. 退出脚本\u0026#34; echo \u0026#34;-------------------------------------------\u0026#34; read -e -p \u0026#34;请选择: \u0026#34; choice case $choice in 1) view_rules ;; 2) allow_port_flexible ;; 3) block_ip ;; 4) delete_rule ;; 5) close_all_but_ssh ;; 6) open_all_ports ;; 7) save_rules; sleep 2 ;; 0) exit 0 ;; *) echo \u0026#34;无效选择\u0026#34;; sleep 1 ;; esac done } iptables_panel EOF chmod +x iptables_manager.sh ./iptables_manager.sh 使用注意 执行后选择 5，系统将只根据你真实安装的组件写入必需的转发规则。 ","permalink":"https://hanigege.github.io/posts/linux/ubuntu2026iptables+mss%E9%98%B2%E7%81%AB%E5%A2%99%E7%AE%A1%E7%90%86%E4%B8%80%E9%94%AE%E8%84%9A%E6%9C%AC/","tags":null,"title":"2026版Ubuntu\u0026Debian下iptables+mss防火墙管理一键脚本"},{"categories":["linux"],"contents":"\n安装 Neovim (\u003e= 0.10.0) 1. 安装neovim (Debian13\u0026amp;Ubuntu25.10+)(自动获取最新版，必须是默认 \u0026gt;= 0.10.x) apt update \u0026amp;\u0026amp; apt install neovim 验证版本信息 nvim --version | grep ^NVIM 如果是低版本系统，也可自行编译安装（最新版） # 1. 安装编译所必须的基础工具和系统依赖 sudo apt update sudo apt install ninja-build gettext cmake unzip curl build-essential git -y # 2. 拉取 Neovim 源码并切换到稳定版分支 (规避开发版的潜在 bug) git clone https://github.com/neovim/neovim.git ~/neovim-src cd ~/neovim-src git checkout stable # 3. 编译并全局安装 (利用多核加速) make CMAKE_BUILD_TYPE=Release -j$(nproc) sudo make install # 4. 清理路径缓存并验证版本 hash -r nvim -v 安装格式化与剪贴板依赖环境 要让 conform.nvim 成功调用 prettier，以及保证系统与 Neovim 之间的剪贴板交互顺畅，必须在操作系统层面安装以下工具：\n\u0026ndash;Debian13\u0026ndash;:\n2. 安装 Node.js 和 npm (提供运行环境), xclip (提供剪贴板支持) sudo apt update \u0026amp;\u0026amp; sudo apt install -y nodejs npm xclip 3. 全局安装 Prettier sudo npm install -g prettier 4. 清理旧环境 rm -rf ~/.config/nvim ~/.local/share/nvim ~/.local/state/nvim ~/.cache/nvim mkdir -p ~/.config/nvim 5. 写入配置 cat \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; \u0026gt; ~/.config/nvim/init.lua -- [基础设置] vim.g.mapleader = \u0026#34;;\u0026#34; local opt = vim.opt opt.number = true opt.relativenumber = true opt.cursorline = true opt.termguicolors = true opt.encoding = \u0026#34;utf-8\u0026#34; opt.mouse = \u0026#34;a\u0026#34; opt.timeoutlen = 300 opt.splitright = true opt.splitbelow = true -- [安装 lazy.nvim] local lazypath = vim.fn.stdpath(\u0026#34;data\u0026#34;) .. \u0026#34;/lazy/lazy.nvim\u0026#34; if not vim.loop.fs_stat(lazypath) then vim.fn.system({ \u0026#34;git\u0026#34;, \u0026#34;clone\u0026#34;, \u0026#34;--filter=blob:none\u0026#34;, \u0026#34;https://github.com/folke/lazy.nvim.git\u0026#34;, \u0026#34;--branch=stable\u0026#34;, lazypath, }) end vim.opt.rtp:prepend(lazypath) -- [插件配置] require(\u0026#34;lazy\u0026#34;).setup({ -- 1. 主题 (Onedark) { \u0026#34;navarasu/onedark.nvim\u0026#34;, lazy = false, priority = 1000, config = function() require(\u0026#34;onedark\u0026#34;).setup({ style = \u0026#39;dark\u0026#39; }) require(\u0026#34;onedark\u0026#34;).load() -- 护眼模式修复 local hl = vim.api.nvim_set_hl hl(0, \u0026#34;Normal\u0026#34;, { bg = \u0026#34;#1e2127\u0026#34;, fg = \u0026#34;#abb2bf\u0026#34; }) hl(0, \u0026#34;CursorLine\u0026#34;, { bg = \u0026#34;#2c313a\u0026#34; }) end }, -- 2. 文件树 (NvimTree) { \u0026#34;nvim-tree/nvim-tree.lua\u0026#34;, dependencies = { \u0026#34;nvim-tree/nvim-web-devicons\u0026#34; }, config = function() require(\u0026#34;nvim-tree\u0026#34;).setup({ view = { width = 30 }, renderer = { indent_markers = { enable = true } } }) end }, -- 3. 远程复制 (OSC 52) { \u0026#34;ojroques/nvim-osc52\u0026#34;, config = function() require(\u0026#39;osc52\u0026#39;).setup() vim.api.nvim_create_autocmd(\u0026#34;TextYankPost\u0026#34;, { callback = function() if vim.v.event.operator == \u0026#34;y\u0026#34; and vim.v.event.regname == \u0026#34;\u0026#34; then require(\u0026#39;osc52\u0026#39;).copy_register(\u0026#34;\u0026#34;) end end, }) end }, -- 4. 代码格式化 (Conform) { \u0026#34;stevearc/conform.nvim\u0026#34;, config = function() require(\u0026#34;conform\u0026#34;).setup({ formatters_by_ft = { json = { \u0026#34;prettier\u0026#34; }, yaml = { \u0026#34;prettier\u0026#34; }, html = { \u0026#34;prettier\u0026#34; }, css = { \u0026#34;prettier\u0026#34; }, javascript = { \u0026#34;prettier\u0026#34; }, typescript = { \u0026#34;prettier\u0026#34; }, }, format_on_save = { timeout_ms = 1000, lsp_fallback = true }, }) end } }) -- [快捷键映射] local map = vim.keymap.set -- 基础功能 map(\u0026#34;n\u0026#34;, \u0026#34;\u0026lt;leader\u0026gt;w\u0026#34;, \u0026#34;:w\u0026lt;CR\u0026gt;\u0026#34;, { silent = true }) map(\u0026#34;n\u0026#34;, \u0026#34;\u0026lt;leader\u0026gt;q\u0026#34;, \u0026#34;:q\u0026lt;CR\u0026gt;\u0026#34;, { silent = true }) map(\u0026#34;n\u0026#34;, \u0026#34;\u0026lt;CR\u0026gt;\u0026#34;, \u0026#34;:noh\u0026lt;CR\u0026gt;\u0026lt;CR\u0026gt;\u0026#34;, { silent = true }) -- 智能文件树来回切换 (;t) map(\u0026#34;n\u0026#34;, \u0026#34;\u0026lt;leader\u0026gt;t\u0026#34;, function() local view = require(\u0026#34;nvim-tree.view\u0026#34;) if view.is_visible() then if vim.api.nvim_get_current_win() == view.get_winnr() then vim.cmd(\u0026#34;wincmd p\u0026#34;) else vim.cmd(\u0026#34;NvimTreeFocus\u0026#34;) end else vim.cmd(\u0026#34;NvimTreeToggle\u0026#34;) end end, { silent = true }) -- 格式化 (;f) map({ \u0026#34;n\u0026#34;, \u0026#34;v\u0026#34; }, \u0026#34;\u0026lt;leader\u0026gt;f\u0026#34;, function() require(\u0026#34;conform\u0026#34;).format({ lsp_fallback = true, timeout_ms = 1000 }) print(\u0026#34;✨ Format executed\u0026#34;) end, { silent = true }) -- 窗口导航 map(\u0026#34;n\u0026#34;, \u0026#34;\u0026lt;C-h\u0026gt;\u0026#34;, \u0026#34;\u0026lt;C-w\u0026gt;h\u0026#34;) map(\u0026#34;n\u0026#34;, \u0026#34;\u0026lt;C-l\u0026gt;\u0026#34;, \u0026#34;\u0026lt;C-w\u0026gt;l\u0026#34;) map(\u0026#34;n\u0026#34;, \u0026#34;\u0026lt;C-j\u0026gt;\u0026#34;, \u0026#34;\u0026lt;C-w\u0026gt;j\u0026#34;) map(\u0026#34;n\u0026#34;, \u0026#34;\u0026lt;C-k\u0026gt;\u0026#34;, \u0026#34;\u0026lt;C-w\u0026gt;k\u0026#34;) EOF 配置完成后，输入 nvim 启动，按回车让它自动下载并部署所有插件即可。 核心特性 智能切换：使用 ;t 在文件树与代码之间来回跳转 格式化：;f 手动格式化，;w 保存时自动格式化，;q 退出 其它：和 vim 命令无异，支持跨终端复制粘贴，y 复制 ","permalink":"https://hanigege.github.io/posts/linux/debianmac%E4%B8%8Bnvim%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%85%A8%E5%AE%B6%E6%A1%B6%E5%AE%89%E8%A3%85/","tags":null,"title":"Debian下nvim格式化全家桶安装"},{"categories":["freebsd"],"contents":"\n一键执行脚本 curl -fsSL https://raw.githubusercontent.com/hanigege/scripts/main/pf_manager.sh -o pf_manager.sh \u0026amp;\u0026amp; sh pf_manager.sh ","permalink":"https://hanigege.github.io/posts/freebsd/freebsd15-pf-js/","tags":null,"title":"FreeBSD 15 PF 终极交互式管理脚本"},{"categories":["routers"],"contents":"vyos上配置wireguard （IPV4） 1. 生成 WireGuard 密钥 wg genkey | tee privatekey | wg pubkey \u0026gt; publickey • privatekey 文件中存储 私钥\n• publickey 文件中存储 公钥\n然后使用：\ncat privatekey 把私钥填入 第一步 的 \u0026lt;服务器私钥\u0026gt; 位置。\n配置wireguard:\nset interfaces wireguard wg0 address \u0026#39;10.20.30.1/24\u0026#39; set interfaces wireguard wg0 port \u0026#39;11133\u0026#39; set interfaces wireguard wg0 private-key \u0026#39;private-key\u0026#39; set interfaces wireguard wg0 peer iphone allowed-ips \u0026#39;10.20.30.2/32\u0026#39; set interfaces wireguard wg0 peer iphone public-key \u0026#39;public-key\u0026#39; set interfaces wireguard wg0 peer iphone preshared-key \u0026#39;preshared-key\u0026#39; 上面这是添加过peer的。\n如果让wg科学，下面接着操作：\n添加组： set firewall group network-group LAN-v4 network \u0026#39;10.20.20.0/24\u0026#39; # 内网段 set firewall group network-group LAN-v4 network \u0026#39;10.20.23.0/24\u0026#39; # wg网段 set firewall group ipv6-network-group LAN-v6 network \u0026#39;fd88::/64\u0026#39; 设置策略路由: 举例: 让wg0的流量走100号路由表, 100号路由表是sb的路由表 set policy route WG0-to-SB interface \u0026#39;wg0\u0026#39; set policy route WG0-to-SB rule 10 destination group network-group \u0026#39;!LAN-v4\u0026#39; set policy route WG0-to-SB rule 10 set table \u0026#39;100\u0026#39; # 这下面三条仅供参考，添加后电报容易断连。 set policy route6 WG0-to-SB interface \u0026#39;wg0\u0026#39; set policy route6 WG0-to-SB rule 10 destination group network-group \u0026#39;!LAN-v6\u0026#39; set policy route6 WG0-to-SB rule 10 set table \u0026#39;106\u0026#39; #路由表（之前添加过就不要重复添加） set protocols static table 100 route 0.0.0.0/0 next-hop 10.20.20.9 or set protocols static table 100 route 0.0.0.0/0 next-hop 172.23.0.99 set protocols static table 100 route 0.0.0.0/0 next-hop 192.168.100.9 set protocols static table 106 route6 ::/0 next-hop fd88::9999 ----- Happy Routing! 2.vyos上配置wireguard （IPV4）预共享密钥 配置 WireGuard 的 预共享密钥（Preshared Key，简称 PSK），可以为现有的公私钥握手再加一层加密，提升安全性。\n🧩 PSK 是什么？ 预共享密钥是在通信双方私下共享的额外密钥，用作对称加密（混淆 DH 密钥协商结果），提高抵抗量子计算破解的能力\n✅ 如何生成 PSK 在 VyOS 或客户端（都可以）执行：\nwg genpsk \u0026gt; psk.key 查看内容：\ncat psk.key 会输出一串 Base64 编码的密钥，比如：\nzT4XEDXe9qJpKRgqz0VjdRm2Vu+I+ZYoY7vI99aAv0Q= 🧩 在 VyOS 中添加 PSK 假设你已有如下 WireGuard 配置：\nset interfaces wireguard wg0 address \u0026#39;10.20.30.1/24\u0026#39; set interfaces wireguard wg0 port \u0026#39;51820\u0026#39; set interfaces wireguard wg0 peer iphone public-key \u0026#39;xxx...=\u0026#39; 加入 PSK 的命令如下：\nset interfaces wireguard wg0 peer iphone preshared-key \u0026#39;zT4XEDXe9qJpKRgqz0VjdRm2Vu+I+ZYoY7vI99aAv00= ","permalink":"https://hanigege.github.io/posts/routers/vyos-wireguard-ipv4/","tags":null,"title":"Vyos Wireguard Ipv4"},{"categories":["linux"],"contents":"\n安装这个程序主要是方便人在外面，连接自己服务器使用～ 可以理解为wireguard带web管理页面的。 pve下安装ubuntu或者debian 下载下面的主程序然后根据教程操作 wg-easy.zip\n安装教程 # vm ubuntu22.04测试通过，新版本注意下面改了个组件，即：npm@11.6.2 1、迁移代码 复制app文件夹到 /app cd /app 2、安装依赖 apt update apt install -y wireguard iptables curl -fsSL https://deb.nodesource.com/setup_22.x | sudo bash - sudo apt-get install -y nodejs sudo npm install -g npm@11.6.2 bcryptjs debug express-session h3 qrcode 3、配置环境 export NODE_PATH=/usr/lib/node_modules echo \u0026#34;export NODE_PATH=/usr/lib/node_modules\u0026#34; \u0026gt;\u0026gt; ~/.bashrc source ~/.bashrc npm audit fix 4、启用 IPv4 和 IPv6 转发 sudo sysctl -w net.ipv4.ip_forward=1 sudo sysctl -w net.ipv6.conf.all.forwarding=1 sudo bash -c \u0026#39;echo \u0026#34;net.ipv4.ip_forward = 1\u0026#34; \u0026gt;\u0026gt; /etc/sysctl.conf\u0026#39; sudo bash -c \u0026#39;echo \u0026#34;net.ipv6.conf.all.forwarding = 1\u0026#34; \u0026gt;\u0026gt; /etc/sysctl.conf\u0026#39; sudo sysctl -p 5、配置 systemd 服务 复制wg-easy.service到 /etc/systemd/system/ chmod +x /etc/systemd/system/wg-easy.service systemctl enable wg-easy.service systemctl start wg-easy.service systemctl status wg-easy.service 登录WebUI： http://ip:51821/ 详细参数请修改 /app/config.js # 如果报500错误的话 cd /app npm audit fix fd88::/64, 192.168.100.0/24, f2b0::/18, 198.18.0.0/15, 10.9.0.0/24, 91.108.56.0/22, 91.108.4.0/22, 91.108.8.0/22, 91.108.16.0/22, 91.108.12.0/22, 149.154.160.0/20, 91.105.192.0/23, 91.108.20.0/22, 185.76.151.0/24, 2001:67c:4e8::/48, 2001:b28:f23f::/48, 2a0a:f280::/32, 2001:b28:f23c::/48, 2001:b28:f23d::/48 上面的ip里修改相应的内网ip段及wg的ip段。\n比如我根据我的环境改的如下：\nfd88::/64, 10.20.20.0/24, f2b0::/18, 198.18.0.0/15, 10.8.0.0/24, fdcc:cafe:8888::/64, 91.108.56.0/22, 91.108.4.0/22, 91.108.8.0/22, 91.108.16.0/22, 91.108.12.0/22, 149.154.160.0/20, 91.105.192.0/23, 91.108.20.0/22, 185.76.151.0/24, 2001:67c:4e8::/48, 2001:b28:f23f::/48, 2a0a:f280::/32, 2001:b28:f23c::/48, 2001:b28:f23d::/48 等效于告诉客户端： 本地内网网段：10.20.20.0/24、fd88::/64\nWireGuard 网段：10.8.0.0/24、fdcc:cafe:8888::/64\n特殊路由网段：198.18.0.0/15（Fake IP）、f2b0::/18（Fake IP）、fe80::/64（链路本地，通常不需要加进去，WireGuard 本身会自动处理，这个上面IP已经删除，留下意思要知道注意了）\nTelegram IPv4/IPv6 地址段：所有 91.108.、149.154.160.0/20、185.76.151.0/24、2001:67c:4e8::/48、2001:b28:f23::/48、2a0a:f280::/32\n有几点注意： fe80::/64 一般不要放进 AllowedIPs，这是链路本地地址段，每个接口都必须有，放进去有可能导致客户端路由异常。\n0.0.0.0/0, ::/0 和你现在的写法是 互斥的：\n0.0.0.0/0, ::/0 = 全局代理，所有流量走隧道。\n指定网段列表 = 分流模式，只有这些网段才会走隧道。 你需要根据自己需求二选一。\n如果你是想做「只走 Telegram + 内网资源 + 测试网段 + WG 地址」，那就保留你写的列表，别加 0.0.0.0/0, ::/0。\n全局代理模式（所有流量走隧道） module.exports.WG_ALLOWED_IPS = \u0026#39;0.0.0.0/0, ::/0\u0026#39;; 分流模式（只走内网 + WireGuard 网段 + Telegram） module.exports.WG_ALLOWED_IPS = \u0026#39;10.20.20.0/24, fd88::/64, 10.8.0.0/24, fdcc:cafe:8888::/64, 198.18.0.0/15, f2b0::/18, 91.108.56.0/22, 91.108.4.0/22, 91.108.8.0/22, 91.108.16.0/22, 91.108.12.0/22, 91.105.192.0/23, 91.108.20.0/22, 149.154.160.0/20, 185.76.151.0/24, 2001:67c:4e8::/48, 2001:b28:f23f::/48, 2a0a:f280::/32, 2001:b28:f23c::/48, 2001:b28:f23d::/48\u0026#39;; 👉 这样客户端：\n访问权限说明 能访问内网资源（10.20.20.0/24, fd88::/64） 能走 WireGuard 私有网段通信（10.8.0.0/24, fdcc:cafe:8888::/64） 能访问 Telegram（相关 IPv4 + IPv6 段） 其他流量直连，不走隧道。 ⚠️ 我把 fe80::/64 去掉了，因为它是链路本地地址段，不能下发到客户端作为路由，否则可能导致系统路由冲突。\n","permalink":"https://hanigege.github.io/posts/linux/ck%E4%BD%AC%E7%9A%84wg-easy%E4%B8%80%E9%94%AE%E8%84%9A%E6%9C%AC%E7%A8%8B%E5%BA%8F/","tags":null,"title":"wg-Easy（wireguard可视管理）程序"},{"categories":["freebsd"],"contents":"FreeBSD15下配置服务器端Hysteria2 建议用root用户运行：\n特权端口限制：非 root 用户无法监听 1024 以下的端口（如 443）。 Hysteria2设置简单，性能强劲，强力推荐，只自己用，很方便。\n先到官网下载最新的for freebsd版 官网下载\n1. 安装hysteria fetch https://github.com/apernet/hysteria/releases/download/app%2Fv2.7.0/hysteria-freebsd-amd64 #下载目前最新的2.7.0版 mv hysteria-freebsd-amd64 hysteria #把文件改名成hysteria chmod +x hysteria #让文件可执行 mv hysteria /usr/local/bin #将文件移到相应目录 sysrc hysteria_enable=\u0026#34;YES\u0026#34; #设置开机启动 2. 自签证书： 以下是适配 FreeBSD 的高效执行步骤：\nmkdir -p /usr/local/etc/hysteria # 生成私钥与证书 bing.com也可以改为其它的 openssl req -x509 -nodes -newkey ec -pkeyopt ec_paramgen_curve:prime256v1 \\ -keyout /usr/local/etc/hysteria/server.key \\ -out /usr/local/etc/hysteria/server.crt \\ -subj \u0026#34;/CN=bing.com\u0026#34; -days 36500 # 修正权限 (FreeBSD 中 hysteria 用户组名通常也是 hysteria) root用户登录下面命令没有必要 # chown hysteria:hysteria /usr/local/etc/hysteria/server.key /usr/local/etc/hysteria/server.crt # 所有用户必须执行包括root,给证书权限 chmod 644 /usr/local/etc/hysteria/server.crt chmod 600 /usr/local/etc/hysteria/server.key Hysteria 服务配置提示 在 FreeBSD 上运行 Hysteria 时，请确保 /usr/local/etc/hysteria/config.yaml（或你的配置文件）引用了正确的路径：\ncert: /usr/local/etc/hysteria/server.crt key: /usr/local/etc/hysteria/server.key 注意： 由于你使用了自签名证书，客户端连接时必须开启 insecure: true 或配置对应的 ca 校验。\n3. 创建启动脚本 在 FreeBSD 中，仅仅把二进制文件放进去是不够的，必须编写一个符合 rc.subr 标准的启动脚本。\n创建启动脚本,并将脚本放到目录 /usr/local/etc/rc.d 中。系统默认没有这个脚本，我的脚本如下:\nnano /usr/local/etc/rc.d/hysteria #!/bin/sh # PROVIDE: hysteria # REQUIRE: NETWORKING # KEYWORD: shutdown . /etc/rc.subr name=\u0026#34;hysteria\u0026#34; rcvar=\u0026#34;hysteria_enable\u0026#34; load_rc_config $name : ${hysteria_enable:=\u0026#34;NO\u0026#34;} : ${hysteria_config:=\u0026#34;/usr/local/etc/hysteria/config.yaml\u0026#34;} : ${hysteria_log:=\u0026#34;/var/log/hysteria.log\u0026#34;} pidfile=\u0026#34;/var/run/${name}.pid\u0026#34; procname=\u0026#34;/usr/local/bin/hysteria\u0026#34; # 使用 daemon -f 确保进程完全后台化，-p 记录子进程真实 PID command=\u0026#34;/usr/sbin/daemon\u0026#34; command_args=\u0026#34;-f -p ${pidfile} -o ${hysteria_log} ${procname} server -c ${hysteria_config}\u0026#34; run_rc_command \u0026#34;$1\u0026#34; 赋予权限与创建日志 # 赋予执行权限 chmod +x /usr/local/etc/rc.d/hysteria # 创建并授权日志文件 touch /var/log/hysteria.log chmod 644 /var/log/hysteria.log 4. 添加配置文件config.yaml 将文件放到/usr/local/etc/hysteria/下\nnvim /usr/local/etc/hysteria/config.yaml （1）回家配置 listen: :33443 #监听端口 #使用自签证书 tls: cert: /usr/local/etc/hysteria/server.crt key: /usr/local/etc/hysteria/server.key auth: type: password password: 888888 #设置认证密码 masquerade: type: proxy proxy: url: https://bing.com #伪装网址 rewriteHost: true （2）标准配置 将文件放到/usr/local/etc/hysteria/下。\n# Hysteria 2 Server Config for FreeBSD 15 listen: :443 tls: cert: /usr/local/etc/hysteria/server.crt key: /usr/local/etc/hysteria/server.key auth: type: password password: \u0026#34;888888\u0026#34; bandwidth: up: 200 mbps down: 200 mbps masquerade: type: proxy proxy: url: https://bing.com/ rewriteHost: true （3）优化配置：（推荐） # Hysteria 2 Server Config for FreeBSD 15 listen: :443 tls: cert: /usr/local/etc/hysteria/server.crt key: /usr/local/etc/hysteria/server.key auth: type: password password: \u0026#34;888888\u0026#34; # 科学建议：在 FreeBSD 下，通过 ignoreClientBandwidth 让服务端更灵活 # 如果依然想限制，请保持 300 mbps，但务必配合我之前给你的 sysctl 内核优化 bandwidth: up: 300 mbps down: 300 mbps ignoreClientBandwidth: true # 根治 i/o timeout 的关键：指定可靠的国际 DNS resolver: type: udp udp: addr: 8.8.8.8:53 masquerade: type: proxy proxy: url: https://www.bing.com rewriteHost: true # 保持 80 端口关闭，不使用 listenHTTP，是最科学的避灾方式 quic: initStreamReceiveWindow: 8388608 # 8 MB maxStreamReceiveWindow: 8388608 # 8 MB initConnReceiveWindow: 20971520 # 20 MB maxConnReceiveWindow: 20971520 # 20 MB # 这里的日志等级设为 warn，减少无效信息堆积，仅保留关键错误 log: level: warn 5. 启动 # 启动 service hysteria start # 检查状态 (现在的 PID 会非常准确) service hysteria status # 查看日志确认运行情况 tail -f /var/log/hysteria.log 6. 添加rc.conf 里自启动项 FreeBSD 的脚本对变量名非常敏感。请确保你的 /etc/rc.conf 中配置的是：\nhysteria_enable=\u0026#34;YES\u0026#34; hysteria_config=\u0026#34;/usr/local/etc/hysteria/config.yaml\u0026#34; 7. 查看日志： tail -f /var/log/hysteria.log 8. 服务端系统优化 # 追加最优配置到 sysctl.conf cat \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; \u0026gt;\u0026gt; /etc/sysctl.conf kern.ipc.maxsockbuf=33554432 net.inet.udp.recvspace=8388608 net.inet.udp.maxdgram=65535 net.route.netisr_maxqlen=2048 net.inet.udp.blackhole=1 EOF # 3. 将只读变量写入 /boot/loader.conf echo \u0026#39;net.link.ifqmaxlen=\u0026#34;2048\u0026#34;\u0026#39; \u0026gt;\u0026gt; /boot/loader.conf # 热加载 sysctl 并重启 hysteria sysctl -f /etc/sysctl.conf service hysteria restart 完事！ ","permalink":"https://hanigege.github.io/posts/freebsd/freebsd%E5%AE%89%E8%A3%85hysteria2%E6%9C%8D%E5%8A%A1%E7%AB%AF/","tags":null,"title":"Freebsd安装Hysteria2服务端"},{"categories":["freebsd"],"contents":"前提是新编辑器已经安装 FreeBSD 下你可以通过设置环境变量 EDITOR 来更改 crontab -e 使用的默认编辑器。下面是几种常见方法：\n✅ 临时更改（当前 shell 有效） EDITOR=nano crontab -e 或者用其他你喜欢的编辑器，如：\nEDITOR=micro crontab -e EDITOR=ee crontab -e EDITOR=vim crontab -e ✅ 永久更改（加到 shell 启动文件） 如果你使用的是 sh 或 bash，可以将以下内容加到 ~/.profile 或 ~/.bashrc或 ~/bash_profile：\nexport EDITOR=nano 如果你使用的是 tcsh（FreeBSD 默认），请加到 ~/.cshrc 文件中：\nsetenv EDITOR nano 然后执行：\nsource ~/.cshrc 📦 补充提示：安装简易编辑器 如果你想用 nano 但系统没有，可以用 pkg 安装：\nsudo pkg install nano ","permalink":"https://hanigege.github.io/posts/freebsd/freebsd%E6%9B%B4%E6%94%B9%E9%BB%98%E8%AE%A4%E7%BC%96%E8%BE%91%E5%99%A8vi/","tags":null,"title":"Freebsd更改默认编辑器vi"},{"categories":["freebsd"],"contents":"IPFIREWALL (IPFW，IP 防火墙) 是一款由 FreeBSD 发起的防火墙应用软件，它由 FreeBSD 项目编写和维护。 ipfw 在基本系统的内核（GENERIC）作为可加载模块而存在。\n警告 IPFW 默认会有一条规则，规则号为 65535，是不可以删除的：这条规则会把所有流量都切断。故在未配置好防火墙前，请勿启动 IPFW，否则就会面临被阻挡在防火墙之外的麻烦。\n服务项 开机自动启动防火墙相应的内核模块：\n# sysrc firewall_enable=\u0026#34;YES\u0026#34; 参见 官方网址\n或者\n# service ipfw enable # 须重启后生效 保存所需编辑后，启动防火墙。要立即启用日志记录限制，还请设置sysctl上面指定的值：\n# service ipfw start 启动 ipfw：（启动前需要先添加放开22端口的规则，先执行下面的）\n# service ipfw start Firewall rules loaded. Firewall logging enabled. ifconfig: interface ipfw0 already exists Firewall logging pseudo-interface (ipfw0) created. 查看 ipfw 状态：\n# service ipfw status ipfw is enabled 其他 RC 配置\n# sysrc firewall_type=\u0026#34;open\u0026#34; # 允许任何访问。如果不这么做，会调用默认规则 65535——deny ip from any to any，拒绝所有 IP。你就只能去物理机上再操作了。基本等同于 net.inet.ip.fw.default_to_accept=\u0026#34;1\u0026#34; # sysrc firewall_script=\u0026#34;/usr/local/etc/ipfw.rules\u0026#34; # 指定 ipfw 规则的路径，在此处编辑规则 # sysrc firewall_logging=\u0026#34;YES\u0026#34; # 这样 ipfw 就可以打印日志 # sysrc firewall_logif=\u0026#34;YES\u0026#34; # 把日志打印到 `ipfw0` 这个设备里 sysrc firewall_type=\u0026quot;open\u0026quot; 设置后不会直接写入 allow ip from any to any 到配置文件。\n经测试，能控制防火墙全开放是：\n你把net.inet.ip.fw.default_to_accept=1放到/boot/loader.conf重启才能生效 ，手动改文件放进去。然后重启系统才能生效，会在配置文件里生成：allow ip from any to any # 注意此处\n或者：\nsysctl net.inet.ip.fw.default_to_accept=1 但系统启动时会加载等效的规则，作用就是完全开放防火墙。\n按上面的配置后的规则：\n# ipfw list 00100 allow ip from any to any via lo0 00200 deny ip from any to 127.0.0.0/8 00300 deny ip from 127.0.0.0/8 to any 00400 deny ip from any to ::1 00500 deny ip from ::1 to any 00600 allow ipv6-icmp from :: to ff02::/16 00700 allow ipv6-icmp from fe80::/10 to fe80::/10 00800 allow ipv6-icmp from fe80::/10 to ff02::/16 00900 allow ipv6-icmp from any to any icmp6types 1 01000 allow ipv6-icmp from any to any icmp6types 2,135,136 65000 allow ip from any to any # 注意此处 65535 deny ip from any to any 编辑 /usr/local/etc/ipfw.rules 文件 指定防火墙规则：\nipfw -q -f flush # -q 选项表示静默模式，避免输出冗余信息, 在我们开始之前清除列表。 cmd=\u0026#34;ipfw -q add\u0026#34; # ​定义一个变量 cmd，用于简化后续添加规则的命令。 # loopback $cmd 10 allow all from any to any via lo0 # 允许所有通过回环接口 lo0 的流量。 $cmd 20 deny all from any to 127.0.0.0/8 # 拒绝任何试图访问本地回环地址范围（127.0.0.0/8）的外部流量，防止伪造的回环地址通信。 $cmd 30 deny all from 127.0.0.0/8 to any # 拒绝来自回环地址范围的任何流量离开本地主机，进一步确保回环地址的安全性。 $cmd 40 deny tcp from any to any frag # ​拒绝所有分片的 TCP 数据包，有助于防范某些类型的攻击。 # statefull $cmd 50 check-state # 检查现有的会话状态，允许已建立的会话继续通信。 $cmd 60 allow tcp from any to any established # 允许所有已建立的 TCP 连接的数据包通过。 $cmd 70 allow all from any to any out keep-state # 允许所有向外的流量，并对其创建状态记录，以便响应流量能够自动通过。 $cmd 80 allow icmp from any to any # 允许所有 ICMP 数据包，支持网络诊断和错误报告功能。​ # open port for ssh $cmd 110 allow tcp from any to any 22 out # 允许所有向外的 SSH 流量 $cmd 120 allow tcp from any to any 22 in # 确保可以通过 SSH 访问该主机。 # open port for samba # 允许与 Samba 文件共享服务相关的端口（137-139 和 445）的进出流量，确保 Samba 服务正常运行。 $cmd 130 allow tcp from any to any 139 out $cmd 140 allow tcp from any to any 139 in $cmd 150 allow tcp from any to any 445 out $cmd 160 allow tcp from any to any 445 in $cmd 170 allow udp from any to any 137 out $cmd 180 allow udp from any to any 137 in $cmd 190 allow udp from any to any 138 out $cmd 200 allow udp from any to any 138 in # deny and log everything # 拒绝所有未明确允许的流量，并将其记录到日志中，便于审计和故障排查。 $cmd 500 deny log all from any to any 每一条规则的结构基本都是：\n# ipfw add [规则编号] ① [动作] [协议] from [源地址] to [目标地址] [其他条件] ① 按优先级排序，数字越小优先级越高，可优先覆盖相同的、数字大的规则。\n$cmd 500 deny log all from any to any ——\u0026gt; ipfw add 500 deny log all from any to any\n注意 `ipfw 命令是一次性的，它会在执行时即时生效，但不会永久保存规则。你须写入指定的规则文件。\n我们可以把默认拒绝的规则 65535 deny ip from any to any 改成默认允许`\n# echo net.inet.ip.fw.default_to_accept=\u0026#34;1\u0026#34; \u0026gt;\u0026gt; /boot/loader.conf 查看 ipfw 规则 # ipfw list 00100 allow ip from any to any via lo0 00200 deny ip from any to 127.0.0.0/8 00300 deny ip from 127.0.0.0/8 to any 00400 deny ip from any to ::1 00500 deny ip from ::1 to any 00600 allow ipv6-icmp from :: to ff02::/16 00700 allow ipv6-icmp from fe80::/10 to fe80::/10 00800 allow ipv6-icmp from fe80::/10 to ff02::/16 00900 allow ipv6-icmp from any to any icmp6types 1 01000 allow ipv6-icmp from any to any icmp6types 2,135,136 65535 allow ip from any to any # 注意此处是默认允许了，后面没了 ","permalink":"https://hanigege.github.io/posts/freebsd/freebsd-ipfirewallipfw/","tags":null,"title":"Freebsd-Ipfirewall(IPFW)防火墙介绍"},{"categories":["freebsd"],"contents":"在 pf.conf 中，PF 规则的顺序是非常严格的。正确的顺序应该是： options — 设置 PF 的全局选项。\nethernet — 设置网络接口。\nnormalization — 设置数据包的规范化。\nqueueing — 设置队列（可选）。\ntranslation — NAT 或 RDR 设置。\nfiltering — 包过滤规则。\nPF（Packet Filter，包过滤器）是一款由 OpenBSD 移植而来的防火墙，提供了大量功能，包括 ALTQ (Alternate Queuing，交错队列) 等。 启用 PF\n# kldload pf # ① 加载内核模块 # 示例文件作为默认配置规则集文件，否则 pf 无法启动 ② # cp /usr/share/examples/pf/pf.conf /etc/ # service pf enable # 设置 pf 开机启动 # service pf start # 启动 pf ① 如不做，则提示 pfctl: /dev/pf: No such file or directory。或者你重启再 service pf start。\n② 否则提示：\n/etc/rc.d/pf: WARNING: /etc/pf.conf is not readable. pfctl命令详解 pf 的管理命令为 pfctl，常用操作示例如下：\n# 启动 pf，相当于 service pf start # pfctl -e # 即禁止规则。几乎相当于 service pf stop（停止防火墙） # pfctl -d # 加载规则集文件中的规则 # pfctl -f /etc/pf.conf # 解析规则，但不加载。-f 参数还可以与其他参数配合，如 -N 表示只载入 NAT 规则，-R 表示只载入过滤规则，-A 只载入队列规则，-O 只载入选项规则 # pfctl -nf /etc/pf.conf # 查看 pf 所有对象信息。如果想查看特定对象信息，可以用 nat、queue、rules、Anchors、states、Sources、info、Running、labels、timeouts、memory、Tables、osfp、Interfaces 替换 all # pfctl -s all # 清理 pf 所有规则 # pfctl -F all 如果想查看特定规则，可以用 nat、queue、rules、states、Sources、info、Tables、osfp 替换 all。\n不过以上操作并没有对规则的管理，因此还需要修改规则集文件，常用示例如下：\n# 整理所有输入的数据 scrub in all # 拒绝所有访问 block all # 默认明示禁止所有访问。block 是动作，all 是从任何源到任何目标的简写，表示从源地址到目标地址。 # 放开回环接口的访问权限，回环接口不对外部 pass quick on lo0 all # quick 关键字表示若规则匹配，就停止执行，不会再执行后续规则 # 增加 TCP 协议访问 80 端口的规则，允许任何设备以 TCP 协议访问本机 80 端口 pass in quick proto tcp from any to 192.168.1.184 port 80 # proto tcp 是访问协议，port 80 是目标端口 # 允许回显信息给任何访问的设备 pass out quick proto tcp from 192.168.1.184 port 80 to any # 允许本机向外发送 80 端口的响应 # 增加 80 端口到 8080 端口流量转发的规则 rdr pass on em0 inet proto tcp from any to 192.168.1.184 port 80 -\u0026gt; 192.168.1.166 port 8080 # 转发流量到内网地址 192.168.1.166 端口 8080 # 允许本机与外部设备互 ping pass quick inet proto icmp all icmp-type 8 code 0 # icmp-type 8 是查询请求，code 0 表示返回码为 0 # 允许 traceroute 命令以 ICMP 协议执行 pass out quick inet proto icmp from 192.168.1.184 to any icmp-type 11 code 0 # icmp-type 11 用于时间超时 # 允许 traceroute 使用 UDP 协议执行，端口号从 33434 开始 pass out quick proto udp from 192.168.1.184 to any port 33434 \u0026gt;\u0026lt; 34500 # 默认 UDP 协议，端口号从 33434 开始，每转发一次端口号加 1 可能用到的规则集文件 /etc/pf.conf 如下： # 流量整形 scrub in all # 转发规则 rdr pass on em0 inet proto tcp from any to 192.168.1.184 port 8080 -\u0026gt; 192.168.1.184 port 80 # 注意规则次序，根据 pf.conf 规则，转发规则应位于过滤规则之前，相关内容请参考帮助 # 过滤规则 block all pass quick on lo0 all # 阻止所有流量，但允许回环接口（lo0）上的流量 # 设置任何设备可以访问服务器的 22、80、443、4200、10000 端口 pass in quick proto tcp from any to 192.168.1.184 port { 22, 80, 443, 4200, 10000 } # 设置服务器可以访问外部设备的 22、80、443、4200、10000 端口 pass out quick proto tcp from 192.168.1.184 port { 22, 80, 443, 4200, 10000 } to any # 设置服务器访问任何网络设备的 80、443 端口，并保持状态 pass out quick proto tcp from 192.168.1.184 to any port { 80, 443 } keep state # 设置服务器访问 DNS 服务器（UDP 端口 53） pass out quick proto udp from any to any port 53 keep state # 设置服务器访问 DHCP 服务器（UDP 端口 67） pass out quick proto udp from any to any port 67 keep state # 允许服务器发送 ICMP 请求 pass quick inet proto icmp all icmp-type 8 code 0 # 允许服务器发送 ICMP 超时消息（TTL 超过） pass out quick inet proto icmp from 192.168.1.184 to any icmp-type 11 code 0 # 允许服务器访问 UDP 范围端口 33434 到 34500 pass out quick proto udp from 192.168.1.184 to any port 33434 \u0026gt;\u0026lt; 34500 保存文件，接下来在终端执行命令：\n# 加载规则集文件中的规则 就可以看到效果了。 # pfctl -Fa -f /etc/pf.conf ----------------------------------------------------------------\n要取消（卸载）已经加载的内核模块 pf，可以使用 kldunload 命令。具体操作如下： kldunload pf 解释： kldunload pf 会卸载已加载的 pf（Packet Filter）内核模块。如果这个模块正在被使用（例如，配置了防火墙规则），卸载时可能会产生一些影响。\n请确保在卸载模块前没有相关服务或规则在运行。\n查看当前加载的内核模块： 你可以通过以下命令查看当前加载的内核模块：\nkldstat 这会列出当前加载的所有内核模块，包括 pf。\n注意： 如果你希望在系统重启后不再加载 pf 模块，可以移除相关的配置文件中的 kldload pf 指令，例如 /etc/rc.conf 文件中的设置。\n","permalink":"https://hanigege.github.io/posts/freebsd/freebsd-packet-filterpf%E9%98%B2%E7%81%AB%E5%A2%99%E4%BB%8B%E7%BB%8D/","tags":null,"title":"Freebsd-Packet-Filter（PF）防火墙介绍"},{"categories":["freebsd"],"contents":"在 FreeBSD 上编译并安装 sing-box，可以按照以下步骤进行操作。我们将使用 git 拉取源代码并编译，以下是详细步骤： 1. 安装依赖工具 首先，你需要安装一些基础工具，例如 git 和 go（Go 语言环境），以便能编译和构建 sing-box。\npkg update pkg install git 点击安装最新版本go1.23.1\n2. 获取 Sing-Box 源代码 然后，使用 git 克隆 sing-box 的源码库：\n# 下面是root用户安装 mkdir /usr/local/opt git clone https://github.com/SagerNet/sing-box.git /usr/local/opt/sing-box cd /usr/local/opt/sing-box # 下面是普通用户安装，只能安装本级目录下~/ mkdir .usr/local/opt git clone https://github.com/SagerNet/sing-box.git .usr/local/opt/sing-box cd .usr/local/opt/sing-box 3. 编译 Sing-Box 确保你的系统上安装了 Go 语言环境后，运行以下命令来编译 sing-box：\n# 执行构建，没有任何输出就是构建完 go build -tags \u0026#34;with_quic with_dhcp with_wireguard with_utls with_acme with_clash_api with_gvisor with_grpc with_v2ray_api\u0026#34; ./cmd/sing-box # 这会编译 sing-box 并启用 QUIC协议支持。 # 你现在应该可以在当前目录看到可执行文件了 ls -lh sing-box # 如果你还想把它安装到系统路径中，可以执行（需要 root 权限）： sudo install -m 755 sing-box /usr/local/bin/sing-box # 普通用户执行 go build -tags \u0026#34;with_quic with_dhcp with_wireguard with_utls with_acme with_clash_api with_gvisor with_grpc with_v2ray_api\u0026#34; ./cmd/sing-box # 这会编译 sing-box 并启用 QUIC协议支持。 # 你现在应该可以在当前目录看到可执行文件了 ls -lh sing-box # 我装在了之前go的bin文件夹里，可以执行： install -m 755 sing-box ~/.usr/local/opt/go/bin/sing-box 或者：（明白原理，装哪里就随心所欲了） 如果你是 普通用户（非 root）并想不使用 sudo 安装 sing-box，可以将其安装到你自己的 $HOME 目录下的 bin/ 子目录中，这是 Unix 系统常用的做法之一。\n✅ 推荐做法：\nmkdir -p ~/bin install -m 755 sing-box ~/bin/sing-box 这会将 sing-box 安装到你的 ~/bin/ 目录下。\n✅ 添加到 PATH（如果还没添加）\n如果你尚未把 ~/bin 加入环境变量 PATH，请在你的 shell 配置文件里加一句：\n对于 bash：(装好bash就用这个）\necho \u0026#39;export PATH=\u0026#34;$HOME/bin:$PATH\u0026#34;\u0026#39; \u0026gt;\u0026gt; ~/.bash_profile source ~/.bash_profile 对于 tcsh（FreeBSD 默认）：\necho \u0026#39;setenv PATH \u0026#34;$HOME/bin:$PATH\u0026#34;\u0026#39; \u0026gt;\u0026gt; ~/.cshrc source ~/.cshrc 对于 zsh：\necho \u0026#39;export PATH=\u0026#34;$HOME/bin:$PATH\u0026#34;\u0026#39; \u0026gt;\u0026gt; ~/.zshrc source ~/.zshrc 🔍 验证安装\nwhich sing-box sing-box version 确认输出正确版本信息即可。\n4. 配置 Sing-Box 你需要配置 sing-box，通常可以将配置文件放置在 ~/.config/sing-box/ 或 /usr/local/etc/sing-box/ 目录下。你可以在 sing-box 配置文件文档 中找到详细的配置说明。\n创建配置目录：\n# root用户 mkdir -p /usr/local/etc/sing-box \u0026amp;\u0026amp; echo \u0026#34;{}\u0026#34; \u0026gt; /usr/local/etc/sing-box/config.json # 普通用户 mkdir -p ~/.usr/local/etc/sing-box \u0026amp;\u0026amp; echo \u0026#34;{}\u0026#34; \u0026gt; ~/.usr/local/etc/sing-box/config.json 将配置文件放到该目录下，或者根据实际情况自定义配置。\nsocks配置实例： { \u0026#34;log\u0026#34;: { \u0026#34;disabled\u0026#34;: false, \u0026#34;level\u0026#34;: \u0026#34;info\u0026#34;, \u0026#34;timestamp\u0026#34;: true }, \u0026#34;dns\u0026#34;: { \u0026#34;servers\u0026#34;: [ { \u0026#34;tag\u0026#34;: \u0026#34;alidns\u0026#34;, \u0026#34;address\u0026#34;: \u0026#34;https://223.5.5.5/dns-query\u0026#34;, \u0026#34;strategy\u0026#34;: \u0026#34;ipv4_only\u0026#34;, \u0026#34;detour\u0026#34;: \u0026#34;direct\u0026#34; }, { \u0026#34;tag\u0026#34;: \u0026#34;cloudflare\u0026#34;, \u0026#34;address\u0026#34;: \u0026#34;https://1.1.1.1/dns-query\u0026#34;, \u0026#34;strategy\u0026#34;: \u0026#34;ipv4_only\u0026#34;, \u0026#34;detour\u0026#34;: \u0026#34;proxy\u0026#34; }, { \u0026#34;tag\u0026#34;: \u0026#34;block\u0026#34;, \u0026#34;address\u0026#34;: \u0026#34;rcode://success\u0026#34; } ], \u0026#34;rules\u0026#34;: [ { \u0026#34;outbound\u0026#34;: [ \u0026#34;any\u0026#34; ], \u0026#34;server\u0026#34;: \u0026#34;alidns\u0026#34; }, { \u0026#34;domain_suffix\u0026#34;: [ \u0026#34;.cn\u0026#34; ], \u0026#34;server\u0026#34;: \u0026#34;alidns\u0026#34; }, { \u0026#34;rule_set\u0026#34;: [ \u0026#34;geosite-cn\u0026#34; ], \u0026#34;server\u0026#34;: \u0026#34;alidns\u0026#34; }, { \u0026#34;rule_set\u0026#34;: [ \u0026#34;geosite-category-ads-all\u0026#34; ], \u0026#34;server\u0026#34;: \u0026#34;block\u0026#34; } ], \u0026#34;final\u0026#34;: \u0026#34;cloudflare\u0026#34;, \u0026#34;strategy\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;disable_cache\u0026#34;: false, \u0026#34;disable_expire\u0026#34;: false }, \u0026#34;inbounds\u0026#34;: [ { \u0026#34;type\u0026#34;: \u0026#34;socks\u0026#34;, \u0026#34;tag\u0026#34;: \u0026#34;socks-in\u0026#34;, \u0026#34;listen\u0026#34;: \u0026#34;0.0.0.0\u0026#34;, \u0026#34;listen_port\u0026#34;: 1080, \u0026#34;users\u0026#34;: [ ] } ], \u0026#34;outbounds\u0026#34;: [ { \u0026#34;tag\u0026#34;: \u0026#34;proxy\u0026#34;, \u0026#34;server\u0026#34;: \u0026#34;167.232\u0026#34;, // 改地址 \u0026#34;server_port\u0026#34;: 449, //改端口 \u0026#34;up_mbps\u0026#34;: 50, \u0026#34;down_mbps\u0026#34;: 500, \u0026#34;type\u0026#34;: \u0026#34;hysteria2\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;iry\u0026#34;, //改密码 \u0026#34;tls\u0026#34;: { \u0026#34;insecure\u0026#34;: true, \u0026#34;enabled\u0026#34;: true, \u0026#34;server_name\u0026#34;: \u0026#34;bing.com\u0026#34; }, \u0026#34;tcp_fast_open\u0026#34;: false }, { \u0026#34;type\u0026#34;: \u0026#34;direct\u0026#34;, \u0026#34;tag\u0026#34;: \u0026#34;direct\u0026#34; } ], \u0026#34;route\u0026#34;: { \u0026#34;rules\u0026#34;: [ { \u0026#34;action\u0026#34;: \u0026#34;sniff\u0026#34; }, { \u0026#34;protocol\u0026#34;: \u0026#34;dns\u0026#34;, \u0026#34;action\u0026#34;: \u0026#34;hijack-dns\u0026#34; }, { \u0026#34;ip_is_private\u0026#34;: true, \u0026#34;outbound\u0026#34;: \u0026#34;direct\u0026#34; }, { \u0026#34;domain_suffix\u0026#34;: [ \u0026#34;.cn\u0026#34; ], \u0026#34;outbound\u0026#34;: \u0026#34;direct\u0026#34; }, { \u0026#34;rule_set\u0026#34;: [ \u0026#34;geoip-cn\u0026#34;, \u0026#34;geosite-cn\u0026#34;, \u0026#34;geosite-private\u0026#34; ], \u0026#34;outbound\u0026#34;: \u0026#34;direct\u0026#34; }, { \u0026#34;rule_set\u0026#34;: [ \u0026#34;geosite-category-ads-all\u0026#34; ], \u0026#34;action\u0026#34;: \u0026#34;reject\u0026#34; } ], \u0026#34;rule_set\u0026#34;: [ { \u0026#34;tag\u0026#34;: \u0026#34;geoip-cn\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;remote\u0026#34;, \u0026#34;format\u0026#34;: \u0026#34;binary\u0026#34;, \u0026#34;url\u0026#34;: \u0026#34;https://raw.githubusercontent.com/SagerNet/sing-geoip/rule-set/geoip-cn.srs\u0026#34;, \u0026#34;download_detour\u0026#34;: \u0026#34;proxy\u0026#34; }, { \u0026#34;tag\u0026#34;: \u0026#34;geosite-cn\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;remote\u0026#34;, \u0026#34;format\u0026#34;: \u0026#34;binary\u0026#34;, \u0026#34;url\u0026#34;: \u0026#34;https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-cn.srs\u0026#34;, \u0026#34;download_detour\u0026#34;: \u0026#34;proxy\u0026#34; }, { \u0026#34;tag\u0026#34;: \u0026#34;geosite-private\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;remote\u0026#34;, \u0026#34;format\u0026#34;: \u0026#34;binary\u0026#34;, \u0026#34;url\u0026#34;: \u0026#34;https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-private.srs\u0026#34;, \u0026#34;download_detour\u0026#34;: \u0026#34;proxy\u0026#34; }, { \u0026#34;tag\u0026#34;: \u0026#34;geosite-category-ads-all\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;remote\u0026#34;, \u0026#34;format\u0026#34;: \u0026#34;binary\u0026#34;, \u0026#34;url\u0026#34;: \u0026#34;https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-category-ads-all.srs\u0026#34;, \u0026#34;download_detour\u0026#34;: \u0026#34;proxy\u0026#34; } ], \u0026#34;auto_detect_interface\u0026#34;: true, \u0026#34;final\u0026#34;: \u0026#34;proxy\u0026#34; }, \u0026#34;experimental\u0026#34;: { \u0026#34;cache_file\u0026#34;: { \u0026#34;enabled\u0026#34;: true, \u0026#34;path\u0026#34;: \u0026#34;cache.db\u0026#34;, \u0026#34;cache_id\u0026#34;: \u0026#34;mycacheid\u0026#34;, \u0026#34;store_fakeip\u0026#34;: true } } } 6. 运行 Sing-Box 配置好后，可以通过以下命令启动 sing-box：\n# root用户 sing-box run -C /usr/local/etc/sing-box/ # 普通用户 sing-box run -C ~/.usr/local/etc/sing-box/ 7. root用户下设置为服务（可选） 如果你希望将 sing-box 设置为系统服务，方便开机启动，你可以创建一个服务脚本。以下是一个简单的 rc.d 服务脚本示例：\n创建服务脚本文件 /usr/local/etc/rc.d/sing-box：\nnano /usr/local/etc/rc.d/sing-box 添加以下内容：\n有重定向日志功能 #!/bin/sh # # PROVIDE: sing_box # REQUIRE: NETWORKING # KEYWORD: shutdown . /etc/rc.subr name=\u0026#34;sing_box\u0026#34; rcvar=sing_box_enable command=\u0026#34;/usr/local/bin/sing-box\u0026#34; pidfile=\u0026#34;/var/run/${name}.pid\u0026#34; command_args=\u0026#34;run -C /usr/local/etc/sing-box/ \u0026gt;\u0026gt; /var/log/singbox.log 2\u0026gt;\u0026amp;1 \u0026amp; echo \\$! \u0026gt; ${pidfile}\u0026#34; load_rc_config $name : ${sing_box_enable:=\u0026#34;NO\u0026#34;} run_rc_command \u0026#34;$1\u0026#34; 无日志重定向版本： #!/bin/sh # # PROVIDE: sing_box # REQUIRE: NETWORKING # KEYWORD: shutdown . /etc/rc.subr name=\u0026#34;sing_box\u0026#34; rcvar=sing_box_enable command=\u0026#34;/usr/local/bin/sing-box\u0026#34; pidfile=\u0026#34;/var/run/${name}.pid\u0026#34; command_args=\u0026#34;run -C /usr/local/etc/sing-box/ \u0026amp; echo \\$! \u0026gt; ${pidfile}\u0026#34; load_rc_config $name : ${sing_box_enable:=\u0026#34;NO\u0026#34;} run_rc_command \u0026#34;$1\u0026#34; load_rc_config $name 用于加载服务的配置文件，而 ${sing_box_enable:=\u0026quot;NO\u0026quot;} 是为变量设置默认值。这里的逻辑是：\n⦁ 必须添加：否则在 sing_box_enable 未明确设置为 YES 时，脚本会因变量缺失导致启动失败（如 /etc/rc 错误提示）\n设置脚本为可执行： chmod +x /usr/local/etc/rc.d/sing-box 启用服务：\nsysrc sing_box_enable=YES 启动服务：\nservice sing-box start 检查服务状态 你可以通过以下命令检查服务状态： service sing-box status 普通用户启动管理（可选） FreeBSD 下的普通用户可以为放在用户目录下的 sing-box 设置用户级别的启动服务，更标准做法是使用 cron @reboot 或 login.conf 启动机制。 不过，FreeBSD 并不像 Linux（有 systemd 的 \u0026ndash;user 模式）那样对用户服务支持那么标准化，但你可以使用以下两种方式实现：\n✅ 方法一：使用 crontab 实现开机自启\n# 系统默认的是vi crontab -e # 临时指定vim打开crontab -e EDITOR=vim crontab -e 添加如下内容（确保 sing-box 可执行）：\n@reboot sh -c \u0026#39;$HOME/.usr/local/opt/go/bin/sing-box run -c $HOME/.usr/local/etc/sing-box/config.json \u0026gt; $HOME/.sing-box.log 2\u0026gt;\u0026amp;1 \u0026amp;\u0026#39; 这个方式简单有效，无需 root 权限。\n✅ 方法二：写个用户自启脚本放到 .login\n例如，如果你登录使用的是终端，可以在 ~/.login 加一行：\n$HOME/.usr/local/opt/go/bin/sing-box run -c $HOME.usr/local/etc/sing-box/config.json \u0026gt; $HOME/.sing-box.log 2\u0026gt;\u0026amp;1 \u0026amp; 附普通用户启动程序知识点： 查看进程： pgrep -a sing-box 如果在运行会看用ID，杀行进程命令：\nkill -9 ID 要将 sing-box run -C ~/.usr/local/etc/sing-box 命令改为后台运行，你可以有几种方式选择：\n✅ 方法 1：加 \u0026amp; 直接后台运行 sing-box run -C ~/.usr/local/etc/sing-box \u0026amp; 这会将进程放到后台运行，但关闭终端后会退出，不推荐用于长期服务。\n✅ 方法 2：使用 nohup 保持后台运行（推荐） nohup sing-box run -C ~/.usr/local/etc/sing-box \u0026gt; ~/sing-box.log 2\u0026gt;\u0026amp;1 \u0026amp; 解释：\nnohup：防止进程随终端退出； \u0026gt; ~/sing-box.log：将输出保存到日志文件； 2\u0026gt;\u0026amp;1：合并标准错误输出； \u0026amp;：后台运行。 ---\n✅ 方法 3：使用 tmux 或 screen 管理后台任务（适合调试） tmux new -s singbox sing-box run -C ~/.usr/local/etc/sing-box # 按 Ctrl+B 然后 D 可后台 detach 这样你可以随时恢复控制台查看运行状态。\n---\n✅ 方法 4：写入 crontab @reboot 启动（你之前提到过） @reboot nohup $HOME/.usr/local/bin/sing-box run -C $HOME/.usr/local/etc/sing-box \u0026gt; $HOME/sing-box.log 2\u0026gt;\u0026amp;1 \u0026amp; `\u0026mdash;\n总结： 安装依赖工具（git 和 go）。\n克隆 sing-box 源代码并编译。\n将二进制文件安装到 /usr/local/bin/。\n配置并运行 sing-box。\nsing-box 中 -C 和 -c 是不同的参数，它们的作用如下：\n✅ -c ：指定配置文件路径 sing-box run -c /usr/local/etc/sing-box/config.json 这是最常用的参数。\n直接告诉 sing-box 你要用哪个配置文件来启动。\n附：PF防火墙启用～ 编辑 pf 配置文件 打开 /etc/pf.conf 文件，添加以下内容：\n# 定义接口 ext_if = \u0026#34;em0\u0026#34; # 你的外网接口名称，通常为 em0 或者 eth0，具体看你的系统 # 允许流量通过loopback接口 set skip on lo0 # 默认拒绝所有入站连接 block all # 允许所有出站流量 pass out all # 允许来自本地网络的流量到达22端口和1080端口 pass in on $ext_if proto tcp from any to any port 22 keep state pass in on $ext_if proto tcp from any to any port 1080 keep state # 允许其他已经建立的连接的数据包通过 pass in all keep state 启用 pf 防火墙 配置文件完成后，启用 pf 防火墙并应用规则：\npfctl -f /etc/pf.conf # 加载 pf 配置文件 pfctl -e # 启用 pf 防火墙 验证 pf 配置 使用以下命令检查防火墙规则是否已成功加载：\npfctl -sr 确认连接 允许 22 端口：你可以通过 ssh 连接到这台机器，确认 22 端口是否开放。\n允许 1080 端口：你可以通过 SOCKS 客户端连接到你的 SOCKS 代理，确认 1080 端口是否开放。\n其他端口：其他端口的连接会被阻止。\n配置解释： 允许所有出站流量： pass out all 规则放行所有从本机出去的流量。这样你就可以自由访问外部网络。\n允许进站流量的限制： pass in on $ext_if proto tcp from any to any port 22 keep state 只允许外部访问 22 端口（SSH）。\npass in on $ext_if proto tcp from any to any port 1080 keep state 只允许外部访问 1080 端口（你的 SOCKS 服务）。\n默认阻止所有入站流量： block all 这条规则阻止所有未被明确允许的入站流量，确保服务器更加安全。\n保持连接状态： keep state 保证了允许的连接状态（如 SSH 和 SOCKS）的持续性。意味着你建立的连接不会因为防火墙规则的变动而被意外中断。\n这样，你的防火墙会允许外部的 SSH 和 SOCKS 流量，但拒绝其他端口的访问，同时允许所有的出站流量。\n","permalink":"https://hanigege.github.io/posts/freebsd/freebsd14.2%E6%8B%89%E5%8F%96%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85sing-box/","tags":null,"title":"Freebsd14.2拉取源码安装sing-Box(包含pf防火墙配置)"},{"categories":["freebsd"],"contents":"手动安装最新版本 Go 从 Go 官方网站下载最新版本的 Go 语言：\n访问 Go 语言官网 下载最新版本的 Go。选择适合 FreeBSD 的版本，例如 go1.23.1.freebsd-amd64.tar.gz，后面如需版本更新，请自行修改新版本下载链接，一般情况下只修改版本号就可以了。\nroot用户安装方法： fetch https://golang.org/dl/go1.26.0.freebsd-amd64.tar.gz tar -C /usr/local -xzf go1.26.0.freebsd-amd64.tar.gz 如需修改安装路径：\nmkdir -p /usr/local/opt/ fetch -o /usr/local/opt/go1.26.0.freebsd-amd64.tar.gz https://golang.org/dl/go1.26.0.freebsd-amd64.tar.gz cd /usr/local/opt/ tar -C /usr/local/opt/ -xzf go1.26.0.freebsd-amd64.tar.gz 普通用户的安装方法：(只能在自己目录中操作，好处:安全，隔离）{推荐} mkdir -p .usr/local/opt/ fetch -o .usr/local/opt/go1.26.0.freebsd-amd64.tar.gz https://golang.org/dl/go1.26.0.freebsd-amd64.tar.gz cd .usr/local/opt/ tar -C ~/.usr/local/opt/ -xzf go1.26.0.freebsd-amd64.tar.gz 设置 Go 环境变量：\n打开~/.profile 文件，添加 Go 的环境变量：\n原方式：\nexport PATH=$PATH:/usr/local/go/bin 改路径后：\nexport PATH=$PATH:/usr/local/opt/go/bin 普通用户下：在.bash_profile 文件中添加变量（普通用户已改为bash指令）如用提sh指令，那就在.profile文件中改： export PATH=$PATH:~/.usr/local/opt/go/bin 刷新配置或重启终端：在 FreeBSD 中，默认使用的 shell 是 sh，而 sh 不支持 source 命令。相反，sh 使用 . 来代替 source。因此，如果你使用的是 sh，需要改为使用以下命令来加载配置文件：\n. ~/.profile or\n. .bash_profile 验证 Go 版本是否更新成功：\ngo version 输出应显示最新的 Go 版本，例如：\ngo version go1.26.0 freebsd/amd64 总结： 更新 Go 版本到 1.26.0 或更高版本。\n如果 Go 版本更新成功，再次尝试运行 make 来编译 sing-box。\n","permalink":"https://hanigege.github.io/posts/freebsd/freebsd-install-go1231/","tags":null,"title":"Freebsd Install Go最新版"},{"categories":["linux"],"contents":"acme.sh脚本申请cloudflare的证书 支持泛域名 前言：acme.sh是一个非常好用的用于申请证书的脚本，它开源在Github，它极大地降低了申请证书的难度，支持使用cloudflare api等多种api来申请证书。\n本文主要介绍使用此脚本来申请 ssl 证书，给你的http请求加把锁，具体可以用来cloudflare api介绍。\n准备条件： 一台被分配了公网IP的主机\n一个域名(建议购买收费域名)\n电脑ssh客户端\n能解决个体的问题\n一、全球API申请证书 1.1、安装脚本文件 以root用户ssh连接到主机，使用下面的命令安装脚本：\napt update \u0026amp;\u0026amp; apt -y install socat //更新源并安装socat wget -qO- get.acme.sh | bash //安装此脚本 source ~/.bashrc //让别名生效，此后无论在哪里直接使用acme.sh，不用输绝对路径 # 由于最新acme.sh脚本默认ca变成了zerossl，现## 执行下面命令修改脚本默认ca为letsencrypt acme.sh --set-default-ca --server letsencrypt 1.2、证书配置 1.2.1 获取Cloudflare api key 注册好cloudflare账号，把域名解析的解析权限锁定cloudflare处理，这样以后只需要在cloudflare这里配置解析记录。按照图标获取cloudflare api key。 1.2.2 申请证书（二选一） 这里假设您的域名是yourdomain.com，执行下面命令申请证书：\n1.2.2.1 dns方式验证\nexport CF_Key=\u0026#34;slfjksjffjfhfhkjhfksjf\u0026#34; //此处替换成你自己的Key export CF_Email=\u0026#34;yourcloudflare@gmail.com\u0026#34; //此处填写你给Cloudflare绑定的邮箱账号 acme.sh --issue --dns dns_cf -d yourdomain.com -d www.yourdomain.com -k ec-256 说明：Cloudflare 目前不支持.tk .cf .ml等免费申请来的域名后缀使用此 DNS 验证方式，付费域名才受支持，免费域名使用低于 2.2.2 方式。脚本申请到的证书和密钥都放在目录下~/.acme.sh/yourdomain.com_ecc。\n1.2.2.2 http方式验证 执行下面命令前请保证你80端口没有被其他程序使用，如果有，kill掉，执行下面命令前需要你先在cloudflare dns那里添加好一条记录可以，开启cloudflare cdn（cdn此时http方式验证无）影响）：\nacme.sh --issue --standalone -d yourdomain.com -d www.yourdomain.com -k ec-256 说明：跟上面一样，脚本申请到的证书放在~/.acme.sh/yourdomain.com_ecc目录下\n1.2.3 安装证书到指定位置 如果linux主机里已有/root/ssl目录，现在已经把证书和密钥安装到这个目录下，那么执行下面的命令即可：\nacme.sh --installcert -d yourdomain.com -d www.yourdomain.com --fullchain-file /root/ssl/web.crt --key-file /root/ssl/web.key --ecc 1.3、证书更新 但从letscncrypt申请证书到的程度是90天，脚本会每60天到证书进行更新，后续可能会持续这个时间，都是自动的。\n# 手动强制更新证书 acme.sh --renew -d yourdomain.com -d www.yourdomain.com --force --ecc 二、局部API 本文主要以Debian10为例，介绍使用新的cloudflare api令牌来申请证书，免费域名已不受cloudflare第一方式来申请证书，请使用付费域名。\n2.1、安装配置acme.sh脚本 以root用户ssh登陆到主机，使用下面命令安装配置脚本：\n更新源并安装socat apt update \u0026amp;\u0026amp; apt -y install socat # 安装脚本 wget -qO- get.acme.sh | bash # 让脚本在.bashrc文件追加的一行环境变量生效，以后无论在哪里直接使用acme.sh，不用输绝对路径 source ~/.bashrc # 由于最新acme.sh脚本默认ca变成了zerossl，现执行下面命令修改脚本默认ca为letsencrypt acme.sh --set-default-ca --server letsencrypt 2.2、配置Cloudflare积分令牌 2.2.1 创建代币 根据acme.sh作者脚本提供的文档：使用新的cloudflare api令牌，需要新创建此令牌方可使用： 其中图片设置即可，选择添加区域-DNS-编辑和区域-区域-读取权限，区域资源里面包括-账户的所有区域-你的账户 配置好以后，点击创建令牌，注意此令牌token只会出现一次，切记保存，切记保存，切记保存！！！\n2.2.2 获取账户ID和区域ID 根据acme.sh文档，申请证书可能还需要提供两个ID，其中账户ID必须，区域ID可有无，根据下图方法获取这两个ID： 下拉，找到API区域：\n至此，即准备好申请证书所需的材料：\n# 上面第一步创建的令牌，即为token CF_Token=\u0026#34;xxxxxxx\u0026#34; # 根据上图分别获取账户ID和区域ID CF_Account_ID=\u0026#34;aaaaaaaa\u0026#34; CF_Zone_ID=\u0026#34;bbbbbbbbb\u0026#34; //此项非必须 2.3、申请配置证书 2.3.1 申请证书 如果您的域名是example.com，执行下面命令申请证书，非root用户也执行：\n# 执行此命令设置变量的值，acme.sh脚本执行过程会读取 export CF_Token=\u0026#34;xxxxxxx\u0026#34; export CF_Account_ID=\u0026#34;aaaaaaa\u0026#34; export CF_Zone_ID=\u0026#34;bbbbbbbb\u0026#34; //此项非必须，上面两项需要提供 # 申请证书 acme.sh --issue -d example.com -d *.example.com --dns dns_cf -k ec-256 2.3.2 安装证书到指定位置 如果linux主机里已有/etc/ssl目录，现在已经把证书和密钥安装到这个目录下，那么执行下面的命令即可：\nacme.sh --installcert -d example.com -d *.example.com --fullchain-file /etc/ssl/web.crt --key-file /etc/ssl/web.key --ecc # 用--reloadcmd指定安装证书后的命令 acme.sh --installcert -d example.com -d *.example.com --fullchain-file /etc/ssl/web.crt --key-file /etc/ssl/web.key --ecc --reloadcmd \u0026#34;systemctl restart webserver\u0026#34; 说明：脚本更新完证书后，会自动遵循上面指定的绝对路径将证书和密钥安装到指定位置，并根据\u0026ndash;reloadcmd执行相应的操作。\n------------------------\n例：我的ssl目录路径为： #nginxg配置文件里的证书路径，只限于我自己使用，你们随意 ssl_certificate /etc/nginx/certs/web.crt; ssl_certificate_key /etc/nginx/certs/web.key; acme.sh --installcert -d 29.xyz -d *.29.xyz --fullchain-file /root/data/docker_data/nginx/certs/web.crt --key-file /root/data/docker_data/nginx/certs/web.key --ecc #安装到我指定的路径 -------------------------\n2.3.3 证书更新 从letsencrypt申请到的证书有效期是90天，脚本每60天将进行证书更新，你也可以手动强制更新：\n# 查询域名申请证书信息 acme.sh --list # 自动更新证书 ~/.acme.sh/acme.sh --upgrade --auto-upgrade # 手动强制更新证书 acme.sh --renew -d example.com -d *.example.com --force --ecc acme.sh --renew -d example.com -d *.example.com --force //非ECC证书使用此命令 附一份nginx.conf完整的反向代理配置文件供参考： events { worker_connections 1024; } http { client_max_body_size 4096m; server { listen 80; listen [::]:80; server_name 29.xyz; return 301 https://$host$request_uri; } server { listen 443 ssl; listen [::]:443 ssl; server_name 29.xyz; ssl_certificate /etc/nginx/certs/web.crt; ssl_certificate_key /etc/nginx/certs/web.key; location / { proxy_pass http://192.168.8.8:8008; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; } } server { listen 80; listen [::]:80; server_name s.29.xyz; return 301 https://$host$request_uri; } server { listen 443 ssl; listen [::]:443 ssl; server_name s.29.xyz; ssl_certificate /etc/nginx/certs/web.crt; ssl_certificate_key /etc/nginx/certs/web.key; location / { proxy_pass http://192.168.8.8:12332; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; } } #html静态网页 server { listen 80; server_name hp.29.xyz; return 301 https://$server_name$request_uri; } server { listen 443 ssl; server_name hp.29.xyz; ssl_certificate /etc/nginx/certs/web.crt; ssl_certificate_key /etc/nginx/certs/web.key; charset utf-8; # 添加这行来指定编码 location / { #解决css.js加载 include mime.types; default_type application/octet-stream; ##解决css.js完毕 root /usr/share/nginx/html; index index.html; } } ##静态网页完 } ","permalink":"https://hanigege.github.io/posts/linux/%E6%89%8B%E5%8A%A8%E7%94%B3%E8%AF%B7%E5%9F%9F%E5%90%8Dssl%E8%AF%81%E4%B9%A6/","tags":null,"title":"手动申请域名ssl证书"},{"categories":["other"],"contents":"前言 我个人搭建SIP的主要目的是因为我个人有很多手机卡，而手机只有2个卡槽，并且每年出国玩的时候手机带出去就是全球漫游，那基本不敢打电话。所以决定搭建一套自己的SIP Server来进行拨打接听电话，手机里只放一张流量卡，而且在不同地点可以在手机原理身边的时候在其他终端接听电话。还能研究学习一项新技术（笑）\n经过多放考虑最后我选择了Synway出品的SMG4004-4LC这款GOIP机器，支持全网通，4个卡槽（长期应该是够用了），SMS Over Email（虽然他也支持SMS Over SIP，但由于FreePBX官方不支持，而且本次我分机主要创建的是PJSIP，而这款机器的SMS是通过Chan SIP发送的，处理起来很麻烦，最后选择了使用Email接收的方式【稳定一些】，当然官方提供了大量API接口，应该是可以写一些机器人发送到如Telegram之类的【已解决，本站有提供】），而且国内还有代理商，可以很方便的买到。\n卡槽界面 搭建FreePBX 我直接使用了官方ISO镜像（基于CentOS）进行默认搭建，搭完还升了个级，关于FreePBX设置的教程网上很多，上几个图大家也可以参照我图里的进行设置。 还要设置 PJSIP的UDP,TCP协议开启 软路由开启端口 对接网关 首先要将网关整机注册到FreePBX实现SIP互通\n创建中继账号 选择创建一个 chan_sip 中继 首先仅填写中继名 路由规则写 X. SIP设置页面填写中继名、和中继配置（可参考下方我的配置） host=dynamic port=5160 type=peer secret=da*********************随便设置个密码 context=from-pstn dtmfmode=rfc2833 insecure=no qualify=3000 设置出局线路 设置完中继之后我们还需要设置一下出局线路让FreePBX的分机可以成功走网关进行拨打 设置一下匹配中继 设置匹配正则表达式为 X. 保存FreePBX配置 点击 注册网关到FreePBX 来到网关的管理界面，一定要选择注册整个网关，密码就是创建中继配置文件里的那个 ","permalink":"https://hanigege.github.io/posts/other/voip-0/","tags":null,"title":"出国自建voip(一.2)FreePBX对接SMG4004网关实现SIP网络电话"},{"categories":["routers"],"contents":"为了让网络低延迟、小包优先真正生效，科学的做法是：禁用 Fasttrack。 执行以下指令，找到并禁用 Fasttrack 规则：\n代码段\n/ip firewall filter # 查找带有 fasttrack-connection 动作的规则并禁用它 disable [find action=fasttrack-connection] 注意：禁用后，所有流量将交由 CPU 进行 Mangle 标记和 Queue 树排队。你的小包优先和限速机制将立刻 100% 生效。\n例：外网下行是300m，上行是30m的带宽 下行队列的挂载接口精准替换为 bridge1，上行接口保持 pppoe-out1\n成功的步骤与科学计算 预留缓冲避免光猫排队： 必须扣除运营商标称带宽的 5% 到 10%，将排队机制强行拉回到 RouterOS 本地处理，以彻底消除缓冲膨胀（Bufferbloat）带来的高延迟。\n上行严格阈值： 30M × 0.95 = 28M\n下行严格阈值： 300M × 0.95 = 285M\n重构挂载点： 将上行队列挂载在拨号接口，下行队列挂载在内网接口。Mangle 标记只需在 prerouting 和 postrouting 抓取一次，即可被上下行队列同时调用。\n1、代码导入的方法 导入代码：\n/ip firewall mangle # 1. 优先 DNS add action=mark-packet chain=prerouting protocol=udp dst-port=53 new-packet-mark=dns passthrough=no add action=mark-packet chain=prerouting protocol=tcp dst-port=53 new-packet-mark=dns passthrough=no # 2. 优先 ICMP add action=mark-packet chain=prerouting protocol=icmp new-packet-mark=small-packet passthrough=no # 3. 根据包大小标记中小包 (覆盖 TCP ACK 和游戏数据) add action=mark-packet chain=prerouting packet-size=0-128 new-packet-mark=small-packet passthrough=no add action=mark-packet chain=prerouting packet-size=129-512 new-packet-mark=medium-packet passthrough=no # 4. 剩余大包兜底 (下载、视频等) add action=mark-packet chain=prerouting new-packet-mark=large-packet passthrough=no # 5. MSS 钳制 add action=change-mss chain=forward protocol=tcp tcp-flags=syn new-mss=clamp-to-pmtu passthrough=yes /queue tree # 清理旧队列 remove [find] # ================= 上行队列 (Upload) ================= # 挂载到外网拨号接口 pppoe-out1，总带宽 28M add name=Upload-Total parent=pppoe-out1 max-limit=28M add name=U1-Dns parent=Upload-Total packet-mark=dns priority=1 queue=default-small limit-at=2M max-limit=28M add name=U2-Small parent=Upload-Total packet-mark=small-packet priority=2 queue=default-small limit-at=5M max-limit=28M add name=U3-Medium parent=Upload-Total packet-mark=medium-packet priority=3 queue=default-small limit-at=10M max-limit=28M add name=U4-Large parent=Upload-Total packet-mark=large-packet priority=8 queue=default-small limit-at=11M max-limit=28M # ================= 下行队列 (Download) ================= # 挂载到内网桥接接口 bridge1，总带宽 285M add name=Download-Total parent=bridge1 max-limit=285M add name=D1-Dns parent=Download-Total packet-mark=dns priority=1 queue=default-small limit-at=5M max-limit=285M add name=D2-Small parent=Download-Total packet-mark=small-packet priority=2 queue=default-small limit-at=20M max-limit=285M add name=D3-Medium parent=Download-Total packet-mark=medium-packet priority=3 queue=default-small limit-at=50M max-limit=285M add name=D4-Large parent=Download-Total packet-mark=large-packet priority=8 queue=default-small limit-at=210M max-limit=285M 要让以上 QoS 规则真正生效，必须处理（禁用）防火墙中的 Fasttrack（硬件加速）规则，否则所有数据包都会直接绕过 Mangle 和 Queue 树。\n它们对“快”的定义完全相反。Fasttrack 保障的是“极限吞吐量”（测速数字大），小包优先保障的是“极低延迟”（响应快、不卡顿）。\n科学事实与优劣势对比 1. Fasttrack（硬件/底层加速）—— 追求极限带宽\n科学原理： 让建立好连接的数据包强制绕过防火墙 Mangle 和 Queue 队列，直接在底层转发，极大减轻 CPU 负担。 效果： 测速能跑满甚至溢出你的 300M 带宽，路由器 CPU 占用率极低。 致命缺陷： 完全丧失拥塞控制能力。一旦局域网内有设备满速下载或上传（特别是你只有 30M 的上行），整个网络会发生严重的缓冲膨胀（Bufferbloat），导致游戏疯狂跳 Ping、网页转圈打不开。 2. 小包优先（QoS Queue Tree）—— 追求极致响应\n科学原理： 主动牺牲 5%-10% 的极限带宽作为缓冲空间，利用 CPU 算力对所有数据包进行精准排队，强制让 DNS、游戏小包、网页请求“插队”先发。 效果： 无论内网设备怎么疯狂下载或上传，游戏延迟永远保持在最低水平，网页始终秒开，网络体验丝滑。 代价： 测速数字最高只能达到你设定的 285M 和 28M，且由于所有包都要经过 CPU 运算，路由器 CPU 负载会升高。 禁用 Fasttrack，全面启用小包优先 QoS。用测速软件上少跑 15M 的数字，换取全天候永远不卡顿的高质量网络体验，这才是真正的“网速快”。\n例：下行是350mpbs 下行是50mpbs 照你最新确认的物理极限（下行 350Mbps，上行 50Mbps）重新计算防拥堵阈值，确保预留 5% 的排队缓冲空间。\n科学计算与新阈值 上行严格阈值： 50M × 0.95 = 47M\n下行严格阈值： 350M × 0.95 = 332M\n成功的调整步骤 请直接在 ROS 终端执行以下完整代码，覆盖之前的队列配置（Mangle 标记保持不变）\n/queue tree # 清理旧队列 remove [find] # ================= 上行队列 (Upload: 适配 50M，实设 47M) ================= add name=Upload-Total parent=pppoe-out1 max-limit=47M add name=U1-Dns parent=Upload-Total packet-mark=dns priority=1 queue=default-small limit-at=3M max-limit=47M add name=U2-Small parent=Upload-Total packet-mark=small-packet priority=2 queue=default-small limit-at=8M max-limit=47M add name=U3-Medium parent=Upload-Total packet-mark=medium-packet priority=3 queue=default-small limit-at=15M max-limit=47M add name=U4-Large parent=Upload-Total packet-mark=large-packet priority=8 queue=default-small limit-at=21M max-limit=47M # ================= 下行队列 (Download: 适配 350M，实设 332M) ================= add name=Download-Total parent=bridge1 max-limit=332M add name=D1-Dns parent=Download-Total packet-mark=dns priority=1 queue=default-small limit-at=5M max-limit=332M add name=D2-Small parent=Download-Total packet-mark=small-packet priority=2 queue=default-small limit-at=30M max-limit=332M add name=D3-Medium parent=Download-Total packet-mark=medium-packet priority=3 queue=default-small limit-at=80M max-limit=332M add name=D4-Large parent=Download-Total packet-mark=large-packet priority=8 queue=default-small limit-at=217M max-limit=332M 别忘了导入ipv6的mangle规则 /ipv6 firewall mangle # 优先 DNS (UDP/TCP 53) add action=mark-packet chain=prerouting protocol=udp dst-port=53 new-packet-mark=dns passthrough=no add action=mark-packet chain=prerouting protocol=tcp dst-port=53 new-packet-mark=dns passthrough=no # 优先 ICMPv6 (Ping，注意协议名为 icmpv6) add action=mark-packet chain=prerouting protocol=icmpv6 new-packet-mark=small-packet passthrough=no # 标记所有小包与中包 add action=mark-packet chain=prerouting packet-size=0-128 new-packet-mark=small-packet passthrough=no add action=mark-packet chain=prerouting packet-size=129-512 new-packet-mark=medium-packet passthrough=no # 剩余大包兜底 (彻底拦截 IPv6 测速和下载) add action=mark-packet chain=prerouting new-packet-mark=large-packet passthrough=no 优化内网sing-box的流量规则 （可选） /ip firewall mangle # 1. 抓取 IPv4 sing-box 发起的所有双向连接 add action=mark-connection chain=prerouting src-address=10.20.20.6 new-connection-mark=proxy-conn passthrough=yes place-before=0 # 2. 赋予专属数据包标记，并阻止其进入后续的大小包分类 add action=mark-packet chain=prerouting connection-mark=proxy-conn new-packet-mark=proxy-packet passthrough=no place-before=1 /ipv6 firewall mangle # 3. 抓取 IPv6 sing-box 发起的所有双向连接 add action=mark-connection chain=prerouting src-address=fd88::6666 new-connection-mark=proxy-conn passthrough=yes place-before=0 # 4. 赋予专属数据包标记 add action=mark-packet chain=prerouting connection-mark=proxy-conn new-packet-mark=proxy-packet passthrough=no place-before=1 /queue tree # 5. 在上行和下行总队列下，插入独立的代理高优队列 (Priority 2，享受与普通小包同等的 VIP 插队特权) add name=U1.5-Proxy parent=Upload-Total packet-mark=proxy-packet priority=2 queue=default-small limit-at=10M max-limit=47M add name=D1.5-Proxy parent=Download-Total packet-mark=proxy-packet priority=2 queue=default-small limit-at=50M max-limit=332M 验证步骤 为了让关闭 Fasttrack 的动作立刻、彻底地对全局生效，必须暴力清空路由器内存中的连接追踪表，强制所有设备重新握手，老老实实去排队。\n请在 ROS 终端执行以下指令：\n# 强制清空所有现有连接状态（注意：执行瞬间全家网络会断开 1-2 秒，随后自动重连） /ip firewall connection remove [find] 执行完毕后，请立刻再跑一次测速。测速网\n科学指标： 这次如果上行被死死钳制在49Mbps以内，下行卡在 332M 左右，就证明 QoS 的大门真正关上了，排队机制完美生效。 突破阈值的数学真相： 你的上行测速跑到了 48.57 Mbps。我们设定的限速是 47M。在 RouterOS 的底层单位换算中，它是按 1024 进位计算的：47M = 47 × 1024 × 1024 bps = 49,283,072 bps。将它换算成测速网站常用的十进制 Mbps，理论值正好是 49.28 Mbps。这说明不仅 QoS 队列精准落地，而且你一滴带宽都没有浪费，精准卡在了物理极限的最完美平衡点上。\n","permalink":"https://hanigege.github.io/posts/routers/ros%E7%9A%84mangle%E5%B0%8F%E5%8C%85%E8%A7%84%E5%88%99/","tags":null,"title":"自用ROS的MANGLE小包规则"},{"categories":["freebsd"],"contents":"我个人不建议安装开启sudo,因为普通用户用自己的密码就可以提升管理权限。个人理解还是完全隔离的好 **下面只提供知识点参考**～\n安装freebsd时已经添加好普通用户的，可以直接从下面可以用 visudo 打开 sudo 配置文件 这里直接修改配置文件就可以了。 你看到的提示：\ngary is not in the sudoers file. This incident has been reported to the administrator. 意思是：当前用户 gary 没有权限使用 sudo，因此不能安装软件或执行需要管理员权限的操作。\n解决办法（需要 root 用户操作） 你需要切换到 root 用户，然后把 gary 添加到 sudo 权限组。步骤如下：\n✅ 1. 用 root 用户登录，或者用 su 切换到 root：\nsu - 系统会提示你输入 root 的密码，不是 gary 的密码。\n✅ 2. 安装 sudo（如果还没装）：\npkg install sudo ✅ 3. 把 gary 用户添加到 wheel 组：(如果安装系统时已加入wheel组就不需要下面的再次操作）\npw usermod gary -G wheel 默认 FreeBSD 的 sudoers 文件允许 wheel 组的用户使用 sudo。\n✅ 4. 确认 sudoers 配置中允许 wheel 组使用 sudo：\n可以用 visudo 打开 sudo 配置文件：（默认vi命令打开） visudo 指定vim命令打开visudo文件： EDITOR=vim visudo 确保有以下内容（没有注释 #）： %wheel ALL=(ALL:ALL) ALL 特别说明：打开visudo文件后，会看到下面三种，只需要去掉带%wheel ALL=(ALL:ALL) ALL前面的#号就行了： root ALL=(ALL:ALL) ALL ## Uncomment to allow members of group wheel to execute any command # %wheel ALL=(ALL:ALL) ALL ## Same thing without a password # %wheel ALL=(ALL:ALL) NOPASSWD: ALL ## Uncomment to allow members of group sudo to execute any command # %sudo ALL=(ALL:ALL) ALL ✅ 5. 现在用 gary 登录，就能用 sudo 了： sudo pkg install bash ..... ","permalink":"https://hanigege.github.io/posts/freebsd/freebsd%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8sudo/","tags":null,"title":"Freebsd普通用户如何使用sudo"},{"categories":["other"],"contents":"docker搭建Coturn TURN服务器 共两种方案： 第一种方案（要了解） 先建立一个文件夹 mkdir -p ~/data/docker_data/coturn/etc/coturn mkdir -p ~/data/docker_data/coturn/var/run mkdir -p ~/data/docker_data/coturn/var/log #如果用下面第一种方案这个才需要建立，第二种不需要 cd ~/data/docker_data/coturn/etc/coturn touch turnserver.conf cd ~/data/docker_data/coturn/var/run touch turnserver.pid cd ../../ chmod 777 -R var 拉取镜像\ndocker pull coturn/coturn 直接host方式运行\ndocker run -d --network=host \\ -v /root/data/docker_data/coturn/etc/coturn/turnserver.conf:/etc/coturn/turnserver.conf \\ -v /root/data/docker_data/coturn/etc/:/etc/ \\ -v /root/data/docker_data/coturn/var:/var \\ coturn/coturn 运行时不加 -d 先看输入有错误吗！ 同时查看var下的log看相关的问题 调试启动命令：停止容器后会自动图删除容器，命令如下：\ndocker run --network=host \\ -v /root/data/docker_data/coturn/etc/coturn/turnserver.conf:/etc/coturn/turnserver.conf \\ -v /root/data/docker_data/coturn/etc/:/etc/ \\ -v /root/data/docker_data/coturn/var:/var \\ --rm \\ coturn/coturn 哪果去掉了配置文件里的指定log，停用cli功能，下面有说明，可以用下面的启动命令：\ndocker run -d --network=host \\ -e DETECT_EXTERNAL_IP=yes \\ -e DETECT_RELAY_IP=yes \\ -v /root/data/docker_data/coturn/etc/coturn/turnserver.conf:/etc/coturn/turnserver.conf \\ -v /root/data/docker_data/coturn/etc/:/etc/ \\ -v /root/data/docker_data/coturn/var:/var \\ coturn/coturn \\ -n --log-file=stdout 你之后不要1~65535全都开放 实行白名单放行模式\n比如coturn只开放以下\n3478\n5349\n上面两个tcp udp全打开\n49152~65535\n生成证书：\nsudo openssl req -x509 -newkey rsa:2048 -keyout /etc/turn_server_pkey.pem -out /etc/turn_server_cert.pem -days 99999 -nodes 生成的两个证书传输到 /root/data/docker_data/coturn/etc/ 文件夹下。可以先下载下来，再传到相应的文件夹里。 或者一步到位直接生成到目标文件夹\nsudo openssl req -x509 -newkey rsa:2048 -keyout /root/data/docker_data/coturn/etc/turn_server_pkey.pem -out /root/data/docker_data/coturn/etc/turn_server_cert.pem -days 99999 -nodes netstat -anpl | grep turnserver #检测 Dibian没有这个命令，可以安装：\napt-get install net-tools 搞定！ 生成验证密钥到test.conf文件，生成后打开文件复制密钥替换下面配置文件里的密钥：（特别说明，密钥的长度可以修改下面命令行里的256参数，建议设为68即可，也就是68个字符\necho \u0026#34;static-auth-secret=$(cat /dev/urandom | tr -cd \u0026#39;[:alnum:]\u0026#39; | fold -w 256 | head -n 1)\u0026#34; | sudo tee /root/test.conf 如下：\necho \u0026#34;static-auth-secret=$(cat /dev/urandom | tr -cd \u0026#39;[:alnum:]\u0026#39; | fold -w 68 | head -n 1)\u0026#34; | sudo tee /root/test.conf 具体配置文件是：turnserver.conf 路径为：/root/data/docker_data/coturn/etc/coturn\nCOTURN Server 配置样例：turnserver.conf\nuse-auth-secret static-auth-secret=ynojlSEBrJ6VjFHNyjJiyZRnnMUQ0WKAsSzGdMhL8he realm=coturn.1.xyz #指定 Coturn 的日志文件路径 log-file=/var/log/turnserver.log # VoIP traffic is all UDP. There is no reason to let users connect to arbitrary TCP endpoints via the relay. no-tcp-relay # 调试日志级别 verbose=1 cli-password=8al8la.com # Set a non-empty CLI password # don\u0026#39;t let the relay ever try to connect to private IP address ranges within your network (if any) # given the turn server is likely behind your firewall, remember to include any privileged public IPs too. denied-peer-ip=10.0.0.0-10.255.255.255 denied-peer-ip=192.168.0.0-192.168.255.255 denied-peer-ip=172.16.0.0-172.31.255.255 # special case the turn server itself so that client-\u0026gt;TURN-\u0026gt;TURN-\u0026gt;client flows work allowed-peer-ip=10.0.0.1 listener-ip=coturn.1.xyz relay-ip=coturn.1.xyz # consider whether you want to limit the quota of relayed streams per user (or total) to avoid risk of DoS. user-quota=12 # 4 streams per video call, so 12 streams = 3 simultaneous relayed calls per user. total-quota=1200 # TLS certificates, including intermediate certs. # 指定了 TLS 证书文件的路径 cert=/etc/turn_server_cert.pem # 指定了 TLS 私钥文件的路径 pkey=/etc/turn_server_pkey.pem pidfile=/var/run/turnserver.pid 修改上面的域名，和那一串密码，保存后重启coturn的容器！\n调试日志说明 在您提供的配置中，日志调试级别由verbose参数指定。在您的配置中，verbose设置为1，表示启用了最低级别的调试日志。\n调试级别通常有不同的值，用于控制日志的详细程度。常见的级别包括：\n0：关闭调试日志，只记录错误和关键信息。\n1：最低级别的调试，通常用于记录基本的操作信息和警告。\n2：中等级别的调试，记录更多的详细信息，包括一些内部操作的细节。\n3：最高级别的调试，记录非常详细的信息，包括每个步骤的操作和状态。\n在您的配置中，设置为1的调试级别将记录基本的操作信息和警告，但不会记录过多的细节。这对于一般情况下的日志记录已经足够。如果需要更详细的调试信息，您可以将调试级别设置为更高的值，例如2或3，但这可能会生成更多的日志数据。\n注意上面/etc/turn_*路役是指容器里的路径。\n如果想关闭CLI监听器功能。要禁用CLI功能，您可以删除或注释掉相关配置行。在您的配置文件中，只需要删除或注释掉以下两行即可：\ncli-password=8al8la.com # Set a non-empty CLI password # 指定 Coturn 的日志文件路径 # log-file=/var/log/turnserver.log 请注意，这些配置更改将禁用CLI密码和CLI日志记录功能。保存更改后，重新启动coturn服务器以使更改生效。\n所谓cli功能：\nCLI监听器（Command Line Interface listener）允许您通过命令行界面与coturn服务器进行交互和管理。通过CLI，您可以执行各种管理任务，例如查看当前服务器状态、添加或删除用户、配置转发规则等。\nCLI监听器允许管理员通过命令行输入特定的命令来与coturn服务器进行通信，而无需通过图形界面或其他方式进行操作。这使得管理者可以更加灵活和高效地管理服务器，特别是在自动化和脚本化管理方面。\n查看日志：运行时不加 -d 看输入！\njournalctl -u coturnsystemd 这是加/root/data/docker_data/synapse/data/homeserver.yaml配置文件里的\n#turnserver# turn_uris: [ \u0026#34;turn:coturn.666.eu.org?transport=udp\u0026#34;, \u0026#34;turn:coturn.666.eu.org?transport=tcp\u0026#34; ] turn_shared_secret: \u0026#34;SdQmVOBTRxViwUhsRsRgpBctFNMYatKUBHIO69wFKxEVuqog1HPPoMKya7YA\u0026#34; turn_user_lifetime: 86400000 turn_allow_guests: True ```bash 记的修改域名和密码和主文件同步。 ```bash 确保您的防火墙允许流量进入您配置为侦听的端口上的 TURN 服务器（默认情况下：TURN 流量使用 3478 和 5349（请记住同时允许 TCP 和 UDP 流量），UDP 中继使用端口 49152-65535 .) 特别说明：coturn服务器也可以不做反向代理\nCoturn服务通常需要打开以下端口以支持TURN协议和实现NAT遍历：\nTURN Listening Port (Default: 3478): Coturn服务通过此端口侦听TURN请求。此端口是TURN协议的标准端口。\nDefault TURN Port: 3478 TURN TLS Listening Port (Default: 5349): 如果启用了TURN over TLS（加密的TURN流量），则需要打开此端口。 Default TURN TLS Port: 5349 Listening Ports Range for Relayed UDP Traffic (Default: 49152-65535): 当TURN服务器用于中继UDP流量时，它需要使用一系列UDP端口。\n上面的配置里我指定了20000-30000\nDefault UDP Port Range: 49152-65535 这些端口需要在Coturn服务器配置中指定，并且相应的防火墙规则也需要配置，以允许流量通过这些端口。确保在配置Coturn服务器时参考文档，因为实际端口配置可能因特定用例和安全需求而有所不同。\nMatrix Synapse Default Communication Port (TCP): 8448 确保在配置防火墙规则时，这些端口是开放的，以确保Synapse和Coturn能够相互通信。\n第二种方案：（优选，推荐使用这一种方案） 关于日志输入等级，常见的选项包括：\nverbose：冗余的输出，通常包含了非常详细的信息，用于调试和排查问题。\ndebug：调试级别的输出，提供比较详细但不如 verbose 那么冗余的信息。\ninfo：信息级别的输出，提供基本的运行信息，适合一般情况下的使用。\nwarning：警告级别的输出，用于指示潜在的问题或错误。\nerror：错误级别的输出，指示出现的错误情况。\n您可以根据实际需求调整日志输入等级，一般来说，在生产环境中，通常会将日志输入等级设置为 info 或更高级别，以避免冗余信息过多，而在开发或调试阶段，则可能会选择 debug 或 verbose 等级以便更详细地了解系统运行情况。\n自行安装好docker及docker-compose 开始操作 mkdir -p ~/data/docker_data/coturn/etc/coturn mkdir -p ~/data/docker_data/coturn/var/run mkdir -p ~/data/docker_data/coturn/var/log #如果用下面第一种方案这个才需要建立，第二种不需要 cd ~/data/docker_data/coturn/etc/coturn touch turnserver.conf cd ~/data/docker_data/coturn/var/run touch turnserver.pid cd ../../ chmod 777 -R var turnserver.conf:\n#这是系统日志 #syslog #冗余的日志输出 verbose use-auth-secret static-auth-secret=ThisIsASharedSecret-ChangeMe realm=example.org cert=/etc/letsencrypt/live/turn.example.org/fullchain.pem pkey=/etc/letsencrypt/live/turn.example.org/privkey.pem no-udp external-ip=1.2.3.4 min-port=64000 max-port=65535 详解：\n# 走系统日志 #syslog # 冗余的日志输出 verbose # 指定了长期凭证机制，用于客户端的身份验证和下面的二选一 #lt-cred-mech # 启用了使用静态身份验证密钥进行身份验证的功能 use-auth-secret # 设置了身份验证密钥和域名 static-auth-secret=ynojlSEBrJnMUQ0WKAsSzGdMhL8he # 设置了域名 realm=coturn.1.xyz # 指定了 TLS 证书文件的路径 cert=/etc/web.crt # 指定了 TLS 私钥文件的路径 pkey=/etc/web.key # Set a non-empty CLI password cli-password=8al8la.com # 禁用了 UDP 通信，意味着只使用 TCP #no-udp min-port=64000 max-port=65535 最终实例：\n# 日志输出参数 info # 启用认证 use-auth-secret # 值为认证时使用的密钥 static-auth-secret=ynojlSEBnMUQ0WKAsSzGdMhL8he # 值为你给 coturn 实例分配的域名 (它可以不和你的域名完全一致, 但至少必须有) realm=coturn.10.xyz # 指定了 TLS 证书文件的路径 cert=/etc/web.crt # 指定了 TLS 私钥文件的路径 pkey=/etc/web.key # Set a non-empty CLI password cli-password=8a.com #限定最小最大端口 min-port=64000 max-port=65535 上面配置里的证书： 和域名生成标准证书一样，本站有提供教程。此证书为coturn服务器域名的证书 测试启动命令：(没有加-d （后台运行） 测试没问题了，再加,还有最后的\u0026ndash;rm去除掉，退出自动删除容器的意思） docker run --network=host \\ -v /root/data/docker_data/coturn/etc/coturn/turnserver.conf:/etc/coturn/turnserver.conf \\ -v /root/data/docker_data/coturn/etc/:/etc/ \\ -v /root/data/docker_data/coturn/var/run/turnserver.pid:/var/run/turnserver.pid \\ --rm \\ coturn/coturn (小提醒:域名证书生成后按照配置文件路役放入运行后，可能会提示key文件权限不够，给他个other读权限，重启即可） 正式启动命令：\ndocker run -d --network=host \\ -v /root/data/docker_data/coturn/etc/coturn/turnserver.conf:/etc/coturn/turnserver.conf \\ -v /root/data/docker_data/coturn/etc/:/etc/ \\ -v /root/data/docker_data/coturn/var/run/turnserver.pid:/var/run/turnserver.pid \\ coturn/coturn docker-compose.yaml\nservices: coturn: image: coturn/coturn container_name: coturn network_mode: host restart: unless-stopped # 始终启动，除非手动停止 volumes: - /root/data/docker_data/coturn/etc/coturn/turnserver.conf:/etc/coturn/turnserver.conf - /root/data/docker_data/coturn/etc/:/etc/ - /root/data/docker_data/coturn/var/run/turnserver.pid:/var/run/turnserver.pid 使用以下命令来后台运行容器：\ndocker-compose up -d 在synapse配置文件data/homeserver.yaml里加入 #turnserver# turn_uris: [ \u0026#34;turn:cotu10.xyz?transport=udp\u0026#34;, \u0026#34;turn:coturnc10.xyz?transport=tcp\u0026#34; ] turn_shared_secret: \u0026#34;ynojlAOWksiyk1SEBrJ6VjFHNyjJiyZRnnMUQ0WKAsSzGdMhL8he\u0026#34; turn_user_lifetime: 86400000 turn_allow_guests: True ","permalink":"https://hanigege.github.io/posts/other/%E5%AE%B6%E5%BA%AD%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%B3%BB%E5%88%973coturn%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA/","tags":null,"title":"家庭聊天服务器系列（3）coturn服务搭建"},{"categories":["other"],"contents":"\nntfy 无需注册的通知服务 最下面是恢复备份的方案： ##​​ 什么是 ntfy ？ ​ntfy​​​（发音：notify​​​）是一个简单的基于 HTTP​​​ 的 pub-sub​​​ 通知服务。它允许您通过任何计算机上的脚本向您的手机或桌面发送通知，完全无需注册或费用。\n官方提供了免费的版本：https://ntfy.sh/app 安装 新建文件：docker-compose.yml 脚本如下：\nservices: ntfy: image: binwiederhier/ntfy:latest container_name: ntfy command: - serve environment: - TZ=Asia/Shanghai volumes: - /root/data/docker_data/ntfy/data/cache:/var/cache/ntfy - /root/data/docker_data/ntfy/data/config:/etc/ntfy ports: - 12332:80 restart: unless-stopped networks: - matrix networks: matrix: name: matrix 代码中的反向代理npm转发外出端口12332 。\n上面的代码中会自建 网络matrix.\n如果先行自己建立网络，如： 建立一个 docker network：\ndocker network create matrix 那么您可以按照之前提到的建议在 Docker Compose 文件中将网络定义标记为外部网络，并且指定正确的网络名称。在您的 Docker Compose 文件中，您可以将网络定义修改为类似以下内容：\nservices: ntfy: image: binwiederhier/ntfy:latest container_name: ntfy command: - serve environment: - TZ=Asia/Shanghai volumes: - /root/data/docker_data/ntfy/data/cache:/var/cache/ntfy - /root/data/docker_data/ntfy/data/config:/etc/ntfy ports: - 12332:80 restart: unless-stopped networks: matrix: external: true networks: matrix: external: true name: matrix 这将告诉 Docker Compose 使用外部网络 \u0026ldquo;matrix\u0026rdquo;，并且不会尝试重新创建它。\n另外，如果您确实想要使用 Compose 创建一个新的网络，并且希望使用 \u0026ldquo;matrix\u0026rdquo; 这个名称，您需要先删除现有的 \u0026ldquo;matrix\u0026rdquo; 网络，然后再创建一个新的。您可以使用以下命令来删除现有的网络：\ndocker network rm matrix 然后，当您运行 docker-compose up -d 时，Compose 将创建一个新的 \u0026ldquo;matrix\u0026rdquo; 网络。\n请确保您的网络设置符合您的预期，并且不会影响到其他服务。\n运行 在浏览器中输入 http://IP:12332​ 就能看到主界面\n关键注意： 进入\ncd /root/data/docker_data/ntfy/data/config:/etc/ntfy 相应的config文件夹下，需要建立一个server.yml 配置文件，内容如下：\nbase-url: \u0026#34;https://sms.888.org\u0026#34; #listen-http: \u0026#34;\u0026#34; #如果上面的网址没有做反向解析，就要加入端口号 behind-proxy: true upstream-base-url: \u0026#34;https://ntfy.sh\u0026#34; log-level: TRACE 实例：\nbase-url: \u0026#34;http://ss.160.xyz:125\u0026#34; #listen-http: \u0026#34;\u0026#34; #如果上面的网址没有做反向解析，就要加入端口号 behind-proxy: true upstream-base-url: \u0026#34;https://ntfy.sh\u0026#34; log-level: TRACE 然后重启容器\ndocker restart “容器名” 这样element里的网关就可以自动改为本网址，更加安全，方便 ，效率！\n​下面是一个示例，展示了如何使用 POST 请求（通过 curl -d）发布消息：\n格式比较简单：curl -d \u0026lt;消息\u0026gt; \u0026lt;服务器IP:端口\u0026gt;/\u0026lt;主题\u0026gt;\n简单消息测试 curl -d \u0026#34;Hi\u0026#34; http://192.168.0.197:3680/laosu_test_ch 您可以设置 通知优先级、标题和标签 消息。这是一起使用其中一些的示例：\n更复杂的消息示例 curl \\ -H \u0026#34;Title: Unauthorized access detected\u0026#34; \\ -H \u0026#34;Priority: urgent\u0026#34; \\ -H \u0026#34;Tags: warning,skull\u0026#34; \\ -d \u0026#34;Remote access to $(hostname) detected. Act right away.\u0026#34; \\ http://192.168.0.197:3680/laosu_test_ch 查看push的log.如果出现element测试推送不下去，转圈圈，正常能发消息就不用管，log里可以会出现200，命令如下：\ndocker logs -tf --tail 100 \u0026lt;synapse容器id或名称\u0026gt; 2\u0026gt;\u0026amp;1 | grep /_matrix/push/v1/notify 实例:\ndocker logs -tf --tail 100 cfb 2\u0026gt;\u0026amp;1 | grep /_matrix/push/v1/notify 恢复备份的docker-compose.yml的配置文件： services: ntfy: image: binwiederhier/ntfy:latest container_name: ntfy command: - serve environment: - TZ=Asia/Shanghai volumes: - /root/data/docker_data/ntfy/data/cache:/var/cache/ntfy - /root/data/docker_data/ntfy/data/config:/etc/ntfy ports: - 12332:80 restart: unless-stopped networks: - matrix networks: matrix: external: true name: matrix 本系列最后一篇文章会教你如何和element客户端配合使用，element客户内置是支持的。 ","permalink":"https://hanigege.github.io/posts/other/%E5%AE%B6%E5%BA%AD%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%B3%BB%E5%88%972ntfy%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA/","tags":null,"title":"家庭聊天服务器系列（2）ntfy服务搭建"},{"categories":["other"],"contents":"\n设计思路 服务器需要2台，外网一台vps即可，搭建coturn服务。本地一台，搭建synapse及ntfy服务，所有服务均以docker的方式来搭建 1. ntfy服务：因为很多的限制导致消息无法传达，类似于你消息来了，确收不到通知提醒. 2. coturn 是一个 STUN/TURN 服务器 实现，主要用于 WebRTC、VoIP、视频会议等实时通信应用中，解决NAT 穿透问题。coturn 同时实现了 STUN + TURN，通常用作 WebRTC 的中继服务器，确保视频/语音连接在各种复杂网络环境下都能建立。 3. synapse聊天服务器主体，支持文字，语音，在线语音电话，在线视频，文件传送，是一套完整可持续的聊天服务。 4. 客户端有很多种，官网上都有介绍，这里只推荐使用Element客户端。 最最下面是备份恢复的方法，如何备份，把相关docker文件夹打包下载就可以了，需要恢复的时候，上传到相关的服务器，放在root文件夹下。\n切记，SYNAPAE服务器不可以使用fakeip的DNS代理上网，只能用本地的网络，不然，会收不到消息NTFY会出问题！ 前言 首先必须介绍下Matrix。Matrix是一个开源、可交互、去中心化的实时通信服务框架。使用Matrix可以搭建安全的通信服务器，配合支持 Matrix 的客户端可以实现个人、团队间的实时聊天交互。\n与常见的QQ、微信、钉钉相比，Matrix的特点就是开源，可私有化部署，保证通信的安全和隐私。与Rocket.chat、MatterMost相比，matrix的特点还要再加上去中心化。每个运行Matrix的服务器都是一个节点，用户可以选择在任意节点注册、连接，同一个节点内的用户可以任意通信。同时，节点与节点之间也可以通过联锁（Federation）机制进行通信，实现不同节点的用户之间进行通信。\n因为Matrix只是个框架，可以有很多实现，本文使用的synapse就是其中一个服务端实现。\n除了安装服务端，本文还有安装element web端的步骤。\n搭一个demo并不耗资源，加上postgresql数据库才用了200MB内存不到，如果用默认的sqlite数据库会更省内存。\n安装服务端 更新环境 apt update -y \u0026amp;\u0026amp; apt upgrade -y \u0026amp;\u0026amp; apt install -y curl wget sudo socat 安装 Docker curl -fsSL https://get.docker.com -o get-docker.sh \u0026amp;\u0026amp; sh get-docker.sh curl -L \u0026#34;https://github.com/docker/compose/releases/download/v2.16.0/docker-compose-$(uname -s)-$(uname -m)\u0026#34; -o /usr/local/bin/docker-compose chmod +x /usr/local/bin/docker-compose 搭建Synapse 按照教程建立/data/synapse/下的三个文件夹：\nmkdir ~/data/docker_data/synapse -p mkdir ~/data/docker_data/synapse/data -p mkdir ~/data/docker_data/synapse/postgres -p mkdir ~/data/docker_data/synapse/html -p 具体如下：\n首先，选择一个宿主机文件夹，用于存放synapse所有的数据，我的规划如下：\nSynapse数据：/root/data/docker_data/synapse/data\nPostgreSQL数据： /root/data/docker_data/synapse/postgres\n为了让桥接用的容器和 synapse 容器能够互相通讯，建立一个 docker network：\ndocker network create matrix PostgreSQL pg库我选择了16版本，选择的镜像是postgres:16-alpine。\ndocker run --name postgres16 --network matrix --restart=always -v /root/data/docker_data/synapse/postgres:/var/lib/postgresql/data -e POSTGRES_PASSWORD=自定义PostgreSQL密码 -p 5432:5432 -d postgres:16-alpine 界面会显示容器的hash值，接着执行下面的命令创建一个用于连接数据库的synapse用户并输入你的密码\ndocker exec -it postgres16 createuser -U postgres --pwprompt synapse_user 执行下面的语句进入psql\ndocker exec -it postgres16 psql -U postgres 执行下面的建库语句用于建立一个synapse库\nCREATE DATABASE synapse ENCODING \u0026#39;UTF8\u0026#39; LC_COLLATE=\u0026#39;C\u0026#39; LC_CTYPE=\u0026#39;C\u0026#39; template=template0 OWNER synapse_user; 执行完毕后输入\\q退出 *后续连接如果有问题，可以在postgres/pg_hba.conf中 添加 host synapse synapse_user all trust\n安装synapse 先拉取docker镜像\ndocker pull matrixdotorg/synapse:latest 生成配置文件。注意根据实际修改宿主机挂载目录路径和matrix的host\ndocker run -it --rm -v /root/data/docker_data/synapse/data:/data -e SYNAPSE_SERVER_NAME=matrix.demo.com -e SYNAPSE_REPORT_STATS=yes matrixdotorg/synapse:latest generate 上面的域名（例），改为你自己的域名\n在postgresql中创建用户和数据库（默认使用sqlite，只是体验的话可以跳过）\n修改配置文件/root/data/docker_data/synapse/data/homeserver.yaml\n，注释掉原先的sqlite3配置，修改为postgres配置\n先注释文件中下面的：\n#database: #name: sqlite3 #args: # database: /data/homeserver.db 换成：\ndatabase: name: psycopg2 args: user: synapse_user password: \u0026lt;pass\u0026gt; database: synapse host: \u0026lt;host\u0026gt; #直接填入内网ip即可 cp_min: 5 cp_max: 10 在/root/data/docker_data/synapse文件夹下新建docker-compose.yaml文件，内容如下\nservices: synapse: image: matrixdotorg/synapse:latest container_name: matrix-synapse ports: - \u0026#34;8008:8008\u0026#34; volumes: - ./data:/data - ./html:/usr/local/lib/python3.11/site-packages/synapse/static networks: - matrix restart: always environment: - \u0026#34;TZ=Asia/Shanghai\u0026#34; networks: matrix: name: matrix 上面的代码有关docker 网络的知道，根据上面的代码下面说明一下：\n在你的Docker Compose文件中，你定义了一个名为\u0026quot;matrix\u0026quot;的网络。当你运行docker-compose up -d时，Docker Compose会为每个服务自动创建一个桥接网络，并在网络名称前加上服务名称的前缀。\n因此，由于你的服务名是\u0026quot;synapse\u0026quot;，实际创建的桥接网络名称会是\u0026quot;synapse_matrix\u0026quot;，（如果不加name: matrix就是这样）而不是仅仅是\u0026quot;matrix\u0026quot;。这是Docker Compose的默认行为。\n代码中： - ./html:/usr/local/lib/python3.11/site-packages/synapse/static 这是指向synapse的主页网页\n如果你想显式地指定网络名称，可以在networks部分的定义中使用name属性，例如：\nservices: synapse: image: matrixdotorg/synapse:latest container_name: matrix-synapse ports: - \u0026#34;8008:8008\u0026#34; volumes: - ./data:/data - ./html:/usr/local/lib/python3.11/site-packages/synapse/static networks: - matrix restart: always environment: - \u0026#34;TZ=Asia/Shanghai\u0026#34; networks: matrix: name: my_custom_matrix_network #因此这个name,我就写为上面的：matrix\n启动容器 docker-compose up -d 配置nginx反向代理http或https（略过）\n创建用户（默认禁止公开注册）\n根据提示输入用户名、密码、是否设置为管理员 register_new_matrix_user -c /data/homeserver.yaml \u0026lt;your matrix server host\u0026gt; cd /root/data/docker_data/synapse docker-compose exec synapse register_new_matrix_user -c /data/homeserver.yaml http://localhost:8008 安装element web客户端 访问github下载release包\n解压后，创建配置文件\ncp config.sample.json config.json 编辑config.json，设置default_server_config.m.homeserver.base_url为自己的matrix服务端地址\n配置nginx指向解压后的目录\n访问自建的element web客户端测试\n补充 允许公开注册 修改synapse的homeserver.yaml文件，设置以下参数\nenable_registration: True 重启synapse\nElement的Windows客户端指定默认服务器地址 在资源管理器中打开目录 %AppData\\Roaming\\Element%\n新建文件 config.json，输入以下内容\n{ \u0026#34;default_server_config\u0026#34;: { \u0026#34;m.homeserver\u0026#34;: { \u0026#34;base_url\u0026#34;: \u0026#34;\u0026lt;your matrix server host\u0026gt;\u0026#34; } } } 备份恢复的方法： 为了让桥接用的容器和 synapse 容器能够互相通讯， 建立一个 docker network：\ndocker network create matrix PostgreSQL pg库我选择了16版本，选择的镜像是postgres:16-alpine。\ndocker run --name postgres16 --network matrix --restart=always -v /root/data/docker_data/synapse/postgres:/var/lib/postgresql/data -e POSTGRES_PASSWORD=自定义PostgreSQL密码 -p 5432:5432 -d postgres:16-alpine 更改synapse文件夹下里的docker-compose.yml里的内容如下，直接复制替换：\nservices: synapse: image: matrixdotorg/synapse:latest container_name: matrix-synapse ports: - \u0026#34;8008:8008\u0026#34; volumes: - /root/data/docker_data/synapse/data/:/data/ - /root/data/docker_data/synapse/html/:/usr/local/lib/python3.11/site-packages/synapse/static/ networks: - matrix restart: always environment: - \u0026#34;TZ=Asia/Shanghai\u0026#34; networks: matrix: driver: bridge 运行：\ndocker-compose up -d 搞定！\n","permalink":"https://hanigege.github.io/posts/other/%E5%AE%B6%E5%BA%AD%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%B3%BB%E5%88%971synapse%E6%90%AD%E5%BB%BA/","tags":null,"title":"家庭聊天服务器系列（1）synapse搭建"},{"categories":["routers"],"contents":"\n这里使用vyos自管理容器的方法,可以获取到网卡公网ip 操作前，vyos本机先科学，不然没法接docker镜像 这种模式不可以设置单独的IP,因为使用的是vyos主机的ip\n桥接的网络如果没有，可以建一个的：原因是方便 ddns-go使用内网的网址登录 ：172.23.0.1 (可选，非必须，也可以用内外网口ip登录)\n创建桥接网络 set container network ct-network prefix \u0026#39;172.23.0.0/24\u0026#39; 提前建立好ddns的映射本地持久目录： mkdir -p /config/containers/ddns 拉取容器镜像 $ add container image \u0026#39;jeessy/ddns-go\u0026#39; 搭建ddns-go set container name ddns-go allow-host-networks #允许容器使用主机网络（host network），也就是说，容器不会有独立的网络接口，而是直接使用 VyOS 主机的网络 set container name ddns-go image \u0026#39;docker.io/jeessy/ddns-go\u0026#39; #指定该容器使用的 Docker 镜像 set container name ddns-go restart \u0026#39;always\u0026#39; set container name ddns-go volume config destination \u0026#39;/root/\u0026#39; #映射容器内的路径 set container name ddns-go volume config source \u0026#39;/config/containers/ddns\u0026#39; #映射本地的路役 查看运行是否成功有UP即成功 sudo podman ps -s sudo podman ps -a 登录管理平台 http://IP:9876 登录用户名：admin\n","permalink":"https://hanigege.github.io/posts/routers/vyos%E4%B8%8B%E5%AE%89%E8%A3%85ddns-go/","tags":null,"title":"Vyos下安装ddns-Go"},{"categories":["freebsd"],"contents":"\npkg 换源 若要获取滚动更新的包，请将 quarterly 修改为 latest。二者区别见 FreeBSD 手册。请注意，CURRENT 版本只有 latest。\n使用命令修改系统级 pkg 源使用 latest：\nsed -i \u0026#39;\u0026#39; \u0026#39;s/quarterly/latest/g\u0026#39; /etc/pkg/FreeBSD.conf 创建用户级源目录和文件：\n# mkdir -p /usr/local/etc/pkg/repos # nano /usr/local/etc/pkg/repos/mirrors.conf 中国科学技术大学开源软件镜像站（USTC）\n写入以下内容：\nustc: { url: \u0026#34;http://mirrors.ustc.edu.cn/freebsd-pkg/${ABI}/latest\u0026#34;, } FreeBSD: { enabled: no } 南京大学开源镜像站\n写入以下内容：\nnju: { url: \u0026#34;http://mirrors.nju.edu.cn/freebsd-pkg/${ABI}/latest\u0026#34;, } FreeBSD: { enabled: no } 网易开源镜像站\n写入以下内容：\n163: { url: \u0026#34;http://mirrors.163.com/freebsd-pkg/${ABI}/latest\u0026#34;, } FreeBSD: { enabled: no } ports 源：以源代码方式编译安装软件的包管理器 下载 ports 这个源是下载 ports 本身的源。等同于以前的 portsnap。\nGit 方法 须提前安装 git：\n# pkg install git 或\n# cd /usr/ports/devel/git # make install clean 然后：(如果已经安装了ports，直接运行下面的命令会报错，请继续往下看）\n# git clone --filter=tree:0 https://mirrors.ustc.edu.cn/freebsd-ports/ports.git /usr/ports 注意\n\u0026ndash;depth 1 会给服务器带来较大计算压力，请尽量使用参数 \u0026ndash;filter=tree:0。\n你收到的错误信息表明，目标路径 /usr/ports 已经存在，并且该目录不是空的。这意味着在尝试 git clone 时，Git 发现目标目录已经有内容，因此无法执行克隆操作。\n解决方法： 你可以选择以下几种方法来解决这个问题：\n删除现有的 /usr/ports 目录 如果你确认 /usr/ports 目录中的内容不再需要，可以删除该目录并重新执行 git clone：\nrm -rf /usr/ports git clone --filter=tree:0 https://mirrors.ustc.edu.cn/freebsd-ports/ports.git /usr/ports 注意： 删除目录前请确保该目录中的内容不再需要，因为这会完全清除目录及其内容。\n使用已有的 /usr/ports 目录 如果 /usr/ports 目录已经包含了一部分内容（比如已经存在的 Ports 树），你可以选择直接在该目录中进行 Git 更新，而不是重新克隆。 首先，进入 /usr/ports 目录：\ncd /usr/ports 然后，运行 Git 拉取更新：\ngit fetch --all 这将更新现有的 Ports 树，而不是重新克隆。\n使用一个不同的目录作为目标 如果你希望保留 /usr/ports 中的现有内容，可以将 Ports 树克隆到另一个目录，避免冲突。例如： git clone --filter=tree:0 https://mirrors.ustc.edu.cn/freebsd-ports/ports.git /path/to/another/directory 这样，你就可以在新的目录中获取 Ports 树，而不影响现有的 /usr/ports。\n总结： 如果 /usr/ports 目录的内容不再需要，可以删除并重新克隆。\n如果想保留现有内容，可以使用 Git 更新已有的仓库。\n如果不想影响现有内容，可以将 Ports 树克隆到另一个目录。\n","permalink":"https://hanigege.github.io/posts/freebsd/%E8%AE%A9freebsd%E5%9C%A8%E7%BB%88%E7%AB%AF%E4%B8%8B%E6%8D%A2%E6%BA%90/","tags":null,"title":"让freebsd在终端下换源"},{"categories":["freebsd"],"contents":"\n编辑/etc/login.conf，结尾处（我一般在russian段落后面）添加 chinese|Chinese Users Accounts:\\ :charset=UTF-8:\\ :lang=zh_CN.UTF-8:\\ :setenv=LC_ALL=zh_CN.UTF-8:\\ :tc=default: 之后运行 cap_mkdb /etc/login.conf pw usermod root -L chinese ","permalink":"https://hanigege.github.io/posts/freebsd/%E8%AE%A9freebsd%E5%9C%A8%E7%BB%88%E7%AB%AF%E4%B8%8B%E6%94%AF%E6%8C%81%E4%B8%AD%E6%96%87/","tags":null,"title":"让freebsd在终端下支持中文"},{"categories":["freebsd"],"contents":"\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;freebsd系统我建议是用普通用户登录使用，bash指令集只修改普通用户使用，root用户不要改。 \u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;🧱 原因一：bash 通常安装在 /usr/local/bin，而不是 /bin \u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;FreeBSD 遵循传统 Unix 的目录结构，系统核心工具位于 /bin、/sbin、/usr/bin 等，而 /usr/local/bin 是用于第三方软件的。\n如果你将 root 的 shell 改为 /usr/local/bin/bash，但 /usr/local 没挂载或出故障了，就无法登录或修复系统。\n这在 单用户模式（single user mode）或系统修复环境中 是个大问题：系统通常只挂载了根分区 /，并不会挂载 /usr。\n⸻\n🧯 原因二：系统启动时的最小可用环境中没有 bash\n系统启动早期可能 bash 还没被加载，root 就必须依赖 /bin/sh 之类的最基本 shell。 如果你用的是 bash，而 bash 又不可用，那你甚至连 shell 都打不开。\n1.安装bash cd /usr/ports/shells/bash make install clean 在/bin目录下面做一个符号连接。（这一步可以不做，可选）\nln -s /usr/local/bin/bash /bin/bash 加入bash,如果上一步做了 echo \u0026#39;/bin/bash\u0026#39; \u0026gt;\u0026gt; /etc/shells 保持默认路径的用下面的\necho \u0026#39;/usr/local/bin/bash\u0026#39; | sudo tee -a /etc/shells 4.更改用户shell(root用户不建议修改）\nchsh -s /bin/bash root 保持默认路径的用下面的 （推荐下面普能用户直接使用）\nchsh -s /usr/local/bin/bash # sudo chsh -s /usr/local/bin/bash gary 5.配置 (root)\n# vi ~/.profile 或者-保持默认路径的用下面的(普通用户）\n$ vim .bash_profile alias ls=\u0026#39;ls -G\u0026#39; #显示颜色 alias ll=\u0026#39;ls -al\u0026#39; alias rm=\u0026#39;rm -i\u0026#39; #确认删除 alias del=\u0026#39;rm -r\u0026#39; #确认删除 alias mv=\u0026#39;mv -i\u0026#39; #确认移动 6.退出重新登录即生效 请执行以下命令切换为 bash：\nexec /usr/local/bin/bash -l trzsz下需改为： 使用bash /usr/local/bin/bash -1 ","permalink":"https://hanigege.github.io/posts/freebsd/freebsd%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8bash/","tags":null,"title":"Freebsd编译安装和使用bash"},{"categories":["freebsd"],"contents":"\n开始安装，回车 直接回车 填写主机名 （可直接回车） 默认的基础上多加一个安装ports 这里我选择UFS（虚拟机我建议选UFS） 直接回车 选择GPT finish commit 开始安装 安装好后会提示设定root密码 ok 设置网络 选no ,自设置ip地址 设置完点ok ipv6直接yes 设置dns 根据自己的所在地选时区 后面是设置时间，一路回车 添加上两个自动校准网络时间的组件ntp 第一个也可以加上unbound这是本地dns (13.1系统）系统邮件用不上，关闭sendmail，新版本已经没有这一个选项了，（14.2系统）都不选： 添加新用户： 用户设置特别注意，用户名密码自行设置，用户组加入wheel外（这样才可以用sudo），其它全部默认回车 输入完密码后，后面的选项选no,直接回车即可 最后确认，输入yes ","permalink":"https://hanigege.github.io/posts/freebsd/freebsd-install/","tags":null,"title":"安装freebsd13.1流程(14.2版本的一样)"},{"categories":["linux"],"contents":"\n现在有很多便宜NAT鸡因为配置较低，所以只选用的是Alpine Linux,所以我就随便写了个教程方便使用。 安装依赖 首先先安装singbox,还有vim（方便编辑）\necho \u0026#34;@testing https://dl-cdn.alpinelinux.org/alpine/edge/testing\u0026#34; \u0026gt;\u0026gt; /etc/apk/repositories apk add sing-box@testing apk add vim rc-update add sing-box default 设置自启. 1.这里要说明一下，上面安装好后默认会自动生成启动文件/etc/init.d/sing-box , 配置文件在 /etc/sing-box/config.json\n2.如果用下面自建的，默认的就不用启动就行了，更不要设置自启动，以免冲突。 编辑这个文件：vim /etc/init.d/singbox\n#!/sbin/openrc-run command=\u0026#34;/usr/bin/sing-box\u0026#34; command_args=\u0026#34;run -c /root/config.json\u0026#34; #是您的配置文件位置 description=\u0026#34;singbox service\u0026#34; depend() { need net use logger } start() { ebegin \u0026#34;Starting singbox\u0026#34; start-stop-daemon --start --background --exec $command -- $command_args eend $? } stop() { ebegin \u0026#34;Stopping singbox\u0026#34; start-stop-daemon --stop --exec $command eend $? } 然后加入OpenRC自启动\nchmod +x /etc/init.d/singbox rc-update add singbox default service singbox start 自签证书，注意路径：\nmkdir -p /etc/hysteria \u0026amp;\u0026amp; openssl ecparam -genkey -name prime256v1 -out /etc/hysteria/private.key \u0026amp;\u0026amp; openssl req -new -x509 -days 3650 -key /etc/hysteria/private.key -out /etc/hysteria/cert.pem -subj \u0026#34;/CN=bing.com\u0026#34; 配置hy2入站服务端： { \u0026#34;log\u0026#34;: { \u0026#34;level\u0026#34;: \u0026#34;info\u0026#34; }, \u0026#34;dns\u0026#34;: { \u0026#34;servers\u0026#34;: [ {\u0026#34;address\u0026#34;: \u0026#34;8.8.8.8\u0026#34;}, {\u0026#34;address\u0026#34;: \u0026#34;1.1.1.1\u0026#34;} ] }, \u0026#34;inbounds\u0026#34;: [ { \u0026#34;type\u0026#34;: \u0026#34;hysteria2\u0026#34;, \u0026#34;listen\u0026#34;: \u0026#34;::\u0026#34;, \u0026#34;listen_port\u0026#34;: 449, \u0026#34;users\u0026#34;: [ { \u0026#34;password\u0026#34;: \u0026#34;your-strong-random-password-123\u0026#34; } ], \u0026#34;tls\u0026#34;: { \u0026#34;enabled\u0026#34;: true, \u0026#34;alpn\u0026#34;: [\u0026#34;h3\u0026#34;], \u0026#34;certificate_path\u0026#34;: \u0026#34;/etc/hysteria/cert.pem\u0026#34;, \u0026#34;key_path\u0026#34;: \u0026#34;/etc/hysteria/private.key\u0026#34; } } ], \u0026#34;outbounds\u0026#34;: [ { \u0026#34;type\u0026#34;: \u0026#34;direct\u0026#34; } ], \u0026#34;route\u0026#34;: { \u0026#34;rules\u0026#34;: [ { \u0026#34;protocol\u0026#34;: \u0026#34;dns\u0026#34;, \u0026#34;action\u0026#34;: \u0026#34;direct\u0026#34; } ] } } 配置hy2出站客户端： { \u0026#34;tag\u0026#34;: \u0026#34;sg-hy2\u0026#34;, \u0026#34;server\u0026#34;: \u0026#34;IP地址或者域名\u0026#34;, \u0026#34;server_port\u0026#34;: 449, \u0026#34;up_mbps\u0026#34;: 50, \u0026#34;down_mbps\u0026#34;: 500, \u0026#34;type\u0026#34;: \u0026#34;hysteria2\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;密码\u0026#34;, \u0026#34;tls\u0026#34;: { \u0026#34;insecure\u0026#34;: true, \u0026#34;enabled\u0026#34;: true, \u0026#34;server_name\u0026#34;: \u0026#34;\u0026#34; }, \u0026#34;tcp_fast_open\u0026#34;: false }, ","permalink":"https://hanigege.github.io/posts/linux/alpine-linux-sing-box/","tags":null,"title":"Alpine Linux搭建sing-box服务端"},{"categories":["routers"],"contents":"服务端： { \u0026#34;type\u0026#34;: \u0026#34;shadowsocks\u0026#34;, \u0026#34;listen\u0026#34;: \u0026#34;::\u0026#34;, \u0026#34;listen_port\u0026#34;: 58442, \u0026#34;method\u0026#34;: \u0026#34;chacha20-ietf-poly1305\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;Um5zktQDo6GKqM1L/lLzwg==\u0026#34;, \u0026#34;multiplex\u0026#34;: { \u0026#34;enabled\u0026#34;: true } }, 客户端： { \u0026#34;type\u0026#34;: \u0026#34;shadowsocks\u0026#34;, \u0026#34;tag\u0026#34;: \u0026#34;ss-in-jygg-ros\u0026#34;, \u0026#34;server\u0026#34;: \u0026#34;你的域名.xyz\u0026#34;, \u0026#34;server_port\u0026#34;: 58442, \u0026#34;network_strategy\u0026#34;: \u0026#34;hybrid\u0026#34;, \u0026#34;method\u0026#34;: \u0026#34;chacha20-ietf-poly1305\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;Um5zktQDo6GKqM1L/lLzwg==\u0026#34;, \u0026#34;udp_over_tcp\u0026#34;: false }, ","permalink":"https://hanigege.github.io/posts/routers/sing-box-ss-server/","tags":null,"title":"Sing-Box中的ss服务的写法配置"},{"categories":null,"contents":"三汇SMG4004-4LC的升级文件 1、先升级web固件包 install4_2.2.8_2020092516.tar.gz\n2、再升级底层固件包 install4_FPGA_1.11_2.11_3.032018122015.tar.gz\n虚拟机承接三汇和telegram收发短信的机器人启动文件 记的修改启动文件中的参数，里面有标注。sms.py\n","permalink":"https://hanigege.github.io/downloads/","tags":null,"title":"Downloads"},{"categories":["other"],"contents":"我使用的是三汇SMG4004-4LC（算是捡垃圾了，这是以前的老款），4口语音网关，目前这款只能支持2g网络和短信，我测试我这个地区只支持移动和联通。不过也够用了。 使用前需要先升能这款设备的固件，相关升级文件，本站有提供下载。 照着下面设置，就可以测试电话呼叫了： ","permalink":"https://hanigege.github.io/posts/other/sanhui-smg4004-4lc-set/","tags":null,"title":"出国自建voip(二.2)三汇SMG4004-4LC的配置方法测试电话呼叫"},{"categories":["other"],"contents":"要通过 Telegram 机器人 对接 三汇语音网关（SMG4000-C1LC） 的短信功能，您需要完成以下几个步骤：\n步骤 1： 打开 Telegram，搜索并与 BotFather 聊天。\n发送命令 /newbot 来创建一个新的机器人。\n给机器人起个名字并设置用户名。\nBotFather 会给你一个 API Token，用来与 Telegram 机器人进行交互。保存好这个 Token。\n步骤 2：配置三汇网关发送短信 三汇语音网关一般支持通过 HTTP API 或 SMTP 发送短信。首先，确保三汇网关的短信服务已经启用，并且能够通过接口发送短信。\n步骤 3：编写 Telegram 机器人和三汇网关的对接脚本 （本站有提供下载） 你需要编写一个脚本，使用 Telegram 机器人获取信息，并通过 HTTP 请求将短信发送到三汇网关。\n步骤 3.1：安装 Telegram Bot 库（例如 Python 的 python-telegram-bot）（详情，请看voip出国系列三）\n","permalink":"https://hanigege.github.io/posts/other/sanhui-telegram-bot-4/","tags":null,"title":"出国自建voip(二）创建 Telegram 机器人"},{"categories":["other"],"contents":"\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;为什么要建回家voip系统，出国后，电话就是国际长途，打电话收发短信都不方便，有没有办法可以做到通过网络传递语音和收发短信（利用telegram机器人），当然可以，手机卡可以放在国内的小设备上，自己手机上装一个sip软电话客户端，即可完全实现，接听拨打电话，收发短信，并且不会再受地域限制，仅限学习交流，友情提醒，不要做违反当地法律法规的事。 开始操作 架构 freepbx16首先修改ip为固定ip 安装好后，系统其实是dhcp动态获得ip的，进入看了看，是Centos，我们不需要dhcp，把IP给固定死\nvi /etc/sysconfig/network-scripts/ifcfg-eth0 下面的内容跟实际配置文件里的内容相对替换，一一对应替换，原文件里的内容可能更多一些，只修改下面有的，没涉及的保持原来的，dns不可以用科学的，只允许用本地，不然会影响后面系统里nat-ip获取的准确性\nTYPE=\u0026#34;Ethernet\u0026#34; BOOTPROTO=\u0026#34;static\u0026#34; IPADDR=10.8.2.60 NETMASK=255.255.255.0 GATEWAY=10.8.2.1 DNS1=114.114.114.114 DEFROUTE=\u0026#34;yes\u0026#34; NAME=\u0026#34;eth0\u0026#34; DEVICE=\u0026#34;eth0\u0026#34; ONBOOT=\u0026#34;yes\u0026#34; 重启～\nfreepbx16配置图例 freepbx16默认安装在pve系统上就好，登录系统后 ：\n先进行asterisk sip 设置 现在开始设置系统中文地区时间 选择高级设置：\n高级设置里一开始还有一个选项是启`chan_sip`,这个记的要打开，不然后面设置中继或者是sip有些选项不显示 开启中继配置 （这块设置是连接三汇语音网关的） host=dynamic port=5160 type=peer secret=666 context=from-pstn dtmfmode=rfc2833 insecure=no qualify=3000 照图填写就好，这里是内网传输使用的，端口不影响啥\n入局线路（不需要） 设置出局线路 上图X.的意思是，拨打电话时可以直接输入对方手机号码，不需要加9再拨啥的，没必要。 其它不动默认就好。\n添加中文语音提醒 ![CleanShot 2025-05-11 at 10.53.55@2x](assets/CleanShot%202025-05-11%20at%2010.53.55@2 x.png) 在上图添加上传语音文件，具体语音文件自己可以google搜索freepbx专用的中文语音 都上传完，在设置里选择china 开始配置分机 密码推荐用linux生成32位的密码 ✅ 1. openssl（推荐，常见系统默认有）\nopenssl rand -base64 24 | cut -c1-32 • 24 字节的 base64 编码大概等于 32 个字符； • cut -c1-32 保证长度正好是 32。\n✅ 2. pwgen（专门用于生成密码）\npwgen -s 32 1 -s 表示 secure（更随机），32 是长度，1 表示生成一个。\n如果没有 pwgen，可以通过如下安装：\n# Debian / Ubuntu sudo apt install pwgen # RHEL / CentOS / Rocky sudo dnf install pwgen 语音邮件打开，也就是语言留言功能，自己设置一个简单密码即可\n查看功能代码了解自己还能使用什么功能，如电话会议，闹铃回拨提醒，就跟酒店一样。 ","permalink":"https://hanigege.github.io/posts/other/freepbx16-set-all-1/","tags":null,"title":"出国自建voip(一)Freepbx16配置"},{"categories":["other"],"contents":"root@sms:~# source myenv/bin/activate 激活虚拟环境 source myenv/bin/activate (myenv) root@sms:~# nohup python sms.py \u0026gt; sms.log 2\u0026gt;\u0026amp;1 \u0026amp; 后台启动sms.py\nnohup python sms.py \u0026gt; sms.log 2\u0026gt;\u0026amp;1 \u0026amp; or nohup python sms.py \u0026gt; sms.log 2\u0026gt;\u0026amp;1 \u0026amp; (myenv) root@sms:~# 上面的两条命令能不能做成脚本，设置为开机自启动\n可以的，你可以创建一个 systemd 服务 或者 编写一个 shell 脚本 来实现 Python 虚拟环境的激活 并 运行 sms.py 脚本，同时设置为 开机自启动。\n方法 1：使用 systemd (推荐) 适用于 Debian/Ubuntu 及大多数 Linux 发行版。\n步骤 1：创建 systemd 服务文件 运行以下命令，创建 sms.service：\nnano /etc/systemd/system/sms.service 填入以下内容：\n[Unit] Description=SMS Python Service After=network.target [Service] User=root WorkingDirectory=/root ExecStart=/root/myenv/bin/python /root/sms.py Restart=always StandardOutput=append:/root/sms.log StandardError=append:/root/sms.log [Install] WantedBy=multi-user.target ⚠ 注意：\nWorkingDirectory=/root 需要修改成你的 Python 虚拟环境和 sms.py 所在目录。\nExecStart=/root/myenv/bin/python /root/sms.py 确保路径正确。\nRestart=always 让进程崩溃后自动重启。\n步骤 2：启用并启动服务\nsystemctl daemon-reload systemctl enable sms systemctl start sms 查看运行状态： systemctl status sms 如果 显示 active (running) 说明成功。 ","permalink":"https://hanigege.github.io/posts/other/telegram-sms-bot2/","tags":null,"title":"出国自建voip(三.2）Telegram机器人连接程序自启动(补充篇)"},{"categories":["other"],"contents":"前提是telegram自己的机器人提前生成好，并获取相应的密钥 打开一台虚拟机（建议debian12) 方法 1：使用虚拟环境 创建一个 Python 虚拟环境，并在其中安装所需的库。这样可以避免系统级 Python 环境的冲突。\n安装 python3-venv（如果未安装）\napt update apt install python3-venv 创建一个新的虚拟环境\npython3 -m venv myenv 激活虚拟环境\nsource myenv/bin/activate 在虚拟环境中安装 python-telegram-bot\npip install python-telegram-bot smpplib 运行脚本：你可以在虚拟环境中运行你的 Telegram 机器人脚本,脚本sms.py下载 命令：\npython sms.py 退出虚拟环境：\ndeactivate 运行脚本有三种方案，一种是运行在tmux虚拟窗口下，二种是直接本地后台运行，三种systemd进行管理 （建议第三种） 以上要运行在虚拟窗口下，建议使用tmux\n1.使用 tmux 安装（如果未安装）：\napt-get install tmux # Debian/Ubuntu yum install tmux # CentOS/RHEL 启动 Tmux 会话： tmux 按 Ctrl+B，然后按 D，会返回终端。\n关闭 SSH，程序继续运行。\n重新连接：\n列出会话：\ntmux ls 输出示例：\n0: 1 windows (created ...) 恢复会话：\ntmux attach -t 0 停止程序：\n进入会话后，按 Ctrl+C，然后：\nexit 2.使用 nohup nohup python sms.py \u0026gt; sms.log 2\u0026gt;\u0026amp;1 \u0026amp; nohup：让进程不受终端退出影响\nsms.log 2\u0026gt;\u0026amp;1：将日志输出到 sms.log\n\u0026amp;：让进程在后台运行\n查看日志：\ntail -f sms.log 如果需要停止进程：\npkill -f \u0026#34;python sms.py\u0026#34; 3.使用 systemd（推荐长期运行） 创建 systemd 服务，让 sms.py 随系统启动：\nnano /etc/systemd/system/sms.service 添加以下内容：\n[Unit] Description=SMS Bot Service After=network.target [Service] ExecStart=/usr/bin/python3 /root/sms.py WorkingDirectory=/root Restart=always User=root [Install] WantedBy=multi-user.target 然后执行：\nsystemctl daemon-reload systemctl enable sms systemctl start sms systemctl status sms 查看日志：\njournalctl -u sms -f 重启服务：\nsystemctl restart sms 停止服务：\nsystemctl stop sms ","permalink":"https://hanigege.github.io/posts/other/telegram-sms-bot/","tags":null,"title":"出国自建voip(三）连接Telegram机器人本地安装"},{"categories":["routers"],"contents":"你可以使用 delete 和 set 命令来修改 network-group 的子网。 修改 LAN-v4 的网络\n删除原来的 192.168.10.0/24 delete firewall group network-group LAN-v4 network 192.168.10.0/24 添加新的 192.168.100.0/24 set firewall group network-group LAN-v4 network 192.168.100.0/24 提交并保存 commit save 验证修改是否生效\n执行以下命令：\nshow firewall group network-group LAN-v4 如果输出如下，就说明修改成功：\nnetwork-group LAN-v4 { network 192.168.100.0/24 } 在 VyOS 中，你可以使用以下命令查看 所有配置： 显示完整的层级配置（推荐）\nshow configuration 这个命令会以 层级结构 显示整个配置，类似于 show running-config。\n显示所有配置命令（适合复制）($ 模式下）\nshow configuration commands 这个命令会以 show 命令的格式 展示所有配置，适用于备份或复制配置：\n按层级展开查看（交互式）\nshow configuration level 2 level 2 代表展开到第 2 层，你可以调整 level 数值来控制显示的详细程度。\n过滤特定配置（匹配关键字） 如果你只想查看防火墙相关的配置，可以使用：\nshow configuration | match firewall 或者：\nshow configuration commands | grep firewall 这可以帮助你快速找到特定的配置。\n导出配置到文件 如果你想把配置保存到文件：\nshow configuration commands \u0026gt; /config/my-backup.conf 然后可以用 cat 查看：\ncat /config/my-backup.conf 总结\n| 命令 | 作用 |\nshow configuration 以层级结构显示所有配置\nshow configuration commands 以 set 命令格式显示所有配置（适合复制）\nshow configuration level N 展开到指定层级（N 控制详细程度）\nshow configuration match 关键字`\nshow configuration commands \u0026gt; /config/backup.conf 备份配置到文件\n你可以使用以下方法 删除 VyOS 中所有防火墙规则： 方法 1：逐个删除 如果你知道防火墙规则的名字（例如 WAN_IN、LAN_OUT），可以运行：\ndelete firewall name WAN_IN delete firewall name LAN_OUT delete firewall name \u0026lt;其他规则名\u0026gt; commit save 然后运行： show firewall 确认规则已删除。 方法 2：删除整个 firewall 配置 如果你想 彻底删除防火墙的所有规则，可以直接删除 firewall {}：\ndelete firewall commit save 然后运行： show firewall 如果 firewall {} 不再显示，就说明所有防火墙规则已删除。 方法 3：重置 VyOS 配置（谨慎使用） 如果你希望恢复到最初的默认配置（会影响所有设置，不仅仅是防火墙），可以运行：\nload factory-default commit save 然后重新配置你的系统。\n如果只是想 清理防火墙规则，推荐 方法 2，但如果你想重置整个系统配置，再考虑 方法 3。你想要完全重置还是只是清空防火墙规则？\n","permalink":"https://hanigege.github.io/posts/routers/vyos-jiqiao-3/","tags":null,"title":"Vyos上网系统之-vyos命令技巧集(3)"},{"categories":["routers"],"contents":"对于终端网关是vyos的，通过mosdns来分流realip和fakeip的流量, 可这样配置: (vyos的group分为address-group,network-group等)\n定义组 IP例: set firewall group address-group Telegram-v4 address \u0026#39;157.148.47.204\u0026#39; set firewall group address-group Telegram-v4 address \u0026#39;182.43.124.6\u0026#39; ... 定义组网段V4例： set firewall group network-group Telegram-v4 network \u0026#39;91.108.56.0/22\u0026#39; set firewall group network-group Telegram-v4 network \u0026#39;91.108.4.0/22\u0026#39; ... 定义组telegram V4:\nset firewall group network-group Telegram-v4 network \u0026#39;91.108.56.0/22\u0026#39; set firewall group network-group Telegram-v4 network \u0026#39;91.108.4.0/22\u0026#39; set firewall group network-group Telegram-v4 network \u0026#39;91.108.8.0/22\u0026#39; set firewall group network-group Telegram-v4 network \u0026#39;91.108.16.0/22\u0026#39; set firewall group network-group Telegram-v4 network \u0026#39;91.108.12.0/22\u0026#39; set firewall group network-group Telegram-v4 network \u0026#39;149.154.160.0/20\u0026#39; set firewall group network-group Telegram-v4 network \u0026#39;91.105.192.0/23\u0026#39; set firewall group network-group Telegram-v4 network \u0026#39;91.108.20.0/22\u0026#39; set firewall group network-group Telegram-v4 network \u0026#39;185.76.151.0/24\u0026#39; 定义组ip-V6例： set firewall group ipv6-address-group Telegram-v6 address \u0026#39;2a00:1098:80:2::1004\u0026#39; set firewall group ipv6-address-group Telegram-v6 address \u0026#39;2a00:1098:80:2::1001\u0026#39; ... 定义组网段V6例：\nset firewall group ipv6-network-group Telegram-v6 network \u0026#39;2001:b28:f23d::/48\u0026#39; set firewall group ipv6-network-group Telegram-v6 network \u0026#39;2001:b28:f23f::/48\u0026#39; ... 定义组V6 Telegram-V6\nset firewall group ipv6-network-group Telegram-v6 network \u0026#39;2001:b28:f23d::/48\u0026#39; set firewall group ipv6-network-group Telegram-v6 network \u0026#39;2001:b28:f23f::/48\u0026#39; set firewall group ipv6-network-group Telegram-v6 network \u0026#39;2001:67c:4e8::/48\u0026#39; set firewall group ipv6-network-group Telegram-v6 network \u0026#39;2001:b28:f23c::/48\u0026#39; set firewall group ipv6-network-group Telegram-v6 network \u0026#39;2a0a:f280::/32\u0026#39; 定义组fakeip:\nset firewall group network-group FAKEIP-v4 network \u0026#39;198.18.0.0/15\u0026#39; # fakeip set firewall group ipv6-network-group FAKEIP-v6 network \u0026#39;f2b0::/18\u0026#39; # fakeip6 配置策略路由:(类似ros中mangle部分) IPV4\nset policy route Route-to-SB interface \u0026#39;eth0\u0026#39; # eth0是lan口 set policy route Route-to-SB rule 10 set table \u0026#39;100\u0026#39; # table 100是to-sb的表 set policy route Route-to-SB rule 10 destination group network-group \u0026#39;Telegram-v4\u0026#39; set policy route Route-to-SB rule 20 set table \u0026#39;100\u0026#39; # table 100是to-sb的表 set policy route Route-to-SB rule 20 destination group network-group \u0026#39;FAKEIP-v4\u0026#39; IPV6\nset policy route6 FAKE6-to-SB interface \u0026#39;eth0\u0026#39; set policy route6 FAKE6-to-SB rule 10 set table \u0026#39;106\u0026#39; # table 106是to-sb的表 (v6) set policy route6 FAKE6-to-SB rule 10 destination group network-group \u0026#39;FAKEIP-v6\u0026#39; set policy route6 FAKE6-to-SB rule 20 set table \u0026#39;106\u0026#39; # table 106是to-sb的表 (v6) set policy route6 FAKE6-to-SB rule 20 destination group network-group \u0026#39;Telegram-v6\u0026#39; 配置路由表\nset protocols static table 100 route 0.0.0.0/0 next-hop 192.168.100.9 # sb的内网ip set protocols static table 106 route6 ::/0 next-hop fd88::9999 # sb的ula voys自己如要科学上网, 一般是在pull容器镜像, 下载更新的ios等情形下, 可以这样配置,\nset system name-server \u0026#39;192.168.10.90\u0026#39; # 192.168.10.90是sb的ip, 或mosdns的ip, based on your topology. 注意这里的name-server, 只需要一个, 就是能区分fakeip的.\nset policy local-route rule 10 destination address \u0026#39;198.18.0.0/15\u0026#39; set policy local-route rule 10 set table \u0026#39;100\u0026#39; 可以了科学了，下面测试\ncurl www.google.com 乱码，搞定 ping是ping不通外网的。用上面的curl看\n配不配ipv6的local-route, 取决于你的需要, 不配置也行, 因为vyos自己的需要, 较为简单\ndone!\ntips:\n在\u0026rsquo;#\u0026lsquo;状态下 可用run show config, 来运行\u0026rsquo;$\u0026lsquo;状态下的命令 我常用的命令 还有 \u0026lsquo;monitor\u0026rsquo; (\u0026rsquo;$\u0026lsquo;下), 监视动态变化 \u0026lsquo;compare\u0026rsquo; (\u0026rsquo;#\u0026lsquo;下), 未commit前比较edit的变化 ","permalink":"https://hanigege.github.io/posts/routers/vyos-fakeip-2/","tags":null,"title":"Vyos上网系列之-Fakeip配置(2)"},{"categories":["routers"],"contents":"vyos的命令行界面是基于shell的，没有图形界面, 但是可以用tab自动补全. 本文的vyos命令是基于vyos的vyos-rolling-nightly-builds的1.5.x版本.\n**特别感谢大卫佬给予的指导与帮助**\npve安装vyos: 下载nightly-build: https://github.com/vyos/vyos-nightly-build/releases pve的虚拟机设置和安装(略), 建议内存2G, 磁盘10G或更大, 因为vyos可以运行容器, vyos用podman管理容器.\nvm运行后, 用vyos:vyos登录. 用命令\ninstall image 安装vyos.\n进入配置模式：\nconfigure 生效：\ncommit 保存配置：\nsave 取消生效的,未保存的配置：\ndiscard 下面开始配置，随时都可以输入生效命令，如果不保存，重启后配置会失效 设置ssh登录:\nset service ssh port \u0026#39;22\u0026#39; 创建用户gary:\nset system login user gary full-name gary set system login user gary authentication plaintext-password \u0026#39;密码\u0026#39; 建议ssh密钥登录:\nset system login user gary authentication public-keys gary@laptop key \u0026#39;your-public-key\u0026#39; set system login user gary authentication public-keys gary@laptop type \u0026#39;ssh-rsa\u0026#39; 禁用默认的vyos用户:\nset system login user vyos disable 设置系统的hostname:\nset system host-name \u0026#39;vyos\u0026#39; 查看系统的hostname\nshow system host-name 设置时区:\nset system time-zone \u0026#39;Asia/Shanghai\u0026#39; 设置ntp:\nset service ntp server 129.250.35.251 set service ntp server 203.107.6.88 (注: 可以设置多个ntp服务器, 建议用运营商的ntp服务器, 最好是纯ip, 可删除默认的ntp服务器)\n设置接口组(可选但建议):\nset firewall group interface-group LAN interface \u0026#39;eth0\u0026#39; set firewall group interface-group WAN interface \u0026#39;eth1\u0026#39; 设置网络组(可选):\nset firewall group network-group LAN-v4 network \u0026#39;192.168.100.0/24\u0026#39; 设置ip:\nset interfaces ethernet eth0 address 192.168.100.1/24 配置dhcp server:\nset service dhcp-server shared-network-name VYOS subnet 192.168.100.0/24 subnet-id 1 set service dhcp-server hostfile-update set service dhcp-server shared-network-name VYOS authoritative #开启特定共享网络的授权，防止出现冲突和混乱(第三方加的） set service dhcp-server shared-network-name VYOS subnet 192.168.100.0/24 lease \u0026#39;86400\u0026#39; set service dhcp-server shared-network-name VYOS subnet 192.168.100.0/24 option default-router \u0026#39;192.168.100.1\u0026#39; #dhcp option 默认网关 set service dhcp-server shared-network-name VYOS subnet 192.168.100.0/24 option name-server \u0026#39;192.168.100.1\u0026#39; #dhcp option dns set service dhcp-server shared-network-name VYOS subnet 192.168.100.0/24 option ntp-server \u0026#39;192.168.100.1\u0026#39; #dhcp option ntp set service dhcp-server shared-network-name VYOS subnet 192.168.100.0/24 range 0 start \u0026#39;192.168.100.101\u0026#39; set service dhcp-server shared-network-name VYOS subnet 192.168.100.0/24 range 0 stop \u0026#39;192.168.100.200\u0026#39; 补充（可选）： 添加一个dhcp下的dns\nset service dhcp-server shared-network-name VYOS subnet 192.168.100.0/24 option name-server \u0026#39;192.168.100.2\u0026#39; 删除一个dpcp下的dns delete service dhcp-server shared-network-name VYOS subnet 192.168.100.0/24 option name-server \u0026#39;192.168.100.1\u0026#39; 更改dhcp下的网关地址 set service dhcp-server shared-network-name VYOS subnet 192.168.100.0/24 option default-router \u0026#39;192.168.100.2\u0026#39; 设置外网网口为dhcp客户端，从上级路由获取 （可选）：\nset interfaces ethernet eth1 address dhcp 设置pppoe1参考配置（一） 当eth1是pppoe时，配置 PPPoE 拨号:\nset interfaces pppoe pppoe0 source-interface \u0026#39;eth1\u0026#39; set interfaces pppoe pppoe0 authentication username \u0026#39;054546帐号6266\u0026#39; set interfaces pppoe pppoe0 authentication password \u0026#39;24密码502\u0026#39; set interfaces pppoe pppoe0 mtu \u0026#39;1492\u0026#39; set interfaces pppoe pppoe0 ip adjust-mss \u0026#39;clamp-mss-to-pmtu\u0026#39; set interfaces pppoe pppoe1 no-default-route (注: 当设置no-default-route时, 需要在后面指定静态路由, 或者也可不设置no-default-route这条, vyos会自动添加默认路由) 小技巧：在 VyOS 中，要删除一条已有的配置，需要使用 delete 命令。 对于 set interfaces pppoe pppoe0 source-interface 'eth1'，可以这样删除：\nconfigure delete interfaces pppoe pppoe1 source-interface commit save exit 设置出Wan口的默认静态路由:\nset protocols static route 0.0.0.0/0 interface pppoe0 set protocols static route6 ::/0 interface pppoe0 (注: 前面设置了no-default-route, 所以这里需要设置默认路由) 设置dns: set system name-server \u0026#39;223.5.5.5\u0026#39; set service dns forwarding cache-size \u0026#39;0\u0026#39; ## 关闭了缓存，默认是150 set service dns forwarding listen-address \u0026#39;192.168.100.1\u0026#39; ## 监听 LAN 口 # 3. 限制 DNS 解析范围，仅允许内网使用 set service dns forwarding allow-from \u0026#39;192.168.100.0/24\u0026#39; 设置端口转发(DNAT):\nset nat destination rule 10 description \u0026#39;DSTNAT-wg\u0026#39; set nat destination rule 10 destination port \u0026#39;53822\u0026#39; set nat destination rule 10 inbound-interface group \u0026#39;WAN\u0026#39; #可用interface eth1代替 set nat destination rule 10 protocol \u0026#39;udp\u0026#39; set nat destination rule 10 translation address \u0026#39;192.168.10.145\u0026#39; set nat destination rule 10 translation port \u0026#39;53822\u0026#39; #可省略, 如果端口相同 设置防火墙: 设置masquerade(SNAT):\nset nat source rule 100 translation address \u0026#39;masquerade\u0026#39; 指定网段：\nset nat source rule 100 source address \u0026#39;192.168.100.0/24\u0026#39; 设置回流: 由于上面masquerade(SNAT)的规则, 这里不需要设置回流. --------------------------------------------- 这里防火墙rule 数字可自定, 同一数字为一组, 建议设置数字时, 留出空隙, 以便以后添加新的规则. 针对上面这条nat source rule 100 规则, 建议不要限制接口, 就只用上面一条, 这对以后的端口转发和回流设置, 都很方便.\n设置防火墙规则: 全局：\nset firewall global-options state-policy established action \u0026#39;accept\u0026#39; set firewall global-options state-policy invalid action \u0026#39;drop\u0026#39; set firewall global-options state-policy related action \u0026#39;accept\u0026#39; #下面一条是容器与内网互通 set firewall global-options apply-to-bridged-traffic invalid-connections 设置ipv4入站(input链)规则:\nset firewall ipv4 name WAN_LOCAL default-action \u0026#39;drop\u0026#39; #默认拒绝 set firewall ipv4 name WAN_LOCAL rule 10 action \u0026#39;accept\u0026#39; #允许已建立和相关连接 set firewall ipv4 name WAN_LOCAL rule 10 state \u0026#39;established\u0026#39; set firewall ipv4 name WAN_LOCAL rule 10 state \u0026#39;related\u0026#39; set firewall ipv4 name WAN_LOCAL rule 30 action \u0026#39;accept\u0026#39; #允许icmp set firewall ipv4 name WAN_LOCAL rule 30 protocol \u0026#39;icmp\u0026#39; 下面是wireguard放行端口（可选）\nset firewall ipv4 name WAN_LOCAL rule 20 action \u0026#39;accept\u0026#39; #允许连接wg0 set firewall ipv4 name WAN_LOCAL rule 20 destination port \u0026#39;11133\u0026#39; set firewall ipv4 name WAN_LOCAL rule 20 protocol \u0026#39;udp\u0026#39; set firewall ipv4 name WAN_LOCAL rule 40 action \u0026#39;accept\u0026#39; #连续端口样例 set firewall ipv4 name WAN_LOCAL rule 40 destination port \u0026#39;10000-10100\u0026#39; set firewall ipv4 name WAN_LOCAL rule 40 protocol \u0026#39;udp\u0026#39; 设置ipv6入站(input链)规则:\nset firewall ipv6 name WAN_LOCAL default-action \u0026#39;drop\u0026#39; #默认拒绝 set firewall ipv6 name WAN_LOCAL rule 10 action \u0026#39;accept\u0026#39; #允许已建立和相关连接 set firewall ipv6 name WAN_LOCAL rule 10 state \u0026#39;established\u0026#39; set firewall ipv6 name WAN_LOCAL rule 10 state \u0026#39;related\u0026#39; set firewall ipv6 name WAN_LOCAL rule 20 action \u0026#39;accept\u0026#39; #允许icmpv6 set firewall ipv6 name WAN_LOCAL rule 20 protocol \u0026#39;icmpv6\u0026#39; set firewall ipv6 name WAN_LOCAL rule 30 action \u0026#39;accept\u0026#39; #允许从ISP处获取的dhcp6的信息 set firewall ipv6 name WAN_LOCAL rule 30 destination port \u0026#39;546\u0026#39; set firewall ipv6 name WAN_LOCAL rule 30 protocol \u0026#39;udp\u0026#39; set firewall ipv6 name WAN_LOCAL rule 30 source port \u0026#39;547\u0026#39; 下面是wireguard放行端口（可选）\nset firewall ipv6 name WAN_LOCAL rule 40 action \u0026#39;accept\u0026#39; #允许连接wg0 set firewall ipv6 name WAN_LOCAL rule 40 destination port \u0026#39;11133\u0026#39; set firewall ipv6 name WAN_LOCAL rule 40 protocol \u0026#39;udp\u0026#39; 设置ipv4转发(forward链)规则:\nset firewall ipv4 name WAN_IN default-action \u0026#39;drop\u0026#39; #默认拒绝 set firewall ipv4 name WAN_IN rule 10 action \u0026#39;accept\u0026#39; #允许已建立和相关连接 set firewall ipv4 name WAN_IN rule 10 state \u0026#39;established\u0026#39; set firewall ipv4 name WAN_IN rule 10 state \u0026#39;related\u0026#39; 如有ipv4进来后的端口转发加下面三条\nset firewall ipv4 name WAN_IN rule 20 action \u0026#39;accept\u0026#39; #允许已DNAT的连接 set firewall ipv4 name WAN_IN rule 20 connection-status nat \u0026#39;destination\u0026#39; set firewall ipv4 name WAN_IN rule 20 state \u0026#39;new\u0026#39; 如有ipv6进来后的端口转发 也需要和v4一样 加这条\nset firewall ipv6 name WAN_IN rule 40 action \u0026#39;accept\u0026#39; set firewall ipv6 name WAN_IN rule 40 connection-status nat \u0026#39;destination\u0026#39; set firewall ipv6 name WAN_IN rule 40 state \u0026#39;new\u0026#39; 设置ipv6转发(forward链)规则:\nset firewall ipv6 name WAN_IN default-action \u0026#39;drop\u0026#39; #默认拒绝 set firewall ipv6 name WAN_IN rule 10 action \u0026#39;accept\u0026#39; #允许已建立和相关连接 set firewall ipv6 name WAN_IN rule 10 state \u0026#39;established\u0026#39; set firewall ipv6 name WAN_IN rule 10 state \u0026#39;related\u0026#39; set firewall ipv6 name WAN_IN rule 20 action \u0026#39;accept\u0026#39; #允许icmpv6 set firewall ipv6 name WAN_IN rule 20 protocol \u0026#39;icmpv6\u0026#39; set firewall ipv6 name WAN_IN rule 30 action \u0026#39;accept\u0026#39; #允许ipsec set firewall ipv6 name WAN_IN rule 30 destination port \u0026#39;500,4500\u0026#39; set firewall ipv6 name WAN_IN rule 30 protocol \u0026#39;udp\u0026#39; 然后分别从input和forward链, 调用WAN_LOCAL和WAN_IN:\nset firewall ipv4 input filter rule 10 action \u0026#39;jump\u0026#39; set firewall ipv4 input filter rule 10 inbound-interface group \u0026#39;WAN\u0026#39; set firewall ipv4 input filter rule 10 jump-target \u0026#39;WAN_LOCAL\u0026#39; set firewall ipv4 forward filter rule 10 action \u0026#39;jump\u0026#39; set firewall ipv4 forward filter rule 10 inbound-interface group \u0026#39;WAN\u0026#39; set firewall ipv4 forward filter rule 10 jump-target \u0026#39;WAN_IN\u0026#39; set firewall ipv6 input filter rule 10 action \u0026#39;jump\u0026#39; set firewall ipv6 input filter rule 10 inbound-interface group \u0026#39;WAN\u0026#39; set firewall ipv6 input filter rule 10 jump-target \u0026#39;WAN_LOCAL\u0026#39; set firewall ipv6 forward filter rule 10 action \u0026#39;jump\u0026#39; set firewall ipv6 forward filter rule 10 inbound-interface group \u0026#39;WAN\u0026#39; set firewall ipv6 forward filter rule 10 jump-target \u0026#39;WAN_IN\u0026#39; 注: DNAT是流量进入后, 最先处理的, 然后进入forward链, 而SNAT是流量出站前, 最后处理的.\n配置wireguard: set interfaces wireguard wg0 address \u0026#39;10.20.20.1/24\u0026#39; set interfaces wireguard wg0 peer iphone allowed-ips \u0026#39;10.20.20.2/32\u0026#39; set interfaces wireguard wg0 peer iphone preshared-key \u0026#39;preshared-key\u0026#39; set interfaces wireguard wg0 peer iphone public-key \u0026#39;public-key\u0026#39; set interfaces wireguard wg0 port \u0026#39;11133\u0026#39; set interfaces wireguard wg0 private-key \u0026#39;private-key\u0026#39; 配置ddns: cloudflare ddns: set service dns dynamic name DDNS-CF-v4 address interface \u0026#39;pppoe1\u0026#39; set service dns dynamic name DDNS-CF-v4 host-name \u0026#39;ddns.example.com\u0026#39; set service dns dynamic name DDNS-CF-v4 ip-version \u0026#39;ipv4\u0026#39; set service dns dynamic name DDNS-CF-v4 password \u0026#39;token\u0026#39; set service dns dynamic name DDNS-CF-v4 protocol \u0026#39;cloudflare\u0026#39; set service dns dynamic name DDNS-CF-v4 zone \u0026#39;example.com\u0026#39; set service dns dynamic name DDNS-CF-v6 address interface \u0026#39;eth0\u0026#39; set service dns dynamic name DDNS-CF-v6 host-name \u0026#39;ddns6.example.com\u0026#39; set service dns dynamic name DDNS-CF-v6 ip-version \u0026#39;ipv6\u0026#39; set service dns dynamic name DDNS-CF-v6 password \u0026#39;token\u0026#39; set service dns dynamic name DDNS-CF-v6 protocol \u0026#39;cloudflare\u0026#39; set service dns dynamic name DDNS-CF-v6 zone \u0026#39;example.com\u0026#39; dnspod ddns:\nset service dns dynamic name DNSPOD-v4 address interface \u0026#39;pppoe1\u0026#39; set service dns dynamic name DNSPOD-v4 host-name \u0026#39;ddns.example.com\u0026#39; set service dns dynamic name DNSPOD-v4 password \u0026#39;token\u0026#39; set service dns dynamic name DNSPOD-v4 protocol \u0026#39;dyndns2\u0026#39; set service dns dynamic name DNSPOD-v4 server \u0026#39;dnsapi.cn\u0026#39; set service dns dynamic name DNSPOD-v4 username \u0026#39;id\u0026#39; 个人使用下来, 上述配置并不需要设置interval, ip变化也会自动更新. 设置策略路由: 举例: 让wg0的流量走100号路由表, 100号路由表是sb的路由表\nset policy route WG0-to-SB interface \u0026#39;wg0\u0026#39; set policy route WG0-to-SB rule 10 destination group network-group \u0026#39;!LAN-v4\u0026#39; set policy route WG0-to-SB rule 10 set table \u0026#39;100\u0026#39; 路由表\nset protocols static table 100 route 0.0.0.0/0 next-hop 192.168.10.90 Happy Routing!\n","permalink":"https://hanigege.github.io/posts/routers/vyos-jibenshangwang-1/","tags":null,"title":"Vyos上网系列之-上网配置（1）"},{"categories":null,"contents":" ","permalink":"https://hanigege.github.io/about/","tags":null,"title":"About"},{"categories":["routers"],"contents":"一.基本上网配置 vyos的命令行界面是基于shell的，没有图形界面, 但是可以用tab自动补全 本文的vyos命令是基于vyos的vyos-rolling-nightly-builds的1.5.x版本.\npve安装vyos: 下载安装包 pve的虚拟机设置和安装(略), 建议内存2G, 磁盘10G或更大, 因为vyos可以运行容器, vyos除自己的容器管理工具以外，也可以用podman管理容器. vm运行后, 用vyos:vyos登录. 用下面命令安装:\ninstall image 2.安装vyos. 进入配置模式：\nconfigure 生效：\ncommit 保存配置：\nsave 取消未commit生效的,未保存的配置：\ndiscard 延时确认：如2分钟后不确认，配置回滚到上一配置\ncommit-confirm 2 回滚后 dircard 清除上次没有commit配置。(因为commit-confirm 2后已经输入过了，只是没有commit提交) 如果提前提效确认，直接输入：\nconfirm 设置ssh登录:\nset service ssh port \u0026#39;22\u0026#39; 创建用户gary:\nset system login user gary full-name gary set system login user gary authentication plaintext-password \u0026#39;密码\u0026#39; 建议ssh密钥登录:(可选，非必须，熟练后再使用）\nset system login user gary authentication public-keys gary@laptop key \u0026#39;your-public-key\u0026#39; set system login user gary authentication public-keys gary@laptop type \u0026#39;ssh-rsa\u0026#39; 禁用默认的vyos用户:\nset system login user vyos disable 设置系统的hostname:\nset system host-name \u0026#39;vyos\u0026#39; 查看系统的hostname\nshow system host-name 设置时区:\nset system time-zone \u0026#39;Asia/Shanghai\u0026#39; 设置ntp:\nset service ntp server 129.250.35.251 set service ntp server 203.107.6.88 (注: 可以设置多个ntp服务器, 建议用运营商的ntp服务器, 最好是纯ip, 可删除默认的ntp服务器)\n先看下自己的接口情况，有的不是eht0和eth1。。。有的直接就是eth0和eht2,所以请根据自己小主机的情况调整后面的命令接口。\nshow interface 下面的教程按标准的eht0,eth1,eth2,eth3四网口来说明： WAN/LAN 接口配置 进入配置模式 首先，进入 VyOS 配置模式：\nconfigure 创建桥接接口（br0） 接着，创建一个桥接接口 br0，并将 eth0、eth1 和 eth2 加入该桥接组：\nset interfaces bridge br0 address \u0026#39;10.20.20.1/24\u0026#39; set interfaces bridge br0 address \u0026#39;fd88::1111/64\u0026#39; set interfaces bridge br0 member interface \u0026#39;eth0\u0026#39; set interfaces bridge br0 member interface \u0026#39;eth1\u0026#39; set interfaces bridge br0 member interface \u0026#39;eth2\u0026#39; 3. 、 LAN 配置 DHCP 3.1 启用 LAN 口的 DHCP server LAN 的网段是 10.20.20.0/24，DHCP 的分配 IP 范围是 10.20.20.100-200，同时下发了 dns server 和 ntp server。\nset service dhcp-server hostfile-update set service dhcp-server shared-network-name LAN_br0 authoritative set service dhcp-server shared-network-name LAN_br0 option ntp-server \u0026#39;10.20.20.1\u0026#39; set service dhcp-server shared-network-name LAN_br0 option time-zone \u0026#39;Asia/Shanghai\u0026#39; set service dhcp-server shared-network-name LAN_br0 subnet 10.20.20.0/24 lease \u0026#39;86400\u0026#39; set service dhcp-server shared-network-name LAN_br0 subnet 10.20.20.0/24 option default-router \u0026#39;10.20.20.1\u0026#39; set service dhcp-server shared-network-name LAN_br0 subnet 10.20.20.0/24 option name-server \u0026#39;10.20.20.6\u0026#39; set service dhcp-server shared-network-name LAN_br0 subnet 10.20.20.0/24 range 100 start \u0026#39;10.20.20.100\u0026#39; set service dhcp-server shared-network-name LAN_br0 subnet 10.20.20.0/24 range 100 stop \u0026#39;10.20.20.200\u0026#39; set service dhcp-server shared-network-name LAN_br0 subnet 10.20.20.0/24 subnet-id \u0026#39;1\u0026#39; 设置固定IP set service dhcp-server shared-network-name LAN_br0 subnet 10.20.20.0/24 static-mapping freepbx16 ip-address \u0026#39;10.20.20.103\u0026#39; set service dhcp-server shared-network-name LAN_br0 subnet 10.20.20.0/24 static-mapping freepbx16 mac \u0026#39;bc:24:11:c4:6f:eb\u0026#39; 补充：(这下面的命令只是方便更改复制使用）\n# 添加一个dns (这个dns是我后续不折腾佬的smbox的IP） set service dhcp-server shared-network-name LAN_br0 subnet 10.20.20.0/24 option name-server \u0026#39;172.23.0.99\u0026#39; # 添加一个dns (这个dns是我后续自己虚拟机mosdns的ip) set service dhcp-server shared-network-name LAN_br0 subnet 10.20.20.0/24 option name-server \u0026#39;10.20.20.6\u0026#39; # 删除一个dns delete service dhcp-server shared-network-name LAN_br0 subnet 10.20.20.0/24 option name-server \u0026#39;10.20.20.1\u0026#39; # 更改网关 （这个网关是我后续sing-box的IP） set service dhcp-server shared-network-name LAN_br0 subnet 10.20.20.0/24 option default-router \u0026#39;10.20.20.9\u0026#39; 3.2 局域网 DNS 配置 set system name-server \u0026#39;223.5.5.5\u0026#39; set service dns forwarding allow-from \u0026#39;10.20.20.0/24\u0026#39; set service dns forwarding listen-address \u0026#39;10.20.20.1\u0026#39; set service dns forwarding cache-size \u0026#39;0\u0026#39; ## 关闭了缓存 3.4 内网设备隐藏上网 masquerade(SNAT): masquerade\nset nat source rule 100 translation address \u0026#39;masquerade\u0026#39; 指定网段：（可选） 可以不用！用了会限制wg.或者再添加wg网段等，不会就不要用！\nset nat source rule 100 source address \u0026#39;10.20.20.0/24\u0026#39; 设置回流: 由于上面masquerade(SNAT)的规则, 这里不需要设置回流.\n到这一步基本的局域网配置就已经可以了，其他设备加入就可以自动dhcp获取 ip 并上网了。\n四、QoS 流量管理（可选）\nVyos 提供了非常完善的 Qos Policy，常见的流量策略都支持。家用不用那么麻烦直接使用 Cake 仅需要设置一下带宽，要注意的是启用 Qos 会占用 CPU，同时可能会导致带宽跑不满。好处是多人占用带宽时，可以为每一个人合理分配宽带资源。\nset qos policy cake Qos_Cake_Lan bandwidth \u0026#39;1gbit\u0026#39; set qos policy cake Qos_Cake_Lan description \u0026#39;Qos For Lan interface br0\u0026#39; set qos policy cake Qos_Cake_Lan flow-isolation dual-src-host set qos policy cake Qos_Cake_Lan rtt \u0026#39;100\u0026#39; set qos interface br0 egress \u0026#39;Qos_Cake_Lan\u0026#39; 五、防火墙 这里防火墙rule 数字可自定, 同一数字为一组, 建议设置数字时, 留出空隙, 以便以后添加新的规则. 针对上面这条nat source rule 100 规则, 建议不要限制接口, 就只用上面一条, 这对以后的端口转发和回流设置, 都很方便. 设置防火墙规则:\n全局：\nset firewall global-options state-policy established action \u0026#39;accept\u0026#39; set firewall global-options state-policy invalid action \u0026#39;drop\u0026#39; set firewall global-options state-policy related action \u0026#39;accept\u0026#39; set firewall global-options apply-to-bridged-traffic invalid-connections 上面第四条也就是最后一条，作用是容器与内网互通（桥接）\n设置ipv4入站(input链)规则:\nset firewall ipv4 name WAN_LOCAL default-action \u0026#39;drop\u0026#39; #默认拒绝 set firewall ipv4 name WAN_LOCAL rule 10 action \u0026#39;accept\u0026#39; #允许已建立和相关连接 set firewall ipv4 name WAN_LOCAL rule 10 state \u0026#39;established\u0026#39; set firewall ipv4 name WAN_LOCAL rule 10 state \u0026#39;related\u0026#39; set firewall ipv4 name WAN_LOCAL rule 30 action \u0026#39;accept\u0026#39; #允许icmp set firewall ipv4 name WAN_LOCAL rule 30 protocol \u0026#39;icmp\u0026#39; 下面是wireguard放行端口（可选）\nset firewall ipv4 name WAN_LOCAL rule 20 description \u0026#34;Allow WireGuard\u0026#34; set firewall ipv4 name WAN_LOCAL rule 20 action \u0026#39;accept\u0026#39; #允许连接wg0 set firewall ipv4 name WAN_LOCAL rule 20 destination port \u0026#39;11133\u0026#39; set firewall ipv4 name WAN_LOCAL rule 20 protocol \u0026#39;udp\u0026#39; #下面是放行连续端口样例：（例）\nset firewall ipv4 name WAN_LOCAL rule 40 action \u0026#39;accept\u0026#39; #连续端口样例 set firewall ipv4 name WAN_LOCAL rule 40 destination port \u0026#39;10000-10100\u0026#39; set firewall ipv4 name WAN_LOCAL rule 40 protocol \u0026#39;udp\u0026#39; 设置ipv6入站(input链)规则:\nset firewall ipv6 name WAN_LOCAL default-action \u0026#39;drop\u0026#39; #默认拒绝 set firewall ipv6 name WAN_LOCAL rule 10 action \u0026#39;accept\u0026#39; #允许已建立和相关连接 set firewall ipv6 name WAN_LOCAL rule 10 state \u0026#39;established\u0026#39; set firewall ipv6 name WAN_LOCAL rule 10 state \u0026#39;related\u0026#39; set firewall ipv6 name WAN_LOCAL rule 20 action \u0026#39;accept\u0026#39; #允许icmpv6 set firewall ipv6 name WAN_LOCAL rule 20 protocol \u0026#39;icmpv6\u0026#39; set firewall ipv6 name WAN_LOCAL rule 30 action \u0026#39;accept\u0026#39; #允许从ISP处获取的dhcp6的信息 set firewall ipv6 name WAN_LOCAL rule 30 destination port \u0026#39;546\u0026#39; set firewall ipv6 name WAN_LOCAL rule 30 protocol \u0026#39;udp\u0026#39; set firewall ipv6 name WAN_LOCAL rule 30 source port \u0026#39;547\u0026#39; 下面是wireguard放行端口（可选)\nset firewall ipv6 name WAN_LOCAL rule 40 description \u0026#34;Allow WireGuard set firewall ipv6 name WAN_LOCAL rule 40 action \u0026#39;accept\u0026#39; #允许连接wg0 set firewall ipv6 name WAN_LOCAL rule 40 destination port \u0026#39;11133\u0026#39; set firewall ipv6 name WAN_LOCAL rule 40 protocol \u0026#39;udp\u0026#39; 设置ipv4转发(forward链)规则:\nset firewall ipv4 name WAN_IN default-action \u0026#39;drop\u0026#39; #默认拒绝 set firewall ipv4 name WAN_IN rule 10 action \u0026#39;accept\u0026#39; #允许已建立和相关连接 set firewall ipv4 name WAN_IN rule 10 state \u0026#39;established\u0026#39; set firewall ipv4 name WAN_IN rule 10 state \u0026#39;related\u0026#39; 设置ipv6转发(forward链)规则:\nset firewall ipv6 name WAN_IN default-action \u0026#39;drop\u0026#39; #默认拒绝 set firewall ipv6 name WAN_IN rule 10 action \u0026#39;accept\u0026#39; #允许已建立和相关连接 set firewall ipv6 name WAN_IN rule 10 state \u0026#39;established\u0026#39; set firewall ipv6 name WAN_IN rule 10 state \u0026#39;related\u0026#39; set firewall ipv6 name WAN_IN rule 20 action \u0026#39;accept\u0026#39; #允许icmpv6 set firewall ipv6 name WAN_IN rule 20 protocol \u0026#39;icmpv6\u0026#39; 下面三条输入，nat端口后不用再在防火墙里打开放行端口，nat优先放行\nIPV4：\nset firewall ipv4 name WAN_IN rule 20 action \u0026#39;accept\u0026#39; #允许已DNAT的连接 set firewall ipv4 name WAN_IN rule 20 connection-status nat \u0026#39;destination\u0026#39; set firewall ipv4 name WAN_IN rule 20 state \u0026#39;new\u0026#39; 下面三条输入，nat端口后不用再在防火墙里打开放行端口，nat优先放行 IPV6：\nset firewall ipv6 name WAN_IN rule 40 action \u0026#39;accept\u0026#39; set firewall ipv6 name WAN_IN rule 40 connection-status nat \u0026#39;destination\u0026#39; set firewall ipv6 name WAN_IN rule 40 state \u0026#39;new\u0026#39; 放行ipsec端口（举例：）\nset firewall ipv6 name WAN_IN rule 30 action \u0026#39;accept\u0026#39; #允许ipsec set firewall ipv6 name WAN_IN rule 30 destination port \u0026#39;500,4500\u0026#39; set firewall ipv6 name WAN_IN rule 30 protocol \u0026#39;udp\u0026#39; 然后分别从input和forward链, 调用WAN_LOCAL和WAN_IN: 设置接口组:\nset firewall group interface-group WAN interface \u0026#39;eth3\u0026#39; set firewall group interface-group WAN interface \u0026#39;pppoe1\u0026#39; 然后分别从input和forward链, 调用WAN_LOCAL和WAN_IN:\nset firewall ipv4 input filter rule 10 action \u0026#39;jump\u0026#39; set firewall ipv4 input filter rule 10 inbound-interface group \u0026#39;WAN\u0026#39; set firewall ipv4 input filter rule 10 jump-target \u0026#39;WAN_LOCAL\u0026#39; set firewall ipv4 forward filter rule 10 action \u0026#39;jump\u0026#39; set firewall ipv4 forward filter rule 10 inbound-interface group \u0026#39;WAN\u0026#39; set firewall ipv4 forward filter rule 10 jump-target \u0026#39;WAN_IN\u0026#39; set firewall ipv6 input filter rule 10 action \u0026#39;jump\u0026#39; set firewall ipv6 input filter rule 10 inbound-interface group \u0026#39;WAN\u0026#39; set firewall ipv6 input filter rule 10 jump-target \u0026#39;WAN_LOCAL\u0026#39; set firewall ipv6 forward filter rule 10 action \u0026#39;jump\u0026#39; set firewall ipv6 forward filter rule 10 inbound-interface group \u0026#39;WAN\u0026#39; set firewall ipv6 forward filter rule 10 jump-target \u0026#39;WAN_IN\u0026#39; 说明: DNAT（转发的端口）是流量进入后, 最先处理的, 然后进入forward链, 而SNAT是流量出站前, 最后处理的. 下面只是根据自己的情况复制选用：\n留个pppoe接口（例） set firewall ipv4 input filter rule 10 action \u0026#39;jump\u0026#39; set firewall ipv4 input filter rule 10 inbound-interface name pppoe1 set firewall ipv4 input filter rule 10 jump-target \u0026#39;WAN_LOCAL\u0026#39; set firewall ipv4 forward filter rule 10 action \u0026#39;jump\u0026#39; set firewall ipv4 forward filter rule 10 inbound-interface name pppoe1 set firewall ipv4 forward filter rule 10 jump-target \u0026#39;WAN_IN\u0026#39; set firewall ipv6 input filter rule 10 action \u0026#39;jump\u0026#39; set firewall ipv6 input filter rule 10 inbound-interface name pppoe1 set firewall ipv6 input filter rule 10 jump-target \u0026#39;WAN_LOCAL\u0026#39; set firewall ipv6 forward filter rule 10 action \u0026#39;jump\u0026#39; set firewall ipv6 forward filter rule 10 inbound-interface name pppoe1 set firewall ipv6 forward filter rule 10 jump-target \u0026#39;WAN_IN\u0026#39; ETH3 wan口（例） set firewall ipv4 input filter rule 10 action \u0026#39;jump\u0026#39; set firewall ipv4 input filter rule 10 inbound-interface name eth3 set firewall ipv4 input filter rule 10 jump-target \u0026#39;WAN_LOCAL\u0026#39; set firewall ipv4 forward filter rule 10 action \u0026#39;jump\u0026#39; set firewall ipv4 forward filter rule 10 inbound-interface name eth3 set firewall ipv4 forward filter rule 10 jump-target \u0026#39;WAN_IN\u0026#39; set firewall ipv6 input filter rule 10 action \u0026#39;jump\u0026#39; set firewall ipv6 input filter rule 10 inbound-interface name eth3 set firewall ipv6 input filter rule 10 jump-target \u0026#39;WAN_LOCAL\u0026#39; v set firewall ipv6 forward filter rule 10 action \u0026#39;jump\u0026#39; set firewall ipv6 forward filter rule 10 inbound-interface name eth3 set firewall ipv6 forward filter rule 10 jump-target \u0026#39;WAN_IN\u0026#39; IPV4端口转发（样例配置）：NAT端口转发 (配置样例）（不用下接口）\nconfigure # Synapse (TCP 12335) set nat destination rule 10 description \u0026#39;synapse\u0026#39; set nat destination rule 10 destination port \u0026#39;12335\u0026#39; set nat destination rule 10 protocol \u0026#39;tcp\u0026#39; set nat destination rule 10 translation address \u0026#39;10.20.20.8\u0026#39; set nat destination rule 10 translation port \u0026#39;12335\u0026#39; # 同一个端口不填也可以 # SB_home (UDP 20521) set nat destination rule 20 description \u0026#39;SB_home\u0026#39; set nat destination rule 20 destination port \u0026#39;20521\u0026#39; set nat destination rule 20 protocol \u0026#39;udp\u0026#39; set nat destination rule 20 translation address \u0026#39;10.20.20.9\u0026#39; set nat destination rule 20 translation port \u0026#39;20521\u0026#39; # 同一个端口不填也可以 # L2TP VPN (UDP 1701) set nat destination rule 30 description \u0026#39;L2TP\u0026#39; set nat destination rule 30 destination port \u0026#39;1701\u0026#39; set nat destination rule 30 protocol \u0026#39;udp\u0026#39; set nat destination rule 30 translation address \u0026#39;10.20.20.4\u0026#39; set nat destination rule 30 translation port \u0026#39;1701\u0026#39; # 同一个端口不填也可以 # ISAKMP (UDP 500) - 用于 IKE（IPSec 密钥交换） set nat destination rule 40 description \u0026#39;ISAKMP\u0026#39; set nat destination rule 40 destination port \u0026#39;500\u0026#39; set nat destination rule 40 protocol \u0026#39;udp\u0026#39; set nat destination rule 40 translation address \u0026#39;10.20.20.4\u0026#39; set nat destination rule 40 translation port \u0026#39;500\u0026#39; # 同一个端口不填也可以 # IPSEC NAT-T (UDP 4500) - NAT 穿透 set nat destination rule 50 description \u0026#39;IPSEC\u0026#39; set nat destination rule 50 destination port \u0026#39;4500\u0026#39; set nat destination rule 50 protocol \u0026#39;udp\u0026#39; set nat destination rule 50 translation address \u0026#39;10.20.20.4\u0026#39; set nat destination rule 50 translation port \u0026#39;4500\u0026#39; # 同一个端口不填也可以 # OpenVPN (TCP 1194) set nat destination rule 60 description \u0026#39;OPENVPN\u0026#39; set nat destination rule 60 destination port \u0026#39;1194\u0026#39; set nat destination rule 60 protocol \u0026#39;tcp\u0026#39; set nat destination rule 60 translation address \u0026#39;10.20.20.4\u0026#39; set nat destination rule 60 translation port \u0026#39;1194\u0026#39; # 同一个端口不填也可以 # SIP (UDP 5060) set nat destination rule 70 description \u0026#39;SIP\u0026#39; set nat destination rule 70 destination port \u0026#39;5060\u0026#39; set nat destination rule 70 protocol \u0026#39;udp\u0026#39; set nat destination rule 70 translation address \u0026#39;10.20.20.17\u0026#39; set nat destination rule 70 translation port \u0026#39;5060\u0026#39; # 同一个端口不填也可以 # SIP RTP (UDP 10000-10100) set nat destination rule 80 description \u0026#39;SIP_RTP\u0026#39; set nat destination rule 80 destination port \u0026#39;10000-10100\u0026#39; set nat destination rule 80 protocol \u0026#39;udp\u0026#39; set nat destination rule 80 translation address \u0026#39;10.20.20.17\u0026#39; set nat destination rule 80 translation port \u0026#39;10000-10100\u0026#39; # 同一个端口不填也可以 commit save IPV6端口转发（样例配置）：NAT端口转发 (配置样例）（不用下接口）\nset nat66 destination rule 10 description \u0026#39;gohome\u0026#39; set nat66 destination rule 10 destination port \u0026#39;10521\u0026#39; set nat66 destination rule 10 protocol \u0026#39;udp\u0026#39; set nat66 destination rule 10 translation address \u0026#39;fd99::9999\u0026#39; 防火墙范围配置结束！\n六、WAN 口 PPPoE 拨号配置 6.1 拨号配置 前提是光猫要改桥接，并且有宽带的拨号信息，先从光猫的 LAN 口接一条网线到 vyos 的eth3接口(wan口），并启用一个pppoe1的接口， 自动配置 MTU ：\nset interfaces pppoe pppoe1 description \u0026#39;China Telecom\\China Unicom\u0026#39; #电信还是联通，二选一，不是的删除 set interfaces pppoe pppoe1 source-interface \u0026#39;eth3\u0026#39; set interfaces pppoe pppoe1 authentication username \u0026#39;帐号\u0026#39; set interfaces pppoe pppoe1 authentication password \u0026#39;密码\u0026#39; set interfaces pppoe pppoe1 mtu \u0026#39;1492\u0026#39; set interfaces pppoe pppoe1 ip adjust-mss \u0026#39;clamp-mss-to-pmtu\u0026#39; ####PPPOE测试时可以使用下面的命令 pppoe断开：\nrun disconnect interface pppoe1 再连：\nrun connect interface pppoe1 查看：\nrun show int 6.2 IPv6 PD 配置 首先设置需要设置 prefix，我的运营商是给的是/60\n#set interfaces pppoe pppoe1 dhcpv6-options pd 0 interface br0 sla-id \u0026#39;0\u0026#39; #第一条第二条二选一，都行，ipv6地址的形态不一样 set interfaces pppoe pppoe1 dhcpv6-options pd 0 interface br0 address \u0026#39;1\u0026#39; set interfaces pppoe pppoe1 dhcpv6-options pd 0 length \u0026#39;62\u0026#39; # 这是perxi set interfaces pppoe pppoe1 ipv6 adjust-mss \u0026#39;clamp-mss-to-pmtu\u0026#39; set interfaces pppoe pppoe1 ipv6 address autoconf 设置路由器公告RA：\nset service router-advert interface br0 prefix fd88::/64 valid-lifetime \u0026#39;172800\u0026#39; 6.3 多拨(可选） 多拨需要运营商支持，vyos 的多拨非常简单，新启用一个 pppoe 的接口拨号即可：\nset interfaces pppoe pppoe1 authentication password \u0026#39;宽带密码\u0026#39; set interfaces pppoe pppoe1 authentication username \u0026#39;宽带账号\u0026#39; set interfaces pppoe pppoe1 description \u0026#39;China Unicom WAN multi-pppoe-2\u0026#39; set interfaces pppoe pppoe1 source-interface \u0026#39;eth3\u0026#39; 至此 WAN-pppoe 的配置全部结束。\n如果公网口是dhcp获取：(此处是光猫pppoe拨号DHCP下发使用） set interfaces ethernet eth3 address dhcp 现在应该可以上网了！\nfakeip的支持 通过 MoS DNS 来分流 Real IP 和 Fake IP 的流量，可这样配置:\n定义 Telegram IPv4 组\nset firewall group network-group Telegram-v4 network \u0026#39;91.108.56.0/22\u0026#39; set firewall group network-group Telegram-v4 network \u0026#39;91.108.4.0/22\u0026#39; set firewall group network-group Telegram-v4 network \u0026#39;91.108.8.0/22\u0026#39; set firewall group network-group Telegram-v4 network \u0026#39;91.108.16.0/22\u0026#39; set firewall group network-group Telegram-v4 network \u0026#39;91.108.12.0/22\u0026#39; set firewall group network-group Telegram-v4 network \u0026#39;149.154.160.0/20\u0026#39; set firewall group network-group Telegram-v4 network \u0026#39;91.105.192.0/23\u0026#39; set firewall group network-group Telegram-v4 network \u0026#39;91.108.20.0/22\u0026#39; set firewall group network-group Telegram-v4 network \u0026#39;185.76.151.0/24\u0026#39; 定义 Telegram IPv6 组\nset firewall group ipv6-network-group Telegram-v6 network \u0026#39;2001:b28:f23d::/48\u0026#39; set firewall group ipv6-network-group Telegram-v6 network \u0026#39;2001:b28:f23f::/48\u0026#39; set firewall group ipv6-network-group Telegram-v6 network \u0026#39;2001:67c:4e8::/48\u0026#39; set firewall group ipv6-network-group Telegram-v6 network \u0026#39;2001:b28:f23c::/48\u0026#39; set firewall group ipv6-network-group Telegram-v6 network \u0026#39;2a0a:f280::/32\u0026#39; 定义 Fake IP 组\nset firewall group network-group FAKEIP-v4 network \u0026#39;198.18.0.0/15\u0026#39; # Fake IPv4 set firewall group ipv6-network-group FAKEIP-v6 network \u0026#39;f2b0::/18\u0026#39; # Fake IPv6 配置策略路由 (类似 RouterOS 中的 Mangle 规则)\nset policy route Route-to-SB interface br0 # br0 是 LAN set policy route Route-to-SB rule 10 set table \u0026#39;100\u0026#39; # Table 100 是 to-sb 的表 set policy route Route-to-SB rule 10 destination group network-group \u0026#39;Telegram-v4\u0026#39; set policy route Route-to-SB rule 20 set table \u0026#39;100\u0026#39; set policy route Route-to-SB rule 20 destination group network-group \u0026#39;FAKEIP-v4\u0026#39; set policy route6 FAKE6-to-SB interface br0 set policy route6 FAKE6-to-SB rule 10 set table \u0026#39;106\u0026#39; # Table 106 是 to-sb 的表 (IPv6) set policy route6 FAKE6-to-SB rule 10 destination group network-group \u0026#39;FAKEIP-v6\u0026#39; set policy route6 FAKE6-to-SB rule 20 set table \u0026#39;106\u0026#39; set policy route6 FAKE6-to-SB rule 20 destination group network-group \u0026#39;Telegram-v6\u0026#39; 配置路由表\nset protocols static table 100 route 0.0.0.0/0 next-hop 10.20.20.9 # sb 的内网 IP set protocols static table 106 route6 ::/0 next-hop fd88::9999 # sb 的 ULA IPV6 Nat （导完支持ipv6优先）(注意修改自己的fakeip)\nset nat66 source rule 10 description \u0026#39;MASQ-FAKE6\u0026#39; set nat66 source rule 10 destination prefix \u0026#39;f2b0::/18\u0026#39; set nat66 source rule 10 translation address \u0026#39;masquerade\u0026#39; # set interfaces bridge br0 address \u0026#39;fd88::1111/64\u0026#39; #开始设置过就不要再设置了 完了！ok了！\n对了，别忘了，把dns的设置改为，你懂的～，上面DNS设置那块有命令～准备好了～\n附！\nVyOS 自己要科学上网 一般在 pull 容器镜像、下载更新时可以这样配置:\nset system name-server \u0026#39;172.23.0.99\u0026#39; # 172.23.0.99 是 sb 的 IP 或 MoS DNS 的 IP or\nset system name-server \u0026#39;10.20.20.9\u0026#39; # 10.20.20.9 是 sb 的 IP 或 MoS DNS 的 IP 注意: name-server 只需要一个，确保能区分 Fake IP。\nset policy local-route rule 10 destination address \u0026#39;198.18.0.0/15\u0026#39; set policy local-route rule 10 set table \u0026#39;100\u0026#39; #只想让 TCP 流量 使用 table 100，而 其他协议（如 UDP、ICMP）仍走默认路由表(可选） #set policy local-route rule 10 protocol \u0026#39;tcp\u0026#39; 这三条配置作用如下：\nset policy local-route rule 10 destination address \u0026lsquo;198.18.0.0/15\u0026rsquo; • 该规则匹配 目的地址 在 198.18.0.0/15 网段内的流量。\nset policy local-route rule 10 set table \u0026lsquo;100\u0026rsquo; • 让匹配该规则的流量使用 路由表 100 进行路由查找，而不是默认的 main（254）路由表。\nset policy local-route rule 10 protocol \u0026rsquo;tcp' • 限制该规则仅适用于 TCP 流量，即 只有 TCP 协议的数据包会匹配此规则。\n第三条（protocol \u0026rsquo;tcp\u0026rsquo;）是否必要？\n• 如果你的目标是 让所有去往 198.18.0.0/15 的流量 都使用 table 100，那么 第三条是不必要的。 • 但如果你 只想让 TCP 流量 使用 table 100，而 其他协议（如 UDP、ICMP）仍走默认路由表，那么 第三条是有用的。\n因此： 完整本地科学的命令:\nset system name-server \u0026#39;172.23.0.99\u0026#39; delete system name-server \u0026#39;223.5.5.5\u0026#39; delete system name-server \u0026#39;119.29.29.29\u0026#39; set policy local-route rule 10 destination address \u0026#39;198.18.0.0/15\u0026#39; set policy local-route rule 10 set table \u0026#39;100\u0026#39; or(或者）（只是ip的区别，方便复制的，你换成你自己的ip)\nset system name-server \u0026#39;10.20.20.6\u0026#39; delete system name-server \u0026#39;223.5.5.5\u0026#39; delete system name-server \u0026#39;119.29.29.29\u0026#39; set policy local-route rule 10 destination address \u0026#39;198.18.0.0/15\u0026#39; set policy local-route rule 10 set table \u0026#39;100\u0026#39; 配置wireguard: set interfaces wireguard wg0 address \u0026#39;10.20.20.1/24\u0026#39; set interfaces wireguard wg0 peer iphone allowed-ips \u0026#39;10.20.20.2/32\u0026#39; set interfaces wireguard wg0 peer iphone preshared-key \u0026#39;preshared-key\u0026#39; set interfaces wireguard wg0 peer iphone public-key \u0026#39;public-key\u0026#39; set interfaces wireguard wg0 port \u0026#39;11133\u0026#39; set interfaces wireguard wg0 private-key \u0026#39;private-key\u0026#39; 如果让wg科学，下面接着操作：\n添加组：（输入内网IP段，上面如果设置过了就不需要重复设置，这里只是注明这块需要）\nset firewall group network-group LAN-v4 network \u0026#39;10.20.20.0/24\u0026#39; 设置策略路由: 举例: 让wg0的流量走100号路由表, 100号路由表是sb的路由表\nset policy route WG0-to-SB interface \u0026#39;wg0\u0026#39; set policy route WG0-to-SB rule 10 destination group network-group \u0026#39;!LAN-v4\u0026#39; set policy route WG0-to-SB rule 10 set table \u0026#39;100\u0026#39; #路由表（之前添加过就不要重复添加）(10.20.20.9是我sing-box的ip)\nset protocols static table 100 route 0.0.0.0/0 next-hop 10.20.20.9 ##配置ddns: cloudflare ddns:\nset service dns dynamic name DDNS-CF-v4 address interface \u0026#39;pppoe1\u0026#39; set service dns dynamic name DDNS-CF-v4 host-name \u0026#39;ddns.example.com\u0026#39; set service dns dynamic name DDNS-CF-v4 ip-version \u0026#39;ipv4\u0026#39; set service dns dynamic name DDNS-CF-v4 password \u0026#39;token\u0026#39; set service dns dynamic name DDNS-CF-v4 protocol \u0026#39;cloudflare\u0026#39; set service dns dynamic name DDNS-CF-v4 zone \u0026#39;example.com\u0026#39; set service dns dynamic name DDNS-CF-v6 address interface \u0026#39;eth0\u0026#39; set service dns dynamic name DDNS-CF-v6 host-name \u0026#39;ddns6.example.com\u0026#39; set service dns dynamic name DDNS-CF-v6 ip-version \u0026#39;ipv6\u0026#39; set service dns dynamic name DDNS-CF-v6 password \u0026#39;token\u0026#39; set service dns dynamic name DDNS-CF-v6 protocol \u0026#39;cloudflare\u0026#39; set service dns dynamic name DDNS-CF-v6 zone \u0026#39;example.com\u0026#39; dnspod ddns:\nset service dns dynamic name DNSPOD-v4 address interface \u0026#39;pppoe1\u0026#39; set service dns dynamic name DNSPOD-v4 host-name \u0026#39;ddns.example.com\u0026#39; set service dns dynamic name DNSPOD-v4 password \u0026#39;token\u0026#39; set service dns dynamic name DNSPOD-v4 protocol \u0026#39;dyndns2\u0026#39; set service dns dynamic name DNSPOD-v4 server \u0026#39;dnsapi.cn\u0026#39; set service dns dynamic name DNSPOD-v4 username \u0026#39;id\u0026#39; 个人使用下来, 上述配置并不需要设置interval, ip变化也会自动更新.\n最后给个小命令知识点： 确保 NAT 规则完整,查看命令，如: 检查规则\nshow configuration commands | match \u0026#39;nat destination\u0026#39; 用show命令的时候要注意，在配置模式#下，如看查看模式$下的show,需要在show前面加个run命令。 祝君使用愉快～\n","permalink":"https://hanigege.github.io/posts/routers/vyos-qiaojie-4kou/","tags":null,"title":"vyos多网口小主机桥接配置(完整)"},{"categories":null,"contents":"","permalink":"https://hanigege.github.io/search/","tags":null,"title":"搜索"}]