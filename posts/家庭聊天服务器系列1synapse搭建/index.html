<!doctype html><html lang=zh><head><title>å®¶åº­èŠå¤©æœåŠ¡å™¨ç³»åˆ—ï¼ˆ1ï¼‰synapseæ­å»º &ndash; ä»£ç¢¼å€‰åº«</title><meta name=description content="å€‹äººè‡ªç•™åœ°ï¼Œå¦‚æœèƒ½å¹«åˆ°ä½ ï¼Œæˆ‘ä¹Ÿæœƒå¾ˆé«˜èˆˆï¼Œå·¥ä½œç¹å¿™ï¼Œä¸æ¥å—è«®è©¢,æ•¬è«‹è«’è§£ã€‚"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=UTF-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.4/css/academicons.min.css integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://hanigege.github.io/css/palettes/base16-dark.css><link rel=stylesheet href=https://hanigege.github.io/css/risotto.css><link rel=stylesheet href=https://hanigege.github.io/css/custom.css></head><body><div class=page><header class=page__header><nav class="page__nav main-nav"><link rel=stylesheet href=/css/custom.css><ul><li class=nomarker><h1 class=page__logo><a href=https://hanigege.github.io/ class=page__logo-inner>ä»£ç¢¼å€‰åº«</a></h1></li><li class=main-nav__item><a class=nav-main-item href=https://hanigege.github.io/about/ title>About</a></li><li class=main-nav__item><a class=nav-main-item href=https://hanigege.github.io/posts/ title>Posts</a></li><li class=main-nav__item><a class=nav-main-item href=https://hanigege.github.io/downloads/ title>Downlaods</a></li><li class=main-nav__item><a class=nav-main-item href=https://hanigege.github.io/search/ title>Search</a></li></ul></nav></header><section class=page__body><header class=content__header><h1>å®¶åº­èŠå¤©æœåŠ¡å™¨ç³»åˆ—ï¼ˆ1ï¼‰synapseæ­å»º</h1></header><div class=content__body><br><h2 id=è®¾è®¡æ€è·¯>è®¾è®¡æ€è·¯</h2><p><img src=assets/CleanShot%202025-05-11%20at%2016.27.38@2x.png alt="CleanShot 2025-05-11 at 16.27.38@2x"></p><h3 id=æœåŠ¡å™¨éœ€è¦2å°å¤–ç½‘ä¸€å°vpså³å¯æ­å»ºcoturnæœåŠ¡æœ¬åœ°ä¸€å°æ­å»ºsynapseåŠntfyæœåŠ¡æ‰€æœ‰æœåŠ¡å‡ä»¥dockerçš„æ–¹å¼æ¥æ­å»º>æœåŠ¡å™¨éœ€è¦2å°ï¼Œå¤–ç½‘ä¸€å°vpså³å¯ï¼Œæ­å»ºcoturnæœåŠ¡ã€‚æœ¬åœ°ä¸€å°ï¼Œæ­å»ºsynapseåŠntfyæœåŠ¡ï¼Œæ‰€æœ‰æœåŠ¡å‡ä»¥dockerçš„æ–¹å¼æ¥æ­å»º</h3><h4 id=1-ntfyæœåŠ¡å› ä¸ºå¾ˆå¤šçš„é™åˆ¶å¯¼è‡´æ¶ˆæ¯æ— æ³•ä¼ è¾¾ç±»ä¼¼äºä½ æ¶ˆæ¯æ¥äº†ç¡®æ”¶ä¸åˆ°é€šçŸ¥æé†’>1. ntfyæœåŠ¡ï¼šå› ä¸ºå¾ˆå¤šçš„é™åˆ¶å¯¼è‡´æ¶ˆæ¯æ— æ³•ä¼ è¾¾ï¼Œç±»ä¼¼äºä½ æ¶ˆæ¯æ¥äº†ï¼Œç¡®æ”¶ä¸åˆ°é€šçŸ¥æé†’.</h4><h4 id=2-coturn-æ˜¯ä¸€ä¸ª-stunturn-æœåŠ¡å™¨-å®ç°ä¸»è¦ç”¨äº-webrtcvoipè§†é¢‘ä¼šè®®ç­‰å®æ—¶é€šä¿¡åº”ç”¨ä¸­è§£å†³nat-ç©¿é€é—®é¢˜coturn-åŒæ—¶å®ç°äº†-stun--turné€šå¸¸ç”¨ä½œ-webrtc-çš„ä¸­ç»§æœåŠ¡å™¨ç¡®ä¿è§†é¢‘è¯­éŸ³è¿æ¥åœ¨å„ç§å¤æ‚ç½‘ç»œç¯å¢ƒä¸‹éƒ½èƒ½å»ºç«‹>2. coturn æ˜¯ä¸€ä¸ª STUN/TURN æœåŠ¡å™¨ å®ç°ï¼Œä¸»è¦ç”¨äº WebRTCã€VoIPã€è§†é¢‘ä¼šè®®ç­‰å®æ—¶é€šä¿¡åº”ç”¨ä¸­ï¼Œè§£å†³NAT ç©¿é€é—®é¢˜ã€‚coturn åŒæ—¶å®ç°äº† STUN + TURNï¼Œé€šå¸¸ç”¨ä½œ WebRTC çš„ä¸­ç»§æœåŠ¡å™¨ï¼Œç¡®ä¿è§†é¢‘/è¯­éŸ³è¿æ¥åœ¨å„ç§å¤æ‚ç½‘ç»œç¯å¢ƒä¸‹éƒ½èƒ½å»ºç«‹ã€‚</h4><h4 id=3-synapseèŠå¤©æœåŠ¡å™¨ä¸»ä½“æ”¯æŒæ–‡å­—è¯­éŸ³åœ¨çº¿è¯­éŸ³ç”µè¯åœ¨çº¿è§†é¢‘æ–‡ä»¶ä¼ é€æ˜¯ä¸€å¥—å®Œæ•´å¯æŒç»­çš„èŠå¤©æœåŠ¡>3. synapseèŠå¤©æœåŠ¡å™¨ä¸»ä½“ï¼Œæ”¯æŒæ–‡å­—ï¼Œè¯­éŸ³ï¼Œåœ¨çº¿è¯­éŸ³ç”µè¯ï¼Œåœ¨çº¿è§†é¢‘ï¼Œæ–‡ä»¶ä¼ é€ï¼Œæ˜¯ä¸€å¥—å®Œæ•´å¯æŒç»­çš„èŠå¤©æœåŠ¡ã€‚</h4><h4 id=4-å®¢æˆ·ç«¯æœ‰å¾ˆå¤šç§å®˜ç½‘ä¸Šéƒ½æœ‰ä»‹ç»è¿™é‡Œåªæ¨èä½¿ç”¨elementå®¢æˆ·ç«¯>4. å®¢æˆ·ç«¯æœ‰å¾ˆå¤šç§ï¼Œå®˜ç½‘ä¸Šéƒ½æœ‰ä»‹ç»ï¼Œè¿™é‡Œåªæ¨èä½¿ç”¨Elementå®¢æˆ·ç«¯ã€‚</h4><p>æœ€æœ€ä¸‹é¢æ˜¯å¤‡ä»½æ¢å¤çš„æ–¹æ³•ï¼Œå¦‚ä½•å¤‡ä»½ï¼ŒæŠŠç›¸å…³dockeræ–‡ä»¶å¤¹æ‰“åŒ…ä¸‹è½½å°±å¯ä»¥äº†ï¼Œéœ€è¦æ¢å¤çš„æ—¶å€™ï¼Œä¸Šä¼ åˆ°ç›¸å…³çš„æœåŠ¡å™¨ï¼Œæ”¾åœ¨rootæ–‡ä»¶å¤¹ä¸‹ã€‚</p><h4 id=åˆ‡è®°synapaeæœåŠ¡å™¨ä¸å¯ä»¥ä½¿ç”¨fakeipçš„dnsä»£ç†ä¸Šç½‘åªèƒ½ç”¨æœ¬åœ°çš„ç½‘ç»œä¸ç„¶ä¼šæ”¶ä¸åˆ°æ¶ˆæ¯ntfyä¼šå‡ºé—®é¢˜>åˆ‡è®°ï¼ŒSYNAPAEæœåŠ¡å™¨ä¸å¯ä»¥ä½¿ç”¨fakeipçš„DNSä»£ç†ä¸Šç½‘ï¼Œåªèƒ½ç”¨æœ¬åœ°çš„ç½‘ç»œï¼Œä¸ç„¶ï¼Œä¼šæ”¶ä¸åˆ°æ¶ˆæ¯NTFYä¼šå‡ºé—®é¢˜ï¼</h4><p>å‰è¨€
é¦–å…ˆå¿…é¡»ä»‹ç»ä¸‹Matrixã€‚Matrixæ˜¯ä¸€ä¸ªå¼€æºã€å¯äº¤äº’ã€å»ä¸­å¿ƒåŒ–çš„å®æ—¶é€šä¿¡æœåŠ¡æ¡†æ¶ã€‚ä½¿ç”¨Matrixå¯ä»¥æ­å»ºå®‰å…¨çš„é€šä¿¡æœåŠ¡å™¨ï¼Œé…åˆæ”¯æŒ Matrix çš„å®¢æˆ·ç«¯å¯ä»¥å®ç°ä¸ªäººã€å›¢é˜Ÿé—´çš„å®æ—¶èŠå¤©äº¤äº’ã€‚</p><p>ä¸å¸¸è§çš„QQã€å¾®ä¿¡ã€é’‰é’‰ç›¸æ¯”ï¼ŒMatrixçš„ç‰¹ç‚¹å°±æ˜¯å¼€æºï¼Œå¯ç§æœ‰åŒ–éƒ¨ç½²ï¼Œä¿è¯é€šä¿¡çš„å®‰å…¨å’Œéšç§ã€‚ä¸Rocket.chatã€MatterMostç›¸æ¯”ï¼Œmatrixçš„ç‰¹ç‚¹è¿˜è¦å†åŠ ä¸Šå»ä¸­å¿ƒåŒ–ã€‚æ¯ä¸ªè¿è¡ŒMatrixçš„æœåŠ¡å™¨éƒ½æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©åœ¨ä»»æ„èŠ‚ç‚¹æ³¨å†Œã€è¿æ¥ï¼ŒåŒä¸€ä¸ªèŠ‚ç‚¹å†…çš„ç”¨æˆ·å¯ä»¥ä»»æ„é€šä¿¡ã€‚åŒæ—¶ï¼ŒèŠ‚ç‚¹ä¸èŠ‚ç‚¹ä¹‹é—´ä¹Ÿå¯ä»¥é€šè¿‡è”é”ï¼ˆFederationï¼‰æœºåˆ¶è¿›è¡Œé€šä¿¡ï¼Œå®ç°ä¸åŒèŠ‚ç‚¹çš„ç”¨æˆ·ä¹‹é—´è¿›è¡Œé€šä¿¡ã€‚</p><p>å› ä¸ºMatrixåªæ˜¯ä¸ªæ¡†æ¶ï¼Œå¯ä»¥æœ‰å¾ˆå¤šå®ç°ï¼Œæœ¬æ–‡ä½¿ç”¨çš„synapseå°±æ˜¯å…¶ä¸­ä¸€ä¸ªæœåŠ¡ç«¯å®ç°ã€‚</p><p>é™¤äº†å®‰è£…æœåŠ¡ç«¯ï¼Œæœ¬æ–‡è¿˜æœ‰å®‰è£…element webç«¯çš„æ­¥éª¤ã€‚</p><p>æ­ä¸€ä¸ªdemoå¹¶ä¸è€—èµ„æºï¼ŒåŠ ä¸Špostgresqlæ•°æ®åº“æ‰ç”¨äº†200MBå†…å­˜ä¸åˆ°ï¼Œå¦‚æœç”¨é»˜è®¤çš„sqliteæ•°æ®åº“ä¼šæ›´çœå†…å­˜ã€‚</p><h1 id=å®‰è£…æœåŠ¡ç«¯>å®‰è£…æœåŠ¡ç«¯</h1><h2 id=æ›´æ–°ç¯å¢ƒ>æ›´æ–°ç¯å¢ƒ</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>apt update -y  <span style=color:#f92672>&amp;&amp;</span> apt upgrade -y <span style=color:#f92672>&amp;&amp;</span> apt install -y curl wget sudo socat
</span></span></code></pre></div><h2 id=å®‰è£…-docker>å®‰è£… Docker</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -fsSL https://get.docker.com -o get-docker.sh <span style=color:#f92672>&amp;&amp;</span> sh get-docker.sh
</span></span><span style=display:flex><span>curl -L <span style=color:#e6db74>&#34;https://github.com/docker/compose/releases/download/v2.16.0/docker-compose-</span><span style=color:#66d9ef>$(</span>uname -s<span style=color:#66d9ef>)</span><span style=color:#e6db74>-</span><span style=color:#66d9ef>$(</span>uname -m<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> -o /usr/local/bin/docker-compose 
</span></span><span style=display:flex><span>chmod +x /usr/local/bin/docker-compose
</span></span></code></pre></div><h2 id=æ­å»ºsynapse>æ­å»ºSynapse</h2><p>æŒ‰ç…§æ•™ç¨‹å»ºç«‹/data/synapse/ä¸‹çš„ä¸‰ä¸ªæ–‡ä»¶å¤¹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir ~/data/docker_data/synapse -p
</span></span><span style=display:flex><span>mkdir ~/data/docker_data/synapse/data -p
</span></span><span style=display:flex><span>mkdir ~/data/docker_data/synapse/postgres -p
</span></span><span style=display:flex><span>mkdir ~/data/docker_data/synapse/html -p
</span></span></code></pre></div><p>å…·ä½“å¦‚ä¸‹ï¼š</p><p>é¦–å…ˆï¼Œé€‰æ‹©ä¸€ä¸ªå®¿ä¸»æœºæ–‡ä»¶å¤¹ï¼Œç”¨äºå­˜æ”¾synapseæ‰€æœ‰çš„æ•°æ®ï¼Œæˆ‘çš„è§„åˆ’å¦‚ä¸‹ï¼š</p><p><code>Synapseæ•°æ®ï¼š/root/data/docker_data/synapse/data</code></p><p><code>PostgreSQLæ•°æ®ï¼š /root/data/docker_data/synapse/postgres</code></p><p>ä¸ºäº†è®©æ¡¥æ¥ç”¨çš„å®¹å™¨å’Œ synapse å®¹å™¨èƒ½å¤Ÿäº’ç›¸é€šè®¯ï¼Œå»ºç«‹ä¸€ä¸ª docker networkï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker network create matrix
</span></span></code></pre></div><h2 id=postgresql>PostgreSQL</h2><p>pgåº“æˆ‘é€‰æ‹©äº†16ç‰ˆæœ¬ï¼Œé€‰æ‹©çš„é•œåƒæ˜¯postgres:16-alpineã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run --name postgres16 --network matrix --restart<span style=color:#f92672>=</span>always -v /root/data/docker_data/synapse/postgres:/var/lib/postgresql/data -e   POSTGRES_PASSWORD<span style=color:#f92672>=</span>è‡ªå®šä¹‰PostgreSQLå¯†ç  -p 5432:5432 -d postgres:16-alpine
</span></span></code></pre></div><p>ç•Œé¢ä¼šæ˜¾ç¤ºå®¹å™¨çš„hashå€¼ï¼Œæ¥ç€æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤åˆ›å»ºä¸€ä¸ªç”¨äºè¿æ¥æ•°æ®åº“çš„synapseç”¨æˆ·å¹¶è¾“å…¥ä½ çš„å¯†ç </p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker exec -it postgres16 createuser -U postgres --pwprompt synapse_user
</span></span></code></pre></div><p>æ‰§è¡Œä¸‹é¢çš„è¯­å¥è¿›å…¥psql</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker exec -it postgres16 psql -U postgres
</span></span></code></pre></div><p>æ‰§è¡Œä¸‹é¢çš„å»ºåº“è¯­å¥ç”¨äºå»ºç«‹ä¸€ä¸ªsynapseåº“</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>CREATE DATABASE synapse
</span></span><span style=display:flex><span> ENCODING <span style=color:#e6db74>&#39;UTF8&#39;</span>
</span></span><span style=display:flex><span> LC_COLLATE<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;C&#39;</span>
</span></span><span style=display:flex><span> LC_CTYPE<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;C&#39;</span>
</span></span><span style=display:flex><span> template<span style=color:#f92672>=</span>template0
</span></span><span style=display:flex><span> OWNER synapse_user;
</span></span></code></pre></div><p><code>æ‰§è¡Œå®Œæ¯•åè¾“å…¥\qé€€å‡º</code>
*åç»­è¿æ¥å¦‚æœæœ‰é—®é¢˜ï¼Œå¯ä»¥åœ¨postgres/pg_hba.confä¸­
æ·»åŠ 
host synapse synapse_user all trust</p><h2 id=å®‰è£…synapse>å®‰è£…synapse</h2><p>å…ˆæ‹‰å–dockeré•œåƒ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker pull matrixdotorg/synapse:latest
</span></span></code></pre></div><p>ç”Ÿæˆé…ç½®æ–‡ä»¶ã€‚æ³¨æ„æ ¹æ®å®é™…ä¿®æ”¹å®¿ä¸»æœºæŒ‚è½½ç›®å½•è·¯å¾„å’Œmatrixçš„host</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -it --rm -v /root/data/docker_data/synapse/data:/data -e SYNAPSE_SERVER_NAME<span style=color:#f92672>=</span>matrix.demo.com -e SYNAPSE_REPORT_STATS<span style=color:#f92672>=</span>yes matrixdotorg/synapse:latest generate
</span></span></code></pre></div><p><code>ä¸Šé¢çš„åŸŸåï¼ˆä¾‹ï¼‰ï¼Œæ”¹ä¸ºä½ è‡ªå·±çš„åŸŸå</code></p><p>åœ¨postgresqlä¸­åˆ›å»ºç”¨æˆ·å’Œæ•°æ®åº“ï¼ˆé»˜è®¤ä½¿ç”¨sqliteï¼Œåªæ˜¯ä½“éªŒçš„è¯å¯ä»¥è·³è¿‡ï¼‰</p><p>ä¿®æ”¹é…ç½®æ–‡ä»¶/root/data/docker_data/synapse/data/homeserver.yaml</p><p>ï¼Œæ³¨é‡Šæ‰åŸå…ˆçš„sqlite3é…ç½®ï¼Œä¿®æ”¹ä¸ºpostgresé…ç½®</p><p>å…ˆæ³¨é‡Šæ–‡ä»¶ä¸­ä¸‹é¢çš„ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> <span style=color:#75715e>#database:</span>
</span></span><span style=display:flex><span> <span style=color:#75715e>#name: sqlite3</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#args:</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#  database: /data/homeserver.db</span>
</span></span></code></pre></div><p>æ¢æˆï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>database:
</span></span><span style=display:flex><span>  name: psycopg2
</span></span><span style=display:flex><span>  args:
</span></span><span style=display:flex><span>    user: synapse_user
</span></span><span style=display:flex><span>    password: &lt;pass&gt;
</span></span><span style=display:flex><span>    database: synapse
</span></span><span style=display:flex><span>    host: &lt;host&gt;  <span style=color:#75715e>#ç›´æ¥å¡«å…¥å†…ç½‘ipå³å¯</span>
</span></span><span style=display:flex><span>    cp_min: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>    cp_max: <span style=color:#ae81ff>10</span>
</span></span></code></pre></div><p>åœ¨/root/data/docker_data/synapseæ–‡ä»¶å¤¹ä¸‹æ–°å»ºdocker-compose.yamlæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>services:
</span></span><span style=display:flex><span>  synapse:
</span></span><span style=display:flex><span>    image: matrixdotorg/synapse:latest
</span></span><span style=display:flex><span>    container_name: matrix-synapse
</span></span><span style=display:flex><span>    ports:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;8008:8008&#34;</span>
</span></span><span style=display:flex><span>    volumes:
</span></span><span style=display:flex><span>      - ./data:/data
</span></span><span style=display:flex><span>      - ./html:/usr/local/lib/python3.11/site-packages/synapse/static
</span></span><span style=display:flex><span>    networks:
</span></span><span style=display:flex><span>      - matrix
</span></span><span style=display:flex><span>    restart: always
</span></span><span style=display:flex><span>    environment:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;TZ=Asia/Shanghai&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>networks:
</span></span><span style=display:flex><span>    matrix:
</span></span><span style=display:flex><span>      name: matrix
</span></span></code></pre></div><p>ä¸Šé¢çš„ä»£ç æœ‰å…³docker ç½‘ç»œçš„çŸ¥é“ï¼Œæ ¹æ®ä¸Šé¢çš„ä»£ç ä¸‹é¢è¯´æ˜ä¸€ä¸‹ï¼š</p><p>åœ¨ä½ çš„Docker Composeæ–‡ä»¶ä¸­ï¼Œä½ å®šä¹‰äº†ä¸€ä¸ªåä¸º"matrix"çš„ç½‘ç»œã€‚å½“ä½ è¿è¡Œdocker-compose up -dæ—¶ï¼ŒDocker Composeä¼šä¸ºæ¯ä¸ªæœåŠ¡è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ¡¥æ¥ç½‘ç»œï¼Œå¹¶åœ¨ç½‘ç»œåç§°å‰åŠ ä¸ŠæœåŠ¡åç§°çš„å‰ç¼€ã€‚</p><p>å› æ­¤ï¼Œç”±äºä½ çš„æœåŠ¡åæ˜¯"synapse"ï¼Œå®é™…åˆ›å»ºçš„æ¡¥æ¥ç½‘ç»œåç§°ä¼šæ˜¯<code>"synapse_matrix"</code>ï¼Œï¼ˆå¦‚æœä¸åŠ name: matrixå°±æ˜¯è¿™æ ·ï¼‰è€Œä¸æ˜¯ä»…ä»…æ˜¯"matrix"ã€‚è¿™æ˜¯Docker Composeçš„é»˜è®¤è¡Œä¸ºã€‚</p><p>ä»£ç ä¸­ï¼š
<code>- ./html:/usr/local/lib/python3.11/site-packages/synapse/static </code>è¿™æ˜¯æŒ‡å‘synapseçš„ä¸»é¡µç½‘é¡µ</p><p>å¦‚æœä½ æƒ³æ˜¾å¼åœ°æŒ‡å®šç½‘ç»œåç§°ï¼Œå¯ä»¥åœ¨networkséƒ¨åˆ†çš„å®šä¹‰ä¸­ä½¿ç”¨nameå±æ€§ï¼Œä¾‹å¦‚ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>services:
</span></span><span style=display:flex><span>  synapse:
</span></span><span style=display:flex><span>    image: matrixdotorg/synapse:latest
</span></span><span style=display:flex><span>    container_name: matrix-synapse
</span></span><span style=display:flex><span>    ports:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;8008:8008&#34;</span>
</span></span><span style=display:flex><span>    volumes:
</span></span><span style=display:flex><span>      - ./data:/data
</span></span><span style=display:flex><span>      - ./html:/usr/local/lib/python3.11/site-packages/synapse/static
</span></span><span style=display:flex><span>    networks:
</span></span><span style=display:flex><span>      - matrix
</span></span><span style=display:flex><span>    restart: always
</span></span><span style=display:flex><span>    environment:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;TZ=Asia/Shanghai&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>networks:
</span></span><span style=display:flex><span>  matrix:
</span></span><span style=display:flex><span>    name: my_custom_matrix_network
</span></span></code></pre></div><p>#å› æ­¤è¿™ä¸ªname,æˆ‘å°±å†™ä¸ºä¸Šé¢çš„ï¼šmatrix</p><h2 id=å¯åŠ¨å®¹å™¨>å¯åŠ¨å®¹å™¨</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker-compose up -d
</span></span></code></pre></div><p>é…ç½®nginxåå‘ä»£ç†httpæˆ–httpsï¼ˆç•¥è¿‡ï¼‰</p><p>åˆ›å»ºç”¨æˆ·ï¼ˆé»˜è®¤ç¦æ­¢å…¬å¼€æ³¨å†Œï¼‰</p><h2 id=æ ¹æ®æç¤ºè¾“å…¥ç”¨æˆ·åå¯†ç æ˜¯å¦è®¾ç½®ä¸ºç®¡ç†å‘˜>æ ¹æ®æç¤ºè¾“å…¥ç”¨æˆ·åã€å¯†ç ã€æ˜¯å¦è®¾ç½®ä¸ºç®¡ç†å‘˜</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>register_new_matrix_user -c /data/homeserver.yaml &lt;your matrix server host&gt;
</span></span><span style=display:flex><span>cd /root/data/docker_data/synapse
</span></span><span style=display:flex><span>docker-compose exec  synapse register_new_matrix_user -c /data/homeserver.yaml http://localhost:8008
</span></span></code></pre></div><h2 id=å®‰è£…element-webå®¢æˆ·ç«¯>å®‰è£…element webå®¢æˆ·ç«¯</h2><p>è®¿é—®github<a href=https://github.com/vector-im/element-web/releases>ä¸‹è½½releaseåŒ…</a></p><p>è§£å‹åï¼Œåˆ›å»ºé…ç½®æ–‡ä»¶</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cp config.sample.json config.json
</span></span></code></pre></div><p>ç¼–è¾‘config.jsonï¼Œè®¾ç½®default_server_config.m.homeserver.base_urlä¸ºè‡ªå·±çš„matrixæœåŠ¡ç«¯åœ°å€</p><p>é…ç½®nginxæŒ‡å‘è§£å‹åçš„ç›®å½•</p><p>è®¿é—®è‡ªå»ºçš„element webå®¢æˆ·ç«¯æµ‹è¯•</p><p>è¡¥å……
å…è®¸å…¬å¼€æ³¨å†Œ
ä¿®æ”¹synapseçš„homeserver.yamlæ–‡ä»¶ï¼Œè®¾ç½®ä»¥ä¸‹å‚æ•°</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>enable_registration: True
</span></span></code></pre></div><p>é‡å¯synapse</p><p>Elementçš„Windowså®¢æˆ·ç«¯æŒ‡å®šé»˜è®¤æœåŠ¡å™¨åœ°å€
<code>åœ¨èµ„æºç®¡ç†å™¨ä¸­æ‰“å¼€ç›®å½• %AppData\Roaming\Element%</code></p><p>æ–°å»ºæ–‡ä»¶ config.jsonï¼Œè¾“å…¥ä»¥ä¸‹å†…å®¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;default_server_config&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;m.homeserver&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;base_url&#34;</span>: <span style=color:#e6db74>&#34;&lt;your matrix server host&gt;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h1 id=å¤‡ä»½æ¢å¤çš„æ–¹æ³•>å¤‡ä»½æ¢å¤çš„æ–¹æ³•ï¼š</h1><p>ä¸ºäº†è®©æ¡¥æ¥ç”¨çš„å®¹å™¨å’Œ synapse å®¹å™¨èƒ½å¤Ÿäº’ç›¸é€šè®¯ï¼Œ
å»ºç«‹ä¸€ä¸ª docker networkï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker network create matrix
</span></span></code></pre></div><p>PostgreSQL
pgåº“æˆ‘é€‰æ‹©äº†16ç‰ˆæœ¬ï¼Œé€‰æ‹©çš„é•œåƒæ˜¯postgres:16-alpineã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run --name postgres16 --network matrix --restart<span style=color:#f92672>=</span>always -v /root/data/docker_data/synapse/postgres:/var/lib/postgresql/data -e   POSTGRES_PASSWORD<span style=color:#f92672>=</span>è‡ªå®šä¹‰PostgreSQLå¯†ç  -p 5432:5432 -d postgres:16-alpine
</span></span></code></pre></div><p>æ›´æ”¹synapseæ–‡ä»¶å¤¹ä¸‹é‡Œçš„docker-compose.ymlé‡Œçš„å†…å®¹å¦‚ä¸‹ï¼Œç›´æ¥å¤åˆ¶æ›¿æ¢ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>services:
</span></span><span style=display:flex><span>  synapse:
</span></span><span style=display:flex><span>    image: matrixdotorg/synapse:latest
</span></span><span style=display:flex><span>    container_name: matrix-synapse
</span></span><span style=display:flex><span>    ports:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;8008:8008&#34;</span>
</span></span><span style=display:flex><span>    volumes:
</span></span><span style=display:flex><span>      - /root/data/docker_data/synapse/data/:/data/
</span></span><span style=display:flex><span>      - /root/data/docker_data/synapse/html/:/usr/local/lib/python3.11/site-packages/synapse/static/
</span></span><span style=display:flex><span>    networks:
</span></span><span style=display:flex><span>      - matrix
</span></span><span style=display:flex><span>    restart: always
</span></span><span style=display:flex><span>    environment:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;TZ=Asia/Shanghai&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>networks:
</span></span><span style=display:flex><span>  matrix:
</span></span><span style=display:flex><span>    driver: bridge
</span></span></code></pre></div><p>è¿è¡Œï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker-compose up -d
</span></span></code></pre></div><p>æå®šï¼</p><div id=utterances-comments><script src=https://utteranc.es/client.js repo=hanigege/blog-comments issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div><footer class=content__footer></footer></section><section class=page__aside><div class=aside__about><div class=aside__about><span class=about__logo role=img>ğŸš</span>&nbsp;<h1 class=about__title>å–‚é¥­</h1><p class=about__description>å€‹äººè‡ªç•™åœ°ï¼Œå¦‚æœèƒ½å¹«åˆ°ä½ ï¼Œæˆ‘ä¹Ÿæœƒå¾ˆé«˜èˆˆï¼Œå·¥ä½œç¹å¿™ï¼Œä¸æ¥å—è«®è©¢,æ•¬è«‹è«’è§£ã€‚</p></div><ul class=aside__social-links><li><a href=mailto:purodn@gmail.com rel=me aria-label=Email title=Email><i class="fa-solid fa-envelope" aria-hidden=true></i></a>&nbsp;</li></ul></div><hr><div class=aside__content><p>2025-05-11</p><hr>On this page:<nav id=TableOfContents><ol><li><a href=#è®¾è®¡æ€è·¯>è®¾è®¡æ€è·¯</a><ol><li><a href=#æœåŠ¡å™¨éœ€è¦2å°å¤–ç½‘ä¸€å°vpså³å¯æ­å»ºcoturnæœåŠ¡æœ¬åœ°ä¸€å°æ­å»ºsynapseåŠntfyæœåŠ¡æ‰€æœ‰æœåŠ¡å‡ä»¥dockerçš„æ–¹å¼æ¥æ­å»º>æœåŠ¡å™¨éœ€è¦2å°ï¼Œå¤–ç½‘ä¸€å°vpså³å¯ï¼Œæ­å»ºcoturnæœåŠ¡ã€‚æœ¬åœ°ä¸€å°ï¼Œæ­å»ºsynapseåŠntfyæœåŠ¡ï¼Œæ‰€æœ‰æœåŠ¡å‡ä»¥dockerçš„æ–¹å¼æ¥æ­å»º</a></li></ol></li></ol><ol><li><a href=#æ›´æ–°ç¯å¢ƒ>æ›´æ–°ç¯å¢ƒ</a></li><li><a href=#å®‰è£…-docker>å®‰è£… Docker</a></li><li><a href=#æ­å»ºsynapse>æ­å»ºSynapse</a></li><li><a href=#postgresql>PostgreSQL</a></li><li><a href=#å®‰è£…synapse>å®‰è£…synapse</a></li><li><a href=#å¯åŠ¨å®¹å™¨>å¯åŠ¨å®¹å™¨</a></li><li><a href=#æ ¹æ®æç¤ºè¾“å…¥ç”¨æˆ·åå¯†ç æ˜¯å¦è®¾ç½®ä¸ºç®¡ç†å‘˜>æ ¹æ®æç¤ºè¾“å…¥ç”¨æˆ·åã€å¯†ç ã€æ˜¯å¦è®¾ç½®ä¸ºç®¡ç†å‘˜</a></li><li><a href=#å®‰è£…element-webå®¢æˆ·ç«¯>å®‰è£…element webå®¢æˆ·ç«¯</a></li></ol></nav></div></section><footer class=page__footer><p class=copyright>Â© <strong>felix</strong>.</p><p class=advertisement>Powered by <a>å¤§ä½¬å€‘</a>.</p></footer></div></body></html>