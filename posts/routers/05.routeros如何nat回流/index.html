<!doctype html><html lang=zh><head><title>05.RouterOS如何nat回流及包含配套防火墙规则 &ndash; bash</title><meta name=description content="個人自留地，如果能幫到你，我也會很高興。"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=UTF-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.4/css/academicons.min.css integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://hanigege.github.io/css/palettes/base16-dark.css><link rel=stylesheet href=https://hanigege.github.io/css/risotto.css><link rel=stylesheet href=https://hanigege.github.io/css/custom.css><script src=https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js></script><style>pre{position:relative;padding-top:40px!important;background-color:#1e1e1e!important;border:1px solid #333!important;border-radius:10px!important;box-shadow:0 4px 15px rgba(0,0,0,.4);overflow-x:auto!important;overflow-y:hidden!important;margin:1.5em 0}pre::-webkit-scrollbar{height:8px}pre::-webkit-scrollbar-thumb{background:#4a4a4a;border-radius:4px}pre::-webkit-scrollbar-track{background:0 0}code{font-family:jetbrains mono,fira code,Menlo,monospace!important;font-size:.92em!important;line-height:1.6!important;color:#d4d4d4!important;background:0 0!important;white-space:pre!important}.copy-code-button{position:absolute;top:10px;right:12px;padding:5px 12px;background:rgba(255,255,255,8%);color:#aaa;border:1px solid rgba(255,255,255,.15);border-radius:6px;backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);cursor:pointer;font-size:11px;font-weight:500;z-index:100;transition:all .25s ease}.copy-code-button:hover{background:rgba(102,217,239,.2);color:#66d9ef;border-color:#66d9ef;transform:translateY(-1px)}.copy-code-button:active{transform:translateY(0)}p img{cursor:zoom-in;transition:opacity .3s;border-radius:4px;max-width:100%}p img:hover{opacity:.9}.medium-zoom-overlay{z-index:999998!important}.medium-zoom-image--opened{z-index:999999!important}</style><script>document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll("pre").forEach(e=>{if(e.querySelector(".copy-code-button"))return;const t=document.createElement("button");t.className="copy-code-button",t.type="button",t.innerText="Copy",t.addEventListener("click",()=>{const n=e.querySelector("code"),s=n?n.innerText:e.innerText;navigator.clipboard.writeText(s).then(()=>{t.innerText="Copied!",t.style.background="rgba(166, 226, 46, 0.2)",t.style.color="#a6e22e",setTimeout(()=>{t.innerText="Copy",t.style.background="",t.style.color=""},2e3)})}),e.appendChild(t)});const e=document.querySelectorAll("p img");e.length>0&&mediumZoom(e,{margin:24,background:"#1e1e1ecf",scrollOffset:40})})</script></head><body><div class=page><header class=page__header><nav class="page__nav main-nav"><link rel=stylesheet href=/css/custom.css><ul><li class=nomarker><h1 class=page__logo><a href=https://hanigege.github.io/ class=page__logo-inner>bash</a></h1></li><li class=main-nav__item><a class=nav-main-item href=https://hanigege.github.io/categories/freebsd/ title>FreeBSD</a></li><li class=main-nav__item><a class=nav-main-item href=https://hanigege.github.io/categories/linux/ title>Linux</a></li><li class=main-nav__item><a class=nav-main-item href=https://hanigege.github.io/categories/routers/ title>Routers</a></li><li class=main-nav__item><a class=nav-main-item href=https://hanigege.github.io/categories/other/ title>Other</a></li><li class=main-nav__item><a class=nav-main-item href=https://hanigege.github.io/about/ title>About</a></li></ul></nav></header><section class=page__body><header class=content__header><h1>05.RouterOS如何nat回流及包含配套防火墙规则</h1></header><div class=content__body><h2 id=内网的dst-nat要加外网接口如pppoe-out1>内网的dst-nat要加外网接口如pppoe-out1</h2><h2 id=1-为什么需要回流>1. 为什么需要回流？</h2><p>当你从内网请求公网 IP 时，ROS 收到包后转发给内网服务器，但服务器发现请求方和自己在同一个网段，会直接把回包传给手机。手机发现自己发给公网 IP 的请求却收到了来自内网私有 IP 的响应，会因为安全机制直接丢弃该包。回流规则通过让 ROS 中转这个“回头包”来解决这个问题。</p><h2 id=2-完整的-ros-nat-脚本包含-web-回流>2. 完整的 ROS NAT 脚本（包含 Web 回流）</h2><h4 id=请根据你的实际端口修改-12335-web-和-21-ftp-等>请根据你的实际端口修改 12335 (Web) 和 21 (FTP) 等。</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>/ip firewall nat
</span></span><span style=display:flex><span># --- 基础规则 ---
</span></span><span style=display:flex><span># 1. 核心上网伪装（必须限制在 WAN 口，防止干扰其他转发）
</span></span><span style=display:flex><span>add chain=srcnat action=masquerade out-interface=pppoe-out1 comment=&#34;Standard Internet Access&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># --- 端口转发 (DST-NAT) ---
</span></span><span style=display:flex><span># 2. DERP 转发
</span></span><span style=display:flex><span>add chain=dstnat protocol=tcp dst-port=12340 action=dst-nat to-addresses=10.20.20.4 to-ports=12340 comment=&#34;DERP TCP&#34;
</span></span><span style=display:flex><span>add chain=dstnat protocol=udp dst-port=3478 action=dst-nat to-addresses=10.20.20.4 to-ports=3478 comment=&#34;DERP STUN&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 3. Web 服务转发 (示例)
</span></span><span style=display:flex><span>add chain=dstnat protocol=tcp dst-port=12335 action=dst-nat to-addresses=10.20.20.x to-ports=12335 comment=&#34;web&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 4. FTP 服务转发 (示例)
</span></span><span style=display:flex><span>add chain=dstnat protocol=tcp dst-port=21 action=dst-nat to-addresses=10.20.20.x to-ports=21 comment=&#34;vsftpd&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># --- 回流规则 (Hairpin NAT) ---
</span></span><span style=display:flex><span># 只有当内网访问内网服务器时才触发。建议将所有内网服务器放在一个规则里，或者逐个添加。
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 给 DERP 添加回流
</span></span><span style=display:flex><span>add chain=srcnat src-address=10.20.20.0/24 dst-address=10.20.20.4 protocol=tcp dst-port=12340 action=masquerade comment=&#34;Hairpin DERP TCP&#34;
</span></span><span style=display:flex><span>add chain=srcnat src-address=10.20.20.0/24 dst-address=10.20.20.4 protocol=udp dst-port=3478 action=masquerade comment=&#34;Hairpin DERP STUN&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 给 Web 服务添加回流 (假设内网 IP 为 10.20.20.5)
</span></span><span style=display:flex><span>add chain=srcnat src-address=10.20.20.0/24 dst-address=10.20.20.5 protocol=tcp dst-port=12335 action=masquerade comment=&#34;Hairpin Web&#34;
</span></span></code></pre></div><h2 id=3-操作建议使用地址列表简化回流>3. 操作建议：使用“地址列表”简化回流</h2><p>如果你有很多内网服务器需要回流，一条条加 srcnat 很麻烦。你可以这样做：</p><p>在 IP -> Firewall -> Address Lists 里，把所有内网服务器 IP 加到一个叫 Internal_Servers 的列表。</p><ol><li>操作步骤</li></ol><p>请在 WinBox 中按照以下两步配置：</p><p>第一步：建立服务器地址列表</p><p>在 IP -> Firewall -> Address Lists 中，将你所有需要从内网访问的服务器 IP 加入列表：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Name: Internal_Servers | Address: 10.20.20.4 (DERP 服务器)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Name: Internal_Servers | Address: 10.20.20.5 (Web 服务器)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(依此类推，将所有有端口转发需求的内网 IP 都加进去)
</span></span></code></pre></div><p>第二步：添加全局回流规则</p><h3 id=在-ip---firewall---nat-中添加这一条确保它在所有-dst-nat-规则之后但在基础-masquerade-规则之前或者紧随其后>在 IP -> Firewall -> NAT 中添加这一条（确保它在所有 dst-nat 规则之后，但在基础 masquerade 规则之前，或者紧随其后）：</h3><p>代码段</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>/ip firewall nat</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add chain=srcnat src-address=10.20.20.0/24 dst-address-list=Internal_Servers action=masquerade comment=&#34;Global Hairpin NAT&#34;</span>
</span></span></code></pre></div><p>使用 Address List（地址列表） 的方式最为高效，不需要在 NAT 规则里指定端口。</p><p>当请求的目标地址匹配列表中的 IP 时，RouterOS 会自动对所有协议（TCP/UDP/ICMP 等）和所有端口执行回流操作。</p><h4 id=这一条放在nat列表的最下面就行>这一条放在nat列表的最下面就行。</h4><h2 id=4-验证-web-服务>4. 验证 Web 服务</h2><p>外网测试：手机关 Wi-Fi，访问域名，确认 Web 正常。</p><p>内网测试：手机连 Wi-Fi，访问同一个域名。如果能打开，说明回流配置成功。</p><h2 id=5-配套的防火墙规则也是我自用的>5. 配套的防火墙规则，也是我自用的</h2><h2 id=ipv4防火墙配置>ipv4防火墙配置</h2><h2 id=带添加旁路由ip规则版-mosdnssb>带添加旁路由ip规则版 (mosdns+sb):</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>/ip firewall filter</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ====================</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 入站链 (INPUT) - 访问路由器本身</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ====================</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=input comment=&#34;1. Accept established,related,untracked&#34; connection-state=established,related,untracked</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=input comment=&#34;2. Drop invalid&#34; connection-state=invalid</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=input comment=&#34;3. Accept bridge1 (Internal Admin)&#34; in-interface=bridge1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 防爆破逻辑 (针对 3981, 2222 端口)</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=input comment=&#34;4. Drop Bruteforce IPs&#34; dst-port=3981,2222 protocol=tcp src-address-list=bruteforce_blacklist</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=input comment=&#34;5. Accept limited connections&#34; connection-limit=10,32 dst-port=3981,2222 protocol=tcp</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=add-src-to-address-list address-list=bruteforce_blacklist address-list-timeout=3d chain=input comment=&#34;6. Add to Bruteforce List&#34; dst-port=3981,2222 protocol=tcp</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=input comment=&#34;7. Drop excess packets&#34; dst-port=3981,2222 protocol=tcp</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># WAN口丢弃与兜底</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=input comment=&#34;8. Drop ICMP from WAN&#34; in-interface=pppoe-out1 protocol=icmp</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=input comment=&#34;9. Drop all other input from WAN&#34; in-interface=pppoe-out1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ====================</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 转发链 (FORWARD) - 穿过路由器 (外网&lt;-&gt;内网)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ====================</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1. 旁路由豁免 (必须放在 Fasttrack 和 Invalid 丢弃之前)</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;1. Bypass Fasttrack &amp; Tracking: sing-box out&#34; src-address=10.20.20.6</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;2. Bypass Fasttrack &amp; Tracking: sing-box in&#34; dst-address=10.20.20.6</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2. 硬件加速 (处理内网其他正常不走代理的直连流量)</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=fasttrack-connection chain=forward comment=&#34;3. Fasttrack&#34; connection-state=established,related</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 3. 基础状态放行</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;4. Accept established,related,untracked&#34; connection-state=established,related,untracked</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 4. 内网正常转发与端口映射放行</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;6. Allow bridge1 forward (Internal Outbound)&#34; in-interface=bridge1</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;7. Allow DSTNAT (Port Forwarding)&#34; connection-nat-state=dstnat in-interface=pppoe-out1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 5. 全局兜底拦截 (零信任原则)</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=forward comment=&#34;8. Drop all other forward&#34;</span>
</span></span></code></pre></div><h3 id=转发链-forward特别说明>转发链 (FORWARD)特别说明：</h3><p><strong>FORWARD链</strong>“旁路由豁免”填入你的<code>mos+sb的ip</code><br><strong>INPUT链</strong>“3981, 2222端口”填入你的<code>winbox，ssh等相关对外开放的端口</code><br></p><h2 id=不添加旁路由ip规则版>不添加旁路由ip规则版：</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>/ip firewall filter</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ====================</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 入站链 (INPUT) - 访问路由器本身</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ====================</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=input comment=&#34;1. Accept established,related,untracked&#34; connection-state=established,related,untracked</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=input comment=&#34;2. Drop invalid&#34; connection-state=invalid</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=input comment=&#34;3. Accept bridge1 (Internal Admin)&#34; in-interface=bridge1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 防爆破逻辑 (针对 3981, 2222 端口)</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=input comment=&#34;4. Drop Bruteforce IPs&#34; dst-port=3981,2222 protocol=tcp src-address-list=bruteforce_blacklist</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=input comment=&#34;5. Accept limited connections&#34; connection-limit=10,32 dst-port=3981,2222 protocol=tcp</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=add-src-to-address-list address-list=bruteforce_blacklist address-list-timeout=3d chain=input comment=&#34;6. Add to Bruteforce List&#34; dst-port=3981,2222 protocol=tcp</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=input comment=&#34;7. Drop excess packets&#34; dst-port=3981,2222 protocol=tcp</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># WAN口丢弃与兜底</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=input comment=&#34;8. Drop ICMP from WAN&#34; in-interface=pppoe-out1 protocol=icmp</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=input comment=&#34;9. Drop all other input from WAN&#34; in-interface=pppoe-out1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ====================</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 转发链 (FORWARD) - 穿过路由器 (外网&lt;-&gt;内网)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ====================</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1. 硬件加速 (处理内网其他正常不走代理的直连流量)</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=fasttrack-connection chain=forward comment=&#34;3. Fasttrack&#34; connection-state=established,related</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2. 基础状态放行</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;4. Accept established,related,untracked&#34; connection-state=established,related,untracked</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 3. 丢弃无效包 (放在旁路由之后，防止非对称路由回程包被误杀)</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=forward comment=&#34;5. Drop invalid&#34; connection-state=invalid</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 4. 内网正常转发与端口映射放行</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;6. Allow bridge1 forward (Internal Outbound)&#34; in-interface=bridge1</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;7. Allow DSTNAT (Port Forwarding)&#34; connection-nat-state=dstnat in-interface=pppoe-out1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 5. 全局兜底拦截 (零信任原则)</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=forward comment=&#34;8. Drop all other forward&#34;</span>
</span></span></code></pre></div><h3 id=转发链-forward特别说明-1>转发链 (FORWARD)特别说明：</h3><p><strong>第5条</strong>&ldquo;DST-NAT"规则：在 IPv4 的 Forward 链中，我加入了一条 connection-nat-state=dstnat。这确保了你在 IP -> Firewall -> NAT 中做的端口映射能够穿透 forward 的兜底 drop 规则。
内网互通：只要数据包进入 bridge1 接口，就会被 Allow bridge1 forward 捕获并放行，不会受到最后一条 drop 的影响。<br>这样配置后，局域网内的 PT 下载、NAS 外部大文件传输等不走 10.20.20.6 的直连流量依然可以享受硬件加速降低 CPU 负载，而 sing-box 进出的流量则由 CPU 稳妥处理，互不干扰</p><h2 id=ipv6防火墙配置>ipv6防火墙配置</h2><h2 id=添加旁路由ip规则版-mosdnssb>添加旁路由ip规则版 (mosdns+sb)</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>/ipv6 firewall filter</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ====================</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 入站链 (INPUT) - 保护路由器本体</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ====================</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=input comment=&#34;1. Accept established,related,untracked&#34; connection-state=established,related,untracked</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=input comment=&#34;2. Drop invalid&#34; connection-state=invalid</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=input comment=&#34;3. Accept ICMPv6 (Critical for IPv6)&#34; protocol=icmpv6</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=input comment=&#34;4. Allow DHCPv6 Client from WAN&#34; dst-port=546 in-interface=pppoe-out1 protocol=udp src-address=fe80::/10</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=input comment=&#34;5. Allow bridge1 (Internal Admin)&#34; in-interface=bridge1</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=input comment=&#34;6. Drop all not from bridge1&#34; in-interface=!bridge1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ====================</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 转发链 (FORWARD) - 穿过路由器 (外网&lt;-&gt;内网)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ====================</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1. 旁路由豁免 (必须放在 Fasttrack 和 Invalid 丢弃之前)</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;1. Bypass Fasttrack &amp; Tracking: sing-box out&#34; src-address=fd88::6666</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;2. Bypass Fasttrack &amp; Tracking: sing-box in&#34; dst-address=fd88::6666</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2. 硬件加速 (处理正常不走代理的 IPv6 直连流量)</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=fasttrack-connection chain=forward comment=&#34;3. Fasttrack&#34; connection-state=established,related</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 3. 基础状态放行</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;4. Accept forward established,related,untracked&#34; connection-state=established,related,untracked</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 4. 核心协议与内网放行</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;6. Accept Forward ICMPv6&#34; protocol=icmpv6</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;7. Allow bridge1 forward (Internal Outbound)&#34; in-interface=bridge1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># --- 暴露内网服务 (注意：替换为实际公网 IPv6 地址后再按需启用) ---</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;8. Allow NPM (HTTP/HTTPS)&#34; disabled=yes dst-address=240e::xxxx:xxxx dst-port=80,443 protocol=tcp</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;9. Allow Hysteria2/Proxy&#34; disabled=yes dst-address=240e::xxxx:xxxx dst-port=36789 protocol=udp</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;10. Allow Shadowsocks&#34; disabled=yes dst-address=240e::xxxx:xxxx dst-port=36789 protocol=tcp</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 5. 兜底拦截 (零信任原则)</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=forward comment=&#34;11. Drop all other forward (Protect LAN)&#34;</span>
</span></span></code></pre></div><p><strong>关键提醒：</strong>
修改旁路由的ip为你的ipv6地址<br>如果你的宽带是动态 IPv6 前缀（PD），服务器的完整 IPv6 地址会变化。这种情况下，不应直接写死 dst-address，而是需要结合 MikroTik 的 IPv6 Firewall Address Lists 功能，或者使用 in-interface=pppoe-out1 配合 out-interface=bridge1 加上特定设备的特定匹配规则（比如通过防火墙脚本动态更新）。</p><p>IPv4 依靠 NAT，不主动映射外部进不来；但 IPv6 是端到端直通（没有 NAT）。
你在 forward 链中放行 dst-port=80,443，却没有指定目标地址 (dst-address)。一旦启用，这代表公网可以访问你局域网内所有设备的 80 和 443 端口（包括光猫、路由器后台、智能家居、其他电脑等）。</p><p>正确做法：必须严格绑定目标服务器的 IPv6 地址（dst-address=服务器IPv6地址），或者通过 MAC 地址自动获取到的 IPv6 后缀。</p><h3 id=不添加旁路由ip规则版-mosdnssb>不添加旁路由ip规则版 (mosdns+sb)：</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>/ipv6 firewall filter</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ====================</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 入站链 (INPUT) - 保护路由器本体</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ====================</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=input comment=&#34;1. Accept established,related,untracked&#34; connection-state=established,related,untracked</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=input comment=&#34;2. Drop invalid&#34; connection-state=invalid</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=input comment=&#34;3. Accept ICMPv6 (Critical for IPv6)&#34; protocol=icmpv6</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=input comment=&#34;4. Allow DHCPv6 Client from WAN&#34; dst-port=546 in-interface=pppoe-out1 protocol=udp src-address=fe80::/10</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=input comment=&#34;5. Allow bridge1 (Internal Admin)&#34; in-interface=bridge1</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=input comment=&#34;6. Drop all not from bridge1&#34; in-interface=!bridge1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ====================</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 转发链 (FORWARD) - 穿过路由器 (外网&lt;-&gt;内网)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ====================</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1. 硬件加速 (处理正常不走代理的 IPv6 直连流量)</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=fasttrack-connection chain=forward comment=&#34;3. Fasttrack&#34; connection-state=established,related</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2. 基础状态放行</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;4. Accept forward established,related,untracked&#34; connection-state=established,related,untracked</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 3. 丢弃无效包 (防止旁路由非对称回程包被误杀)</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=forward comment=&#34;5. Drop invalid&#34; connection-state=invalid</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 4. 核心协议与内网放行</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;6. Accept Forward ICMPv6&#34; protocol=icmpv6</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;7. Allow bridge1 forward (Internal Outbound)&#34; in-interface=bridge1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># --- 暴露内网服务 (注意：替换为实际公网 IPv6 地址后再按需启用) ---</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;8. Allow NPM (HTTP/HTTPS)&#34; disabled=yes dst-address=240e::xxxx:xxxx dst-port=80,443 protocol=tcp</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;9. Allow Hysteria2/Proxy&#34; disabled=yes dst-address=240e::xxxx:xxxx dst-port=36789 protocol=udp</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;10. Allow Shadowsocks&#34; disabled=yes dst-address=240e::xxxx:xxxx dst-port=36789 protocol=tcp</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 5. 兜底拦截 (零信任原则)</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=forward comment=&#34;11. Drop all other forward (Protect LAN)&#34;</span>
</span></span></code></pre></div><h2 id=解释为什么添加路由ip后要删除屏蔽无效包即forward-链-drop-invalid>解释：为什么添加路由ip后要删除屏蔽无效包：即：<code>FORWARD 链 Drop invalid</code></h2><h3></h3><p>这是因为新加入的 <code>FORWARD</code> 链 <code>Drop invalid</code>（丢弃无效包）规则，与你的旁路由（10.20.20.6）网络架构产生了冲突，导致 RouterOS 误杀了部分正常的 UDP 游戏流量和 Telegram 的初始握手包。</p><hr><h3 id=科学依据>科学依据</h3><p>在你的网络拓扑中，客户端将网关指向了 10.20.20.6（旁路由）。
当访问不经过代理的直连网络（如国内流量、部分 P2P/UDP 游戏节点）时，往往会产生<strong>非对称路由</strong>：</p><ul><li><strong>去程</strong>：客户端 -> 旁路由 (10.20.20.6) -> 主路由 (ROS) -> 互联网。</li><li><strong>回程</strong>：互联网 -> 主路由 (ROS) -> 直接交回给客户端（因为都在 bridge1 同一网段）。</li></ul><p>这种一来一回路径不一致的数据流，会让 RouterOS 的连接跟踪引擎（Connection Tracker）抓不到完整的 TCP 三次握手或 UDP 双向通讯状态。因此，ROS 会将这些包标记为 <code>invalid</code>（无效状态）。
在你原来的旧配置中，因为缺少 <code>FORWARD</code> 链的拦截规则，这些包被默认放行了；而新配置补齐了这条严苛的拦截规则，反而导致 Telegram 连接卡顿（等待超时后回退其他协议）以及英雄联盟美服（依赖大量 UDP 报文）断连。</p><hr><h3 id=成功的步骤和方法>成功的步骤和方法</h3><p>解决办法非常简单，只需<strong>禁用或删除转发链中的无效包拦截规则</strong>，将这部分容错空间还给旁路由网络。</p><p>请在 RouterOS 终端中直接复制执行以下两行代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># 1. 停用 IPv4 转发链中的无效包拦截
</span></span><span style=display:flex><span>/ip firewall filter disable [find chain=forward connection-state=invalid]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 2. 停用 IPv6 转发链中的无效包拦截
</span></span><span style=display:flex><span>/ipv6 firewall filter disable [find chain=forward connection-state=invalid]
</span></span></code></pre></div><p>或者直接删除：
为了保持配置的整洁，建议直接将这两条已经禁用的无用规则彻底删除。请在终端执行以下命令：</p><p>代码段</p><h1 id=彻底移除已被停用的无效包拦截规则>彻底移除已被停用的无效包拦截规则</h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>/ip firewall filter remove [find chain=forward connection-state=invalid disabled=yes]
</span></span><span style=display:flex><span>/ipv6 firewall filter remove [find chain=forward connection-state=invalid disabled=yes]
</span></span></code></pre></div><p>执行完毕后，所有 <code>invalid</code> 状态的数据包会直接跳过该规则，落入后面的 <code>Allow LAN forward</code> 被正常放行。你可以立即重新打开 Telegram 和英雄联盟美服测试，网络应该会瞬间恢复如初，你的网络既能享受全速的 Fasttrack 硬件加速，又能完美兼容 10.20.20.6 的透明代理分流，同时保持着极高的企业级安全防御标准。</p><h2 id=结束>结束！</h2><h2 id=如创建了interface-list防火墙的配置方案><code>如创建了interface list，防火墙的配置方案：</code></h2><h3 id=1-创建列表名称>1. 创建列表名称</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>/interface list
</span></span><span style=display:flex><span>add name=WAN
</span></span><span style=display:flex><span>add name=LAN
</span></span></code></pre></div><h3 id=2-将-pppoe-out1-加入-wan-列表>2. 将 pppoe-out1 加入 WAN 列表</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>/interface list member
</span></span><span style=display:flex><span>add interface=pppoe-out1 list=WAN
</span></span></code></pre></div><h3 id=3-将-bridge1-加入-lan-列表>3. 将 bridge1 加入 LAN 列表</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>add interface=bridge1 list=LAN
</span></span></code></pre></div><h2 id=带添加旁路由ip规则版-mosdnssb-1>带添加旁路由ip规则版 (mosdns+sb)：</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># ==========================================</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 第一部分：IPv4 防火墙规则 (已适配 Interface List)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ==========================================</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>/ip firewall filter</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># --- 入站链 (INPUT) - 保护路由器本体 ---</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=input comment=&#34;1. Accept established,related,untracked&#34; connection-state=established,related,untracked</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=input comment=&#34;2. Drop invalid&#34; connection-state=invalid</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=input comment=&#34;3. Accept LAN (Internal Admin)&#34; in-interface-list=LAN</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 防爆破逻辑</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=input comment=&#34;4. Drop Bruteforce IPs&#34; dst-port=3981,2222 protocol=tcp src-address-list=bruteforce_blacklist</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=input comment=&#34;5. Accept limited connections&#34; connection-limit=10,32 dst-port=3981,2222 protocol=tcp</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=add-src-to-address-list address-list=bruteforce_blacklist address-list-timeout=3d chain=input comment=&#34;6. Add to Bruteforce List&#34; dst-port=3981,2222 protocol=tcp</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=input comment=&#34;7. Drop excess packets&#34; dst-port=3981,2222 protocol=tcp</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># WAN口丢弃兜底</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=input comment=&#34;8. Drop ICMP from WAN&#34; in-interface-list=WAN protocol=icmp</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=input comment=&#34;9. Drop all other input from WAN&#34; in-interface-list=WAN</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># --- 转发链 (FORWARD) - 穿过路由器 ---</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1. 旁路由豁免</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;1. Bypass Fasttrack &amp; Tracking: sing-box out&#34; src-address=10.20.20.6</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;2. Bypass Fasttrack &amp; Tracking: sing-box in&#34; dst-address=10.20.20.6</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2. 硬件加速</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=fasttrack-connection chain=forward comment=&#34;3. Fasttrack&#34; connection-state=established,related</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 3. 基础状态放行与丢弃</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;4. Accept established,related,untracked&#34; connection-state=established,related,untracked</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 4. 内网正常转发与端口映射放行</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;6. Allow LAN forward (Internal Outbound)&#34; in-interface-list=LAN</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;7. Allow DSTNAT (Port Forwarding)&#34; connection-nat-state=dstnat in-interface-list=WAN</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 5. 全局兜底拦截</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=forward comment=&#34;8. Drop all other forward&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ==========================================</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 第二部分：IPv6 防火墙规则 (已适配 Interface List)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ==========================================</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>/ipv6 firewall filter</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># --- 入站链 (INPUT) - 保护路由器本体 ---</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=input comment=&#34;1. Accept established,related,untracked&#34; connection-state=established,related,untracked</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=input comment=&#34;2. Drop invalid&#34; connection-state=invalid</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=input comment=&#34;3. Accept ICMPv6 (Critical for IPv6)&#34; protocol=icmpv6</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=input comment=&#34;4. Allow DHCPv6 Client from WAN&#34; dst-port=546 in-interface-list=WAN protocol=udp src-address=fe80::/10</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=input comment=&#34;5. Allow LAN (Internal Admin)&#34; in-interface-list=LAN</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=input comment=&#34;6. Drop all not from LAN&#34; in-interface-list=!LAN</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># --- 转发链 (FORWARD) - 穿过路由器 ---</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1. 旁路由豁免</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;1. Bypass Fasttrack &amp; Tracking: sing-box out&#34; src-address=fd88::6666</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;2. Bypass Fasttrack &amp; Tracking: sing-box in&#34; dst-address=fd88::6666</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2. 硬件加速</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=fasttrack-connection chain=forward comment=&#34;3. Fasttrack&#34; connection-state=established,related</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 3. 基础状态放行</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;4. Accept forward established,related,untracked&#34; connection-state=established,related,untracked</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 4. 核心协议与内网放行</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;6. Accept Forward ICMPv6&#34; protocol=icmpv6</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;7. Allow LAN forward (Internal Outbound)&#34; in-interface-list=LAN</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 5. 暴露内网服务 (替换为实际公网 IPv6 地址后再按需启用)</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;8. Allow NPM (HTTP/HTTPS)&#34; disabled=yes dst-address=240e::xxxx:xxxx dst-port=80,443 protocol=tcp</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;9. Allow Hysteria2/Proxy&#34; disabled=yes dst-address=240e::xxxx:xxxx dst-port=36789 protocol=udp</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;10. Allow Shadowsocks&#34; disabled=yes dst-address=240e::xxxx:xxxx dst-port=36789 protocol=tcp</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 6. 兜底拦截</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=forward comment=&#34;11. Drop all other forward (Protect LAN)&#34;</span>
</span></span></code></pre></div><h2 id=不添加旁路由ip规则版-mosdnssb-1>不添加旁路由ip规则版 (mosdns+sb):</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># ==========================================</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 第一部分：IPv4 防火墙规则 (已适配 Interface List)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ==========================================</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>/ip firewall filter</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># --- 入站链 (INPUT) - 保护路由器本体 ---</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=input comment=&#34;1. Accept established,related,untracked&#34; connection-state=established,related,untracked</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=input comment=&#34;2. Drop invalid&#34; connection-state=invalid</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=input comment=&#34;3. Accept LAN (Internal Admin)&#34; in-interface-list=LAN</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 防爆破逻辑</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=input comment=&#34;4. Drop Bruteforce IPs&#34; dst-port=3981,2222 protocol=tcp src-address-list=bruteforce_blacklist</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=input comment=&#34;5. Accept limited connections&#34; connection-limit=10,32 dst-port=3981,2222 protocol=tcp</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=add-src-to-address-list address-list=bruteforce_blacklist address-list-timeout=3d chain=input comment=&#34;6. Add to Bruteforce List&#34; dst-port=3981,2222 protocol=tcp</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=input comment=&#34;7. Drop excess packets&#34; dst-port=3981,2222 protocol=tcp</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># WAN口丢弃兜底</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=input comment=&#34;8. Drop ICMP from WAN&#34; in-interface-list=WAN protocol=icmp</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=input comment=&#34;9. Drop all other input from WAN&#34; in-interface-list=WAN</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># --- 转发链 (FORWARD) - 穿过路由器 ---</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1. 硬件加速</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=fasttrack-connection chain=forward comment=&#34;3. Fasttrack&#34; connection-state=established,related</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2. 基础状态放行与丢弃</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;4. Accept established,related,untracked&#34; connection-state=established,related,untracked</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=forward comment=&#34;5. Drop invalid&#34; connection-state=invalid</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 3. 内网正常转发与端口映射放行</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;6. Allow LAN forward (Internal Outbound)&#34; in-interface-list=LAN</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;7. Allow DSTNAT (Port Forwarding)&#34; connection-nat-state=dstnat in-interface-list=WAN</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 4. 全局兜底拦截</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=forward comment=&#34;8. Drop all other forward&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ==========================================</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 第二部分：IPv6 防火墙规则 (已适配 Interface List)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ==========================================</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>/ipv6 firewall filter</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># --- 入站链 (INPUT) - 保护路由器本体 ---</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=input comment=&#34;1. Accept established,related,untracked&#34; connection-state=established,related,untracked</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=input comment=&#34;2. Drop invalid&#34; connection-state=invalid</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=input comment=&#34;3. Accept ICMPv6 (Critical for IPv6)&#34; protocol=icmpv6</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=input comment=&#34;4. Allow DHCPv6 Client from WAN&#34; dst-port=546 in-interface-list=WAN protocol=udp src-address=fe80::/10</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=input comment=&#34;5. Allow LAN (Internal Admin)&#34; in-interface-list=LAN</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=input comment=&#34;6. Drop all not from LAN&#34; in-interface-list=!LAN</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># --- 转发链 (FORWARD) - 穿过路由器 ---</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1. 硬件加速</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=fasttrack-connection chain=forward comment=&#34;3. Fasttrack&#34; connection-state=established,related</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2. 基础状态放行与丢弃</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;4. Accept forward established,related,untracked&#34; connection-state=established,related,untracked</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=forward comment=&#34;5. Drop invalid&#34; connection-state=invalid</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 3. 核心协议与内网放行</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;6. Accept Forward ICMPv6&#34; protocol=icmpv6</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;7. Allow LAN forward (Internal Outbound)&#34; in-interface-list=LAN</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 4. 暴露内网服务 (替换为实际公网 IPv6 地址后再按需启用)</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;8. Allow NPM (HTTP/HTTPS)&#34; disabled=yes dst-address=240e::xxxx:xxxx dst-port=80,443 protocol=tcp</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;9. Allow Hysteria2/Proxy&#34; disabled=yes dst-address=240e::xxxx:xxxx dst-port=36789 protocol=udp</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=accept chain=forward comment=&#34;10. Allow Shadowsocks&#34; disabled=yes dst-address=240e::xxxx:xxxx dst-port=36789 protocol=tcp</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 5. 兜底拦截</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=drop chain=forward comment=&#34;11. Drop all other forward (Protect LAN)&#34;</span>
</span></span></code></pre></div><h2 id=ipv6的nd照着操作即可>IPV6的ND照着操作即可</h2><p><img src=assets/1.png alt=1></p><div id=utterances-comments><script src=https://utteranc.es/client.js repo=hanigege/blog-comments issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div><footer class=content__footer></footer></section><section class=page__aside><div class=aside__about><div class=aside__about><span class=about__logo role=img>🍚</span>&nbsp;<h1 class=about__title>root</h1><p class=about__description>個人自留地，如果能幫到你，我也會很高興。</p></div><ul class=aside__social-links><li><a href=mailto:purodn@gmail.com rel=me aria-label=Email title=Email><i class="fa-solid fa-envelope" aria-hidden=true></i></a>&nbsp;</li></ul></div><hr><div class=aside__content><p>2026-02-27</p><hr>On this page:<nav id=TableOfContents><ol><li><a href=#内网的dst-nat要加外网接口如pppoe-out1>内网的dst-nat要加外网接口如pppoe-out1</a></li><li><a href=#1-为什么需要回流>1. 为什么需要回流？</a></li><li><a href=#2-完整的-ros-nat-脚本包含-web-回流>2. 完整的 ROS NAT 脚本（包含 Web 回流）</a><ol><li></li></ol></li><li><a href=#3-操作建议使用地址列表简化回流>3. 操作建议：使用“地址列表”简化回流</a><ol><li><a href=#在-ip---firewall---nat-中添加这一条确保它在所有-dst-nat-规则之后但在基础-masquerade-规则之前或者紧随其后>在 IP -> Firewall -> NAT 中添加这一条（确保它在所有 dst-nat 规则之后，但在基础 masquerade 规则之前，或者紧随其后）：</a></li></ol></li><li><a href=#4-验证-web-服务>4. 验证 Web 服务</a></li><li><a href=#5-配套的防火墙规则也是我自用的>5. 配套的防火墙规则，也是我自用的</a></li><li><a href=#ipv4防火墙配置>ipv4防火墙配置</a></li><li><a href=#带添加旁路由ip规则版-mosdnssb>带添加旁路由ip规则版 (mosdns+sb):</a><ol><li><a href=#转发链-forward特别说明>转发链 (FORWARD)特别说明：</a></li></ol></li><li><a href=#不添加旁路由ip规则版>不添加旁路由ip规则版：</a><ol><li><a href=#转发链-forward特别说明-1>转发链 (FORWARD)特别说明：</a></li></ol></li><li><a href=#ipv6防火墙配置>ipv6防火墙配置</a></li><li><a href=#添加旁路由ip规则版-mosdnssb>添加旁路由ip规则版 (mosdns+sb)</a><ol><li><a href=#不添加旁路由ip规则版-mosdnssb>不添加旁路由ip规则版 (mosdns+sb)：</a></li></ol></li><li><a href=#解释为什么添加路由ip后要删除屏蔽无效包即forward-链-drop-invalid>解释：为什么添加路由ip后要删除屏蔽无效包：即：<code>FORWARD 链 Drop invalid</code></a><ol><li></li><li><a href=#科学依据>科学依据</a></li><li><a href=#成功的步骤和方法>成功的步骤和方法</a></li></ol></li></ol><ol><li><a href=#结束>结束！</a></li><li><a href=#如创建了interface-list防火墙的配置方案><code>如创建了interface list，防火墙的配置方案：</code></a><ol><li><a href=#1-创建列表名称>1. 创建列表名称</a></li><li><a href=#2-将-pppoe-out1-加入-wan-列表>2. 将 pppoe-out1 加入 WAN 列表</a></li><li><a href=#3-将-bridge1-加入-lan-列表>3. 将 bridge1 加入 LAN 列表</a></li></ol></li><li><a href=#带添加旁路由ip规则版-mosdnssb-1>带添加旁路由ip规则版 (mosdns+sb)：</a></li><li><a href=#不添加旁路由ip规则版-mosdnssb-1>不添加旁路由ip规则版 (mosdns+sb):</a></li><li><a href=#ipv6的nd照着操作即可>IPV6的ND照着操作即可</a></li></ol></nav></div></section><footer class=page__footer><p class=copyright>© <strong>felix</strong>.</p><p class=advertisement>Powered by <a>bash&sh</a>.</p></footer></div></body></html>