<!doctype html><html lang=zh><head><title>è‡ªç”¨ROSçš„MANGLEå°åŒ…è§„åˆ™ &ndash; bash</title><meta name=description content="å€‹äººè‡ªç•™åœ°ï¼Œå¦‚æœèƒ½å¹«åˆ°ä½ ï¼Œæˆ‘ä¹Ÿæœƒå¾ˆé«˜èˆˆã€‚"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=UTF-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.4/css/academicons.min.css integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://hanigege.github.io/css/palettes/base16-dark.css><link rel=stylesheet href=https://hanigege.github.io/css/risotto.css><link rel=stylesheet href=https://hanigege.github.io/css/custom.css><script src=https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js></script><style>.page__aside hr,.aside__content hr{display:none!important}.aside__content p{margin-bottom:.5rem!important}pre{position:relative;padding-top:40px!important;background-color:#1e1e1e!important;border:1px solid #333!important;border-radius:10px!important;box-shadow:0 4px 15px rgba(0,0,0,.4);overflow-x:auto!important;overflow-y:hidden!important;margin:1.5em 0}pre::-webkit-scrollbar{height:8px}pre::-webkit-scrollbar-thumb{background:#4a4a4a;border-radius:4px}pre::-webkit-scrollbar-track{background:0 0}code{font-family:jetbrains mono,fira code,Menlo,monospace!important;font-size:.92em!important;line-height:1.6!important;color:#d4d4d4!important;background:0 0!important;white-space:pre!important}.copy-code-button{position:absolute;top:10px;right:12px;padding:5px 12px;background:rgba(255,255,255,8%);color:#aaa;border:1px solid rgba(255,255,255,.15);border-radius:6px;backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);cursor:pointer;font-size:11px;font-weight:500;z-index:100;transition:all .25s ease}.copy-code-button:hover{background:rgba(102,217,239,.2);color:#66d9ef;border-color:#66d9ef;transform:translateY(-1px)}.copy-code-button:active{transform:translateY(0)}p img{cursor:zoom-in;transition:opacity .3s;border-radius:4px;max-width:100%}p img:hover{opacity:.9}.medium-zoom-overlay{z-index:999998!important}.medium-zoom-image--opened{z-index:999999!important}</style><script>document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll("pre").forEach(e=>{if(e.querySelector(".copy-code-button"))return;const t=document.createElement("button");t.className="copy-code-button",t.type="button",t.innerText="Copy",t.addEventListener("click",()=>{const n=e.querySelector("code"),s=n?n.innerText:e.innerText;navigator.clipboard.writeText(s).then(()=>{t.innerText="Copied!",t.style.background="rgba(166, 226, 46, 0.2)",t.style.color="#a6e22e",setTimeout(()=>{t.innerText="Copy",t.style.background="",t.style.color=""},2e3)})}),e.appendChild(t)});const e=document.querySelectorAll("p img");e.length>0&&mediumZoom(e,{margin:24,background:"#1e1e1ecf",scrollOffset:40})})</script></head><body><div class=page><header class=page__header><nav class="page__nav main-nav"><link rel=stylesheet href=/css/custom.css><ul><li class=nomarker><h1 class=page__logo><a href=https://hanigege.github.io/ class=page__logo-inner>bash</a></h1></li><li class=main-nav__item><a class=nav-main-item href=https://hanigege.github.io/categories/freebsd/ title>FreeBSD</a></li><li class=main-nav__item><a class=nav-main-item href=https://hanigege.github.io/categories/linux/ title>Linux</a></li><li class=main-nav__item><a class=nav-main-item href=https://hanigege.github.io/categories/routers/ title>Routers</a></li><li class=main-nav__item><a class=nav-main-item href=https://hanigege.github.io/categories/other/ title>Other</a></li><li class=main-nav__item><a class=nav-main-item href=https://hanigege.github.io/about/ title>About</a></li></ul></nav></header><section class=page__body><header class=content__header><h1>è‡ªç”¨ROSçš„MANGLEå°åŒ…è§„åˆ™</h1></header><div class=content__body><h2 id=ä¸ºäº†è®©ç½‘ç»œä½å»¶è¿Ÿå°åŒ…ä¼˜å…ˆçœŸæ­£ç”Ÿæ•ˆç§‘å­¦çš„åšæ³•æ˜¯ç¦ç”¨-fasttrack>ä¸ºäº†è®©ç½‘ç»œä½å»¶è¿Ÿã€å°åŒ…ä¼˜å…ˆçœŸæ­£ç”Ÿæ•ˆï¼Œç§‘å­¦çš„åšæ³•æ˜¯ï¼š<code>ç¦ç”¨ Fasttrackã€‚</code></h2><p>æ‰§è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼Œæ‰¾åˆ°å¹¶ç¦ç”¨ Fasttrack è§„åˆ™ï¼š</p><p>ä»£ç æ®µ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>/ip firewall filter</span>
</span></span><span style=display:flex><span><span style=color:#75715e># æŸ¥æ‰¾å¸¦æœ‰ fasttrack-connection åŠ¨ä½œçš„è§„åˆ™å¹¶ç¦ç”¨å®ƒ</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>disable [find action=fasttrack-connection]</span>
</span></span></code></pre></div><p>æ³¨æ„ï¼šç¦ç”¨åï¼Œæ‰€æœ‰æµé‡å°†äº¤ç”± CPU è¿›è¡Œ Mangle æ ‡è®°å’Œ Queue æ ‘æ’é˜Ÿã€‚ä½ çš„å°åŒ…ä¼˜å…ˆå’Œé™é€Ÿæœºåˆ¶å°†ç«‹åˆ» 100% ç”Ÿæ•ˆã€‚</p><h2 id=ä¾‹å¤–ç½‘ä¸‹è¡Œæ˜¯300mä¸Šè¡Œæ˜¯30mçš„å¸¦å®½>ä¾‹ï¼šå¤–ç½‘ä¸‹è¡Œæ˜¯300mï¼Œä¸Šè¡Œæ˜¯30mçš„å¸¦å®½</h2><p>ä¸‹è¡Œé˜Ÿåˆ—çš„æŒ‚è½½æ¥å£ç²¾å‡†æ›¿æ¢ä¸º bridge1ï¼Œä¸Šè¡Œæ¥å£ä¿æŒ pppoe-out1</p><p>æˆåŠŸçš„æ­¥éª¤ä¸ç§‘å­¦è®¡ç®—
é¢„ç•™ç¼“å†²é¿å…å…‰çŒ«æ’é˜Ÿï¼š å¿…é¡»æ‰£é™¤è¿è¥å•†æ ‡ç§°å¸¦å®½çš„ 5% åˆ° 10%ï¼Œå°†æ’é˜Ÿæœºåˆ¶å¼ºè¡Œæ‹‰å›åˆ° RouterOS æœ¬åœ°å¤„ç†ï¼Œä»¥å½»åº•æ¶ˆé™¤ç¼“å†²è†¨èƒ€ï¼ˆBufferbloatï¼‰å¸¦æ¥çš„é«˜å»¶è¿Ÿã€‚</p><p><code>ä¸Šè¡Œä¸¥æ ¼é˜ˆå€¼ï¼š 30M Ã— 0.95 = 28M</code></p><p><code>ä¸‹è¡Œä¸¥æ ¼é˜ˆå€¼ï¼š 300M Ã— 0.95 = 285M</code></p><p>é‡æ„æŒ‚è½½ç‚¹ï¼š å°†ä¸Šè¡Œé˜Ÿåˆ—æŒ‚è½½åœ¨æ‹¨å·æ¥å£ï¼Œä¸‹è¡Œé˜Ÿåˆ—æŒ‚è½½åœ¨å†…ç½‘æ¥å£ã€‚Mangle æ ‡è®°åªéœ€åœ¨ prerouting å’Œ postrouting æŠ“å–ä¸€æ¬¡ï¼Œå³å¯è¢«ä¸Šä¸‹è¡Œé˜Ÿåˆ—åŒæ—¶è°ƒç”¨ã€‚</p><h2 id=1ä»£ç å¯¼å…¥çš„æ–¹æ³•>1ã€ä»£ç å¯¼å…¥çš„æ–¹æ³•</h2><p>å¯¼å…¥ä»£ç ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>/ip firewall mangle</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1. ä¼˜å…ˆ DNS</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=mark-packet chain=prerouting protocol=udp dst-port=53 new-packet-mark=dns passthrough=no</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=mark-packet chain=prerouting protocol=tcp dst-port=53 new-packet-mark=dns passthrough=no</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2. ä¼˜å…ˆ ICMP</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=mark-packet chain=prerouting protocol=icmp new-packet-mark=small-packet passthrough=no</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 3. æ ¹æ®åŒ…å¤§å°æ ‡è®°ä¸­å°åŒ… (è¦†ç›– TCP ACK å’Œæ¸¸æˆæ•°æ®)</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=mark-packet chain=prerouting packet-size=0-128 new-packet-mark=small-packet passthrough=no</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=mark-packet chain=prerouting packet-size=129-512 new-packet-mark=medium-packet passthrough=no</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 4. å‰©ä½™å¤§åŒ…å…œåº• (ä¸‹è½½ã€è§†é¢‘ç­‰)</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=mark-packet chain=prerouting new-packet-mark=large-packet passthrough=no</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 5. MSS é’³åˆ¶</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add action=change-mss chain=forward protocol=tcp tcp-flags=syn new-mss=clamp-to-pmtu passthrough=yes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>/queue tree</span>
</span></span><span style=display:flex><span><span style=color:#75715e># æ¸…ç†æ—§é˜Ÿåˆ—</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>remove [find]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ================= ä¸Šè¡Œé˜Ÿåˆ— (Upload) =================</span>
</span></span><span style=display:flex><span><span style=color:#75715e># æŒ‚è½½åˆ°å¤–ç½‘æ‹¨å·æ¥å£ pppoe-out1ï¼Œæ€»å¸¦å®½ 28M</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add name=Upload-Total parent=pppoe-out1 max-limit=28M</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add name=U1-Dns parent=Upload-Total packet-mark=dns priority=1 queue=default-small limit-at=2M max-limit=28M</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add name=U2-Small parent=Upload-Total packet-mark=small-packet priority=2 queue=default-small limit-at=5M max-limit=28M</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add name=U3-Medium parent=Upload-Total packet-mark=medium-packet priority=3 queue=default-small limit-at=10M max-limit=28M</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add name=U4-Large parent=Upload-Total packet-mark=large-packet priority=8 queue=default-small limit-at=11M max-limit=28M</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ================= ä¸‹è¡Œé˜Ÿåˆ— (Download) =================</span>
</span></span><span style=display:flex><span><span style=color:#75715e># æŒ‚è½½åˆ°å†…ç½‘æ¡¥æ¥æ¥å£ bridge1ï¼Œæ€»å¸¦å®½ 285M</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add name=Download-Total parent=bridge1 max-limit=285M</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add name=D1-Dns parent=Download-Total packet-mark=dns priority=1 queue=default-small limit-at=5M max-limit=285M</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add name=D2-Small parent=Download-Total packet-mark=small-packet priority=2 queue=default-small limit-at=20M max-limit=285M</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add name=D3-Medium parent=Download-Total packet-mark=medium-packet priority=3 queue=default-small limit-at=50M max-limit=285M</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add name=D4-Large parent=Download-Total packet-mark=large-packet priority=8 queue=default-small limit-at=210M max-limit=285M</span>
</span></span></code></pre></div><p>è¦è®©ä»¥ä¸Š QoS è§„åˆ™çœŸæ­£ç”Ÿæ•ˆï¼Œå¿…é¡»å¤„ç†ï¼ˆç¦ç”¨ï¼‰é˜²ç«å¢™ä¸­çš„ Fasttrackï¼ˆç¡¬ä»¶åŠ é€Ÿï¼‰è§„åˆ™ï¼Œå¦åˆ™æ‰€æœ‰æ•°æ®åŒ…éƒ½ä¼šç›´æ¥ç»•è¿‡ Mangle å’Œ Queue æ ‘ã€‚</p><p>å®ƒä»¬å¯¹â€œå¿«â€çš„å®šä¹‰å®Œå…¨ç›¸åã€‚<strong>Fasttrack ä¿éšœçš„æ˜¯â€œæé™ååé‡â€ï¼ˆæµ‹é€Ÿæ•°å­—å¤§ï¼‰ï¼Œå°åŒ…ä¼˜å…ˆä¿éšœçš„æ˜¯â€œæä½å»¶è¿Ÿâ€ï¼ˆå“åº”å¿«ã€ä¸å¡é¡¿ï¼‰ã€‚</strong></p><h3 id=ç§‘å­¦äº‹å®ä¸ä¼˜åŠ£åŠ¿å¯¹æ¯”>ç§‘å­¦äº‹å®ä¸ä¼˜åŠ£åŠ¿å¯¹æ¯”</h3><p><strong>1. Fasttrackï¼ˆç¡¬ä»¶/åº•å±‚åŠ é€Ÿï¼‰â€”â€” è¿½æ±‚æé™å¸¦å®½</strong></p><ul><li><strong>ç§‘å­¦åŸç†ï¼š</strong> è®©å»ºç«‹å¥½è¿æ¥çš„æ•°æ®åŒ…å¼ºåˆ¶ç»•è¿‡é˜²ç«å¢™ Mangle å’Œ Queue é˜Ÿåˆ—ï¼Œç›´æ¥åœ¨åº•å±‚è½¬å‘ï¼Œæå¤§å‡è½» CPU è´Ÿæ‹…ã€‚</li><li><strong>æ•ˆæœï¼š</strong> æµ‹é€Ÿèƒ½è·‘æ»¡ç”šè‡³æº¢å‡ºä½ çš„ 300M å¸¦å®½ï¼Œè·¯ç”±å™¨ CPU å ç”¨ç‡æä½ã€‚</li><li><strong>è‡´å‘½ç¼ºé™·ï¼š</strong> å®Œå…¨ä¸§å¤±æ‹¥å¡æ§åˆ¶èƒ½åŠ›ã€‚ä¸€æ—¦å±€åŸŸç½‘å†…æœ‰è®¾å¤‡æ»¡é€Ÿä¸‹è½½æˆ–ä¸Šä¼ ï¼ˆç‰¹åˆ«æ˜¯ä½ åªæœ‰ 30M çš„ä¸Šè¡Œï¼‰ï¼Œæ•´ä¸ªç½‘ç»œä¼šå‘ç”Ÿä¸¥é‡çš„ç¼“å†²è†¨èƒ€ï¼ˆBufferbloatï¼‰ï¼Œå¯¼è‡´æ¸¸æˆç–¯ç‹‚è·³ Pingã€ç½‘é¡µè½¬åœˆæ‰“ä¸å¼€ã€‚</li></ul><p><strong>2. å°åŒ…ä¼˜å…ˆï¼ˆQoS Queue Treeï¼‰â€”â€” è¿½æ±‚æè‡´å“åº”</strong></p><ul><li><strong>ç§‘å­¦åŸç†ï¼š</strong> ä¸»åŠ¨ç‰ºç‰² 5%-10% çš„æé™å¸¦å®½ä½œä¸ºç¼“å†²ç©ºé—´ï¼Œåˆ©ç”¨ CPU ç®—åŠ›å¯¹æ‰€æœ‰æ•°æ®åŒ…è¿›è¡Œç²¾å‡†æ’é˜Ÿï¼Œå¼ºåˆ¶è®© DNSã€æ¸¸æˆå°åŒ…ã€ç½‘é¡µè¯·æ±‚â€œæ’é˜Ÿâ€å…ˆå‘ã€‚</li><li><strong>æ•ˆæœï¼š</strong> æ— è®ºå†…ç½‘è®¾å¤‡æ€ä¹ˆç–¯ç‹‚ä¸‹è½½æˆ–ä¸Šä¼ ï¼Œæ¸¸æˆå»¶è¿Ÿæ°¸è¿œä¿æŒåœ¨æœ€ä½æ°´å¹³ï¼Œç½‘é¡µå§‹ç»ˆç§’å¼€ï¼Œç½‘ç»œä½“éªŒä¸æ»‘ã€‚</li><li><strong>ä»£ä»·ï¼š</strong> æµ‹é€Ÿæ•°å­—æœ€é«˜åªèƒ½è¾¾åˆ°ä½ è®¾å®šçš„ 285M å’Œ 28Mï¼Œä¸”ç”±äºæ‰€æœ‰åŒ…éƒ½è¦ç»è¿‡ CPU è¿ç®—ï¼Œè·¯ç”±å™¨ CPU è´Ÿè½½ä¼šå‡é«˜ã€‚</li></ul><p><strong>ç¦ç”¨ Fasttrackï¼Œå…¨é¢å¯ç”¨å°åŒ…ä¼˜å…ˆ QoS</strong>ã€‚ç”¨æµ‹é€Ÿè½¯ä»¶ä¸Šå°‘è·‘ 15M çš„æ•°å­—ï¼Œæ¢å–å…¨å¤©å€™æ°¸è¿œä¸å¡é¡¿çš„é«˜è´¨é‡ç½‘ç»œä½“éªŒï¼Œè¿™æ‰æ˜¯çœŸæ­£çš„â€œç½‘é€Ÿå¿«â€ã€‚</p><h2 id=ä¾‹ä¸‹è¡Œæ˜¯350mpbs-ä¸‹è¡Œæ˜¯50mpbs>ä¾‹ï¼šä¸‹è¡Œæ˜¯350mpbs ä¸‹è¡Œæ˜¯50mpbs</h2><p>ç…§ä½ æœ€æ–°ç¡®è®¤çš„ç‰©ç†æé™ï¼ˆä¸‹è¡Œ 350Mbpsï¼Œä¸Šè¡Œ 50Mbpsï¼‰é‡æ–°è®¡ç®—é˜²æ‹¥å µé˜ˆå€¼ï¼Œç¡®ä¿é¢„ç•™ 5% çš„æ’é˜Ÿç¼“å†²ç©ºé—´ã€‚</p><p>ç§‘å­¦è®¡ç®—ä¸æ–°é˜ˆå€¼
ä¸Šè¡Œä¸¥æ ¼é˜ˆå€¼ï¼š 50M Ã— 0.95 = 47M</p><p>ä¸‹è¡Œä¸¥æ ¼é˜ˆå€¼ï¼š 350M Ã— 0.95 = 332M</p><p>æˆåŠŸçš„è°ƒæ•´æ­¥éª¤
è¯·ç›´æ¥åœ¨ ROS ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å®Œæ•´ä»£ç ï¼Œè¦†ç›–ä¹‹å‰çš„é˜Ÿåˆ—é…ç½®ï¼ˆMangle æ ‡è®°ä¿æŒä¸å˜ï¼‰</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>/queue tree</span>
</span></span><span style=display:flex><span><span style=color:#75715e># æ¸…ç†æ—§é˜Ÿåˆ—</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>remove [find]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ================= ä¸Šè¡Œé˜Ÿåˆ— (Upload: é€‚é… 50Mï¼Œå®è®¾ 47M) =================</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add name=Upload-Total parent=pppoe-out1 max-limit=47M</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add name=U1-Dns parent=Upload-Total packet-mark=dns priority=1 queue=default-small limit-at=3M max-limit=47M</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add name=U2-Small parent=Upload-Total packet-mark=small-packet priority=2 queue=default-small limit-at=8M max-limit=47M</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add name=U3-Medium parent=Upload-Total packet-mark=medium-packet priority=3 queue=default-small limit-at=15M max-limit=47M</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add name=U4-Large parent=Upload-Total packet-mark=large-packet priority=8 queue=default-small limit-at=21M max-limit=47M</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ================= ä¸‹è¡Œé˜Ÿåˆ— (Download: é€‚é… 350Mï¼Œå®è®¾ 332M) =================</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add name=Download-Total parent=bridge1 max-limit=332M</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add name=D1-Dns parent=Download-Total packet-mark=dns priority=1 queue=default-small limit-at=5M max-limit=332M</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add name=D2-Small parent=Download-Total packet-mark=small-packet priority=2 queue=default-small limit-at=30M max-limit=332M</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add name=D3-Medium parent=Download-Total packet-mark=medium-packet priority=3 queue=default-small limit-at=80M max-limit=332M</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>add name=D4-Large parent=Download-Total packet-mark=large-packet priority=8 queue=default-small limit-at=217M max-limit=332M</span>
</span></span></code></pre></div><h2 id=åˆ«å¿˜äº†å¯¼å…¥ipv6çš„mangleè§„åˆ™>åˆ«å¿˜äº†å¯¼å…¥ipv6çš„mangleè§„åˆ™</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>/ipv6 firewall mangle
</span></span><span style=display:flex><span># ä¼˜å…ˆ DNS (UDP/TCP 53)
</span></span><span style=display:flex><span>add action=mark-packet chain=prerouting protocol=udp dst-port=53 new-packet-mark=dns passthrough=no
</span></span><span style=display:flex><span>add action=mark-packet chain=prerouting protocol=tcp dst-port=53 new-packet-mark=dns passthrough=no
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># ä¼˜å…ˆ ICMPv6 (Pingï¼Œæ³¨æ„åè®®åä¸º icmpv6)
</span></span><span style=display:flex><span>add action=mark-packet chain=prerouting protocol=icmpv6 new-packet-mark=small-packet passthrough=no
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># æ ‡è®°æ‰€æœ‰å°åŒ…ä¸ä¸­åŒ…
</span></span><span style=display:flex><span>add action=mark-packet chain=prerouting packet-size=0-128 new-packet-mark=small-packet passthrough=no
</span></span><span style=display:flex><span>add action=mark-packet chain=prerouting packet-size=129-512 new-packet-mark=medium-packet passthrough=no
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># å‰©ä½™å¤§åŒ…å…œåº• (å½»åº•æ‹¦æˆª IPv6 æµ‹é€Ÿå’Œä¸‹è½½)
</span></span><span style=display:flex><span>add action=mark-packet chain=prerouting new-packet-mark=large-packet passthrough=no
</span></span></code></pre></div><h2 id=ä¼˜åŒ–å†…ç½‘sing-boxçš„æµé‡è§„åˆ™-å¯é€‰>ä¼˜åŒ–å†…ç½‘sing-boxçš„æµé‡è§„åˆ™ ï¼ˆå¯é€‰ï¼‰</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span><span style=color:#f92672>/</span>ip firewall mangle
</span></span><span style=display:flex><span><span style=color:#75715e># 1. æŠ“å– IPv4 sing-box å‘èµ·çš„æ‰€æœ‰åŒå‘è¿æ¥</span>
</span></span><span style=display:flex><span>add action<span style=color:#f92672>=</span>mark<span style=color:#f92672>-</span>connection chain<span style=color:#f92672>=</span>prerouting src<span style=color:#f92672>-</span>address<span style=color:#f92672>=</span><span style=color:#ae81ff>10.20</span><span style=color:#f92672>.</span><span style=color:#ae81ff>20.6</span> new<span style=color:#f92672>-</span>connection<span style=color:#f92672>-</span>mark<span style=color:#f92672>=</span>proxy<span style=color:#f92672>-</span>conn passthrough<span style=color:#f92672>=</span>yes place<span style=color:#f92672>-</span>before<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2. èµ‹äºˆä¸“å±æ•°æ®åŒ…æ ‡è®°ï¼Œå¹¶é˜»æ­¢å…¶è¿›å…¥åç»­çš„å¤§å°åŒ…åˆ†ç±»</span>
</span></span><span style=display:flex><span>add action<span style=color:#f92672>=</span>mark<span style=color:#f92672>-</span>packet chain<span style=color:#f92672>=</span>prerouting connection<span style=color:#f92672>-</span>mark<span style=color:#f92672>=</span>proxy<span style=color:#f92672>-</span>conn new<span style=color:#f92672>-</span>packet<span style=color:#f92672>-</span>mark<span style=color:#f92672>=</span>proxy<span style=color:#f92672>-</span>packet passthrough<span style=color:#f92672>=</span>no place<span style=color:#f92672>-</span>before<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>/</span>ipv6 firewall mangle
</span></span><span style=display:flex><span><span style=color:#75715e># 3. æŠ“å– IPv6 sing-box å‘èµ·çš„æ‰€æœ‰åŒå‘è¿æ¥</span>
</span></span><span style=display:flex><span>add action<span style=color:#f92672>=</span>mark<span style=color:#f92672>-</span>connection chain<span style=color:#f92672>=</span>prerouting src<span style=color:#f92672>-</span>address<span style=color:#f92672>=</span>fd88::<span style=color:#ae81ff>6666</span> new<span style=color:#f92672>-</span>connection<span style=color:#f92672>-</span>mark<span style=color:#f92672>=</span>proxy<span style=color:#f92672>-</span>conn passthrough<span style=color:#f92672>=</span>yes place<span style=color:#f92672>-</span>before<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 4. èµ‹äºˆä¸“å±æ•°æ®åŒ…æ ‡è®°</span>
</span></span><span style=display:flex><span>add action<span style=color:#f92672>=</span>mark<span style=color:#f92672>-</span>packet chain<span style=color:#f92672>=</span>prerouting connection<span style=color:#f92672>-</span>mark<span style=color:#f92672>=</span>proxy<span style=color:#f92672>-</span>conn new<span style=color:#f92672>-</span>packet<span style=color:#f92672>-</span>mark<span style=color:#f92672>=</span>proxy<span style=color:#f92672>-</span>packet passthrough<span style=color:#f92672>=</span>no place<span style=color:#f92672>-</span>before<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>/</span>queue tree
</span></span><span style=display:flex><span><span style=color:#75715e># 5. åœ¨ä¸Šè¡Œå’Œä¸‹è¡Œæ€»é˜Ÿåˆ—ä¸‹ï¼Œæ’å…¥ç‹¬ç«‹çš„ä»£ç†é«˜ä¼˜é˜Ÿåˆ— (Priority 2ï¼Œäº«å—ä¸æ™®é€šå°åŒ…åŒç­‰çš„ VIP æ’é˜Ÿç‰¹æƒ)</span>
</span></span><span style=display:flex><span>add name<span style=color:#f92672>=</span>U1<span style=color:#f92672>.</span><span style=color:#ae81ff>5</span><span style=color:#f92672>-</span>Proxy parent<span style=color:#f92672>=</span>Upload<span style=color:#f92672>-</span>Total packet<span style=color:#f92672>-</span>mark<span style=color:#f92672>=</span>proxy<span style=color:#f92672>-</span>packet priority<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> queue<span style=color:#f92672>=</span>default<span style=color:#f92672>-</span>small limit<span style=color:#f92672>-</span>at<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>M max<span style=color:#f92672>-</span>limit<span style=color:#f92672>=</span><span style=color:#ae81ff>47</span>M
</span></span><span style=display:flex><span>add name<span style=color:#f92672>=</span>D1<span style=color:#f92672>.</span><span style=color:#ae81ff>5</span><span style=color:#f92672>-</span>Proxy parent<span style=color:#f92672>=</span>Download<span style=color:#f92672>-</span>Total packet<span style=color:#f92672>-</span>mark<span style=color:#f92672>=</span>proxy<span style=color:#f92672>-</span>packet priority<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> queue<span style=color:#f92672>=</span>default<span style=color:#f92672>-</span>small limit<span style=color:#f92672>-</span>at<span style=color:#f92672>=</span><span style=color:#ae81ff>50</span>M max<span style=color:#f92672>-</span>limit<span style=color:#f92672>=</span><span style=color:#ae81ff>332</span>M
</span></span></code></pre></div><h2 id=éªŒè¯æ­¥éª¤>éªŒè¯æ­¥éª¤</h2><p>ä¸ºäº†è®©å…³é—­ Fasttrack çš„åŠ¨ä½œç«‹åˆ»ã€å½»åº•åœ°å¯¹å…¨å±€ç”Ÿæ•ˆï¼Œå¿…é¡»æš´åŠ›æ¸…ç©ºè·¯ç”±å™¨å†…å­˜ä¸­çš„è¿æ¥è¿½è¸ªè¡¨ï¼Œå¼ºåˆ¶æ‰€æœ‰è®¾å¤‡é‡æ–°æ¡æ‰‹ï¼Œè€è€å®å®å»æ’é˜Ÿã€‚</p><p>è¯·åœ¨ ROS ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># å¼ºåˆ¶æ¸…ç©ºæ‰€æœ‰ç°æœ‰è¿æ¥çŠ¶æ€ï¼ˆæ³¨æ„ï¼šæ‰§è¡Œç¬é—´å…¨å®¶ç½‘ç»œä¼šæ–­å¼€ 1-2 ç§’ï¼Œéšåè‡ªåŠ¨é‡è¿ï¼‰</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>/ip firewall connection remove [find]</span>
</span></span></code></pre></div><p>æ‰§è¡Œå®Œæ¯•åï¼Œè¯·ç«‹åˆ»å†è·‘ä¸€æ¬¡æµ‹é€Ÿã€‚<a href=https://speedtest.zju.edu.cn>æµ‹é€Ÿç½‘</a></p><p><img src=assets/22.png alt=22></p><h3 id=ç§‘å­¦æŒ‡æ ‡-è¿™æ¬¡å¦‚æœä¸Šè¡Œè¢«æ­»æ­»é’³åˆ¶åœ¨49mbpsä»¥å†…ä¸‹è¡Œå¡åœ¨-332m-å·¦å³å°±è¯æ˜-qos-çš„å¤§é—¨çœŸæ­£å…³ä¸Šäº†æ’é˜Ÿæœºåˆ¶å®Œç¾ç”Ÿæ•ˆ>ç§‘å­¦æŒ‡æ ‡ï¼š è¿™æ¬¡å¦‚æœä¸Šè¡Œè¢«æ­»æ­»é’³åˆ¶åœ¨49Mbpsä»¥å†…ï¼Œä¸‹è¡Œå¡åœ¨ 332M å·¦å³ï¼Œå°±è¯æ˜ QoS çš„å¤§é—¨çœŸæ­£å…³ä¸Šäº†ï¼Œæ’é˜Ÿæœºåˆ¶å®Œç¾ç”Ÿæ•ˆã€‚</h3><p>çªç ´é˜ˆå€¼çš„æ•°å­¦çœŸç›¸ï¼š ä½ çš„ä¸Šè¡Œæµ‹é€Ÿè·‘åˆ°äº† 48.57 Mbpsã€‚æˆ‘ä»¬è®¾å®šçš„é™é€Ÿæ˜¯ 47Mã€‚åœ¨ RouterOS çš„åº•å±‚å•ä½æ¢ç®—ä¸­ï¼Œå®ƒæ˜¯æŒ‰ 1024 è¿›ä½è®¡ç®—çš„ï¼š47M = 47 Ã— 1024 Ã— 1024 bps = 49,283,072 bpsã€‚å°†å®ƒæ¢ç®—æˆæµ‹é€Ÿç½‘ç«™å¸¸ç”¨çš„åè¿›åˆ¶ Mbpsï¼Œç†è®ºå€¼æ­£å¥½æ˜¯ 49.28 Mbpsã€‚è¿™è¯´æ˜ä¸ä»… QoS é˜Ÿåˆ—ç²¾å‡†è½åœ°ï¼Œè€Œä¸”ä½ ä¸€æ»´å¸¦å®½éƒ½æ²¡æœ‰æµªè´¹ï¼Œç²¾å‡†å¡åœ¨äº†ç‰©ç†æé™çš„æœ€å®Œç¾å¹³è¡¡ç‚¹ä¸Šã€‚</p><div id=utterances-comments><script src=https://utteranc.es/client.js repo=hanigege/blog-comments issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div><footer class=content__footer></footer></section><section class=page__aside><div class=aside__about><div class=aside__about><span class=about__logo role=img>ğŸš</span>&nbsp;<h1 class=about__title>root</h1><p class=about__description>å€‹äººè‡ªç•™åœ°ï¼Œå¦‚æœèƒ½å¹«åˆ°ä½ ï¼Œæˆ‘ä¹Ÿæœƒå¾ˆé«˜èˆˆã€‚</p></div><ul class=aside__social-links><li><a href=mailto:purodn@gmail.com rel=me aria-label=Email title=Email><i class="fa-solid fa-envelope" aria-hidden=true></i></a>&nbsp;</li></ul></div><hr><div class=aside__content><p>2025-05-11</p><hr>On this page:<nav id=TableOfContents><ol><li><a href=#ä¸ºäº†è®©ç½‘ç»œä½å»¶è¿Ÿå°åŒ…ä¼˜å…ˆçœŸæ­£ç”Ÿæ•ˆç§‘å­¦çš„åšæ³•æ˜¯ç¦ç”¨-fasttrack>ä¸ºäº†è®©ç½‘ç»œä½å»¶è¿Ÿã€å°åŒ…ä¼˜å…ˆçœŸæ­£ç”Ÿæ•ˆï¼Œç§‘å­¦çš„åšæ³•æ˜¯ï¼š<code>ç¦ç”¨ Fasttrackã€‚</code></a></li><li><a href=#ä¾‹å¤–ç½‘ä¸‹è¡Œæ˜¯300mä¸Šè¡Œæ˜¯30mçš„å¸¦å®½>ä¾‹ï¼šå¤–ç½‘ä¸‹è¡Œæ˜¯300mï¼Œä¸Šè¡Œæ˜¯30mçš„å¸¦å®½</a></li><li><a href=#1ä»£ç å¯¼å…¥çš„æ–¹æ³•>1ã€ä»£ç å¯¼å…¥çš„æ–¹æ³•</a><ol><li><a href=#ç§‘å­¦äº‹å®ä¸ä¼˜åŠ£åŠ¿å¯¹æ¯”>ç§‘å­¦äº‹å®ä¸ä¼˜åŠ£åŠ¿å¯¹æ¯”</a></li></ol></li><li><a href=#ä¾‹ä¸‹è¡Œæ˜¯350mpbs-ä¸‹è¡Œæ˜¯50mpbs>ä¾‹ï¼šä¸‹è¡Œæ˜¯350mpbs ä¸‹è¡Œæ˜¯50mpbs</a></li><li><a href=#åˆ«å¿˜äº†å¯¼å…¥ipv6çš„mangleè§„åˆ™>åˆ«å¿˜äº†å¯¼å…¥ipv6çš„mangleè§„åˆ™</a></li><li><a href=#ä¼˜åŒ–å†…ç½‘sing-boxçš„æµé‡è§„åˆ™-å¯é€‰>ä¼˜åŒ–å†…ç½‘sing-boxçš„æµé‡è§„åˆ™ ï¼ˆå¯é€‰ï¼‰</a></li><li><a href=#éªŒè¯æ­¥éª¤>éªŒè¯æ­¥éª¤</a><ol><li><a href=#ç§‘å­¦æŒ‡æ ‡-è¿™æ¬¡å¦‚æœä¸Šè¡Œè¢«æ­»æ­»é’³åˆ¶åœ¨49mbpsä»¥å†…ä¸‹è¡Œå¡åœ¨-332m-å·¦å³å°±è¯æ˜-qos-çš„å¤§é—¨çœŸæ­£å…³ä¸Šäº†æ’é˜Ÿæœºåˆ¶å®Œç¾ç”Ÿæ•ˆ>ç§‘å­¦æŒ‡æ ‡ï¼š è¿™æ¬¡å¦‚æœä¸Šè¡Œè¢«æ­»æ­»é’³åˆ¶åœ¨49Mbpsä»¥å†…ï¼Œä¸‹è¡Œå¡åœ¨ 332M å·¦å³ï¼Œå°±è¯æ˜ QoS çš„å¤§é—¨çœŸæ­£å…³ä¸Šäº†ï¼Œæ’é˜Ÿæœºåˆ¶å®Œç¾ç”Ÿæ•ˆã€‚</a></li></ol></li></ol></nav></div></section><footer class=page__footer><p class=copyright>Â© <strong>mana</strong>.</p><p class=advertisement>Powered by <a>bash&sh</a>.</p></footer></div></body></html>